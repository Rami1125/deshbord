<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מרכז בקרה לוגיסטי חכם - גרסה משודרגת</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f2f5; }
        .card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #pano { width: 100%; height: 250px; border-radius: 8px; background-color: #e5e7eb; margin-top: 1rem; }
        .route-option.selected { border-color: #2563eb; background-color: #eff6ff; }
        .price-breakdown { transition: all 0.3s ease; }
        .price-breakdown.hidden { opacity: 0; height: 0; overflow: hidden; }
        .price-breakdown:not(.hidden) { opacity: 1; height: auto; }
        .glow { box-shadow: 0 0 10px rgba(37, 99, 235, 0.3); }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 max-w-7xl">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900 flex items-center gap-2">
                <i class="fa-solid fa-truck-fast text-blue-600"></i>
                לוח בקרה לוגיסטי מתקדם
            </h1>
            <div class="flex items-center gap-3">
                <div id="current-time" class="text-sm bg-blue-50 text-blue-700 px-3 py-1 rounded-full"></div>
                <div id="connection-status" class="flex items-center gap-1 text-sm">
                    <i class="fa-solid fa-circle text-green-500"></i>
                    <span>מחובר</span>
                </div>
            </div>
        </header>
        
        <div id="error-banner" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert"></div>
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <!-- פאנל הזמנה ומחירון -->
            <main class="lg:col-span-4 space-y-6">
                <div class="card p-6 space-y-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-file-invoice text-blue-500"></i>
                        פרטי הזמנה
                    </h2>
                    
                    <div>
                        <label for="customer" class="text-sm font-medium text-gray-600">לקוח</label>
                        <input type="text" id="customer" name="customer" list="customers-list" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <datalist id="customers-list"></datalist>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="date" class="text-sm font-medium text-gray-600">תאריך</label>
                            <input type="date" id="date" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="time" class="text-sm font-medium text-gray-600">שעה</label>
                            <input type="time" id="time" name="time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <label for="city" class="text-sm font-medium text-gray-600">עיר</label>
                        <select id="city" name="city" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option>טוען ערים...</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label for="street" class="text-sm font-medium text-gray-600">רחוב</label>
                            <input type="text" id="street" name="street" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="street_number" class="text-sm font-medium text-gray-600">מספר</label>
                            <input type="text" id="street_number" name="street_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="delivery_type" class="text-sm font-medium text-gray-600">סוג הובלה</label>
                            <select id="delivery_type" name="delivery_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" disabled>
                                <option>טוען...</option>
                            </select>
                        </div>
                        <div>
                            <label for="warehouse" class="text-sm font-medium text-gray-600">מחסן מוצא</label>
                            <select id="warehouse" name="warehouse" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" disabled>
                                <option>טוען...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="notes" class="text-sm font-medium text-gray-600">הערות</label>
                        <textarea id="notes" name="notes" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <button id="btn-save-order" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 glow">
                        <i class="fa-solid fa-floppy-disk"></i> שמור הזמנה
                        <div id="save-spinner" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
                    </button>
                </div>
                
                <!-- מחשבון מחירים -->
                <div id="price-calculator" class="card p-6 space-y-4 hidden">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-calculator text-green-500"></i>
                        מחשבון מחירים
                    </h2>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">מחיר בסיס:</span>
                            <span id="base-price">₪0</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">תוספת מרחק:</span>
                            <span id="distance-surcharge">₪0</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">תוספת סוג הובלה:</span>
                            <span id="delivery-type-surcharge">₪0</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">תוספת עומס תנועה:</span>
                            <span id="traffic-surcharge">₪0</span>
                        </div>
                        <hr class="my-2">
                        <div class="flex justify-between items-center text-lg font-bold">
                            <span>סה"כ לתשלום:</span>
                            <span id="total-price" class="text-blue-600">₪0</span>
                        </div>
                    </div>
                    
                    <button id="btn-toggle-breakdown" class="w-full text-blue-600 font-medium py-2 rounded-lg hover:bg-blue-50 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-receipt"></i> הצג פירוט מחיר
                        <i id="breakdown-arrow" class="fa-solid fa-chevron-down text-xs"></i>
                    </button>
                    
                    <div id="price-breakdown" class="price-breakdown hidden bg-blue-50 p-4 rounded-lg text-sm">
                        <h3 class="font-semibold mb-2">פירוט חישוב מחיר:</h3>
                        <div class="space-y-1">
                            <div class="flex justify-between">
                                <span>מחיר בסיסי:</span>
                                <span id="breakdown-base">₪50</span>
                            </div>
                            <div class="flex justify-between">
                                <span>עלות לק"מ:</span>
                                <span id="breakdown-per-km">₪2.5</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ק"מ במסלול:</span>
                                <span id="breakdown-km">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>מכפיל סוג הובלה:</span>
                                <span id="breakdown-type-multiplier">1.0x</span>
                            </div>
                            <div class="flex justify-between">
                                <span>מכפיל עומס תנועה:</span>
                                <span id="breakdown-traffic-multiplier">1.0x</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- מפה ותצוגת רחוב -->
            <section class="lg:col-span-8 space-y-6">
                <div class="card p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-semibold flex items-center gap-2">
                            <i class="fa-solid fa-map-location-dot text-green-500"></i>
                            תכנון מסלול
                        </h2>
                        <div class="flex gap-2">
                            <button id="btn-refresh-routes" class="text-blue-600 hover:text-blue-800 transition">
                                <i class="fa-solid fa-rotate"></i> רענן מסלולים
                            </button>
                        </div>
                    </div>
                    <div id="map" class="w-full h-[400px] rounded-lg"></div>
                    <div id="pano"></div>
                </div>
                
                <!-- סטטיסטיקות מסלול -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="card p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600" id="route-distance">0 ק"מ</div>
                        <div class="text-sm text-gray-500">מרחק משוער</div>
                    </div>
                    <div class="card p-4 text-center">
                        <div class="text-2xl font-bold text-green-600" id="route-duration">0 דק'</div>
                        <div class="text-sm text-gray-500">זמן משוער</div>
                    </div>
                    <div class="card p-4 text-center">
                        <div class="text-2xl font-bold text-purple-600" id="route-price">₪0</div>
                        <div class="text-sm text-gray-500">מחיר משוער</div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- פאנל מידע נוסף -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
            <div id="routes-info-container" class="card p-6 hidden">
                <h2 class="text-xl font-semibold mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-route text-blue-500"></i>
                    מסלולים מומלצים
                </h2>
                <div id="routes-info" class="space-y-3"></div>
            </div>
            
            <div id="live-alerts-container" class="card p-6 hidden">
                <h2 class="text-xl font-semibold mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-triangle-exclamation text-yellow-500"></i>
                    התראות בזמן אמת
                </h2>
                <div id="live-alerts" class="space-y-2 text-sm"></div>
            </div>
            
            <div id="optimization-container" class="card p-6 hidden">
                <h2 class="text-xl font-semibold mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-lightbulb text-orange-500"></i>
                    הצעות לייעול
                </h2>
                <div id="optimization-suggestions" class="space-y-2 text-sm"></div>
            </div>
        </div>
    </div>
    
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbVYMijMs8zH6m4iiSiBfn_RiCMuau9ps&callback=onGoogleMapsApiLoad&libraries=places"></script>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxtQoHtQNkqZYDeDsEr0qqh9DJ1-zgaqDmmWd98la9Sx25LPeEcQoCdFDUK-Htm2xhQoQ/exec';
        
        let map, directionsService, directionsRenderer, panorama;
        let selectedRouteData = null;
        let debounceTimer;
        let currentRoutes = [];
        let priceData = {
            basePrice: 50,
            perKm: 2.5,
            deliveryTypeMultipliers: {
                'רגילה': 1.0,
                'דחופה': 1.5,
                'שבירה': 1.8,
                'מקרר': 2.0
            },
            trafficMultipliers: {
                'low': 1.0,
                'medium': 1.2,
                'high': 1.5
            }
        };

        window.onGoogleMapsApiLoad = function() {
            const elements = {
                customer: document.getElementById('customer'), customersList: document.getElementById('customers-list'),
                deliveryType: document.getElementById('delivery_type'), warehouse: document.getElementById('warehouse'),
                street: document.getElementById('street'), street_number: document.getElementById('street_number'),
                city: document.getElementById('city'), date: document.getElementById('date'), time: document.getElementById('time'),
                notes: document.getElementById('notes'), btnSaveOrder: document.getElementById('btn-save-order'),
                saveSpinner: document.getElementById('save-spinner'), routesInfo: document.getElementById('routes-info'),
                routesInfoContainer: document.getElementById('routes-info-container'), liveAlerts: document.getElementById('live-alerts'),
                liveAlertsContainer: document.getElementById('live-alerts-container'), optimizationSuggestions: document.getElementById('optimization-suggestions'),
                optimizationContainer: document.getElementById('optimization-container'), errorBanner: document.getElementById('error-banner'),
                priceCalculator: document.getElementById('price-calculator'), basePrice: document.getElementById('base-price'),
                distanceSurcharge: document.getElementById('distance-surcharge'), deliveryTypeSurcharge: document.getElementById('delivery-type-surcharge'),
                trafficSurcharge: document.getElementById('traffic-surcharge'), totalPrice: document.getElementById('total-price'),
                btnToggleBreakdown: document.getElementById('btn-toggle-breakdown'), priceBreakdown: document.getElementById('price-breakdown'),
                breakdownArrow: document.getElementById('breakdown-arrow'), breakdownBase: document.getElementById('breakdown-base'),
                breakdownPerKm: document.getElementById('breakdown-per-km'), breakdownKm: document.getElementById('breakdown-km'),
                breakdownTypeMultiplier: document.getElementById('breakdown-type-multiplier'), breakdownTrafficMultiplier: document.getElementById('breakdown-traffic-multiplier'),
                routeDistance: document.getElementById('route-distance'), routeDuration: document.getElementById('route-duration'),
                routePrice: document.getElementById('route-price'), btnRefreshRoutes: document.getElementById('btn-refresh-routes'),
                currentTime: document.getElementById('current-time'), connectionStatus: document.getElementById('connection-status')
            };

            function initializeMap() {
                const centerOfIsrael = { lat: 31.7, lng: 35.2 };
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 8, 
                    center: centerOfIsrael, 
                    streetViewControl: false, 
                    mapTypeControl: false,
                    styles: [
                        {
                            "featureType": "road",
                            "elementType": "geometry",
                            "stylers": [{"color": "#f5f5f5"}]
                        },
                        {
                            "featureType": "road.arterial",
                            "elementType": "labels.text.fill",
                            "stylers": [{"color": "#757575"}]
                        },
                        {
                            "featureType": "road.highway",
                            "elementType": "geometry",
                            "stylers": [{"color": "#dadada"}]
                        }
                    ]
                });
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({ 
                    map, 
                    suppressMarkers: false,
                    markerOptions: {
                        icon: {
                            url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNy41ODIgMiA0IDUuNTgyIDQgMTBDNCAxNi4wODggMTIgMjIgMTIgMjJDMTIgMjIgMjAgMTYuMDg4IDIwIDEwQzIwIDUuNTgyIDE2LjQxOCAyIDEyIDJaTTEyIDEyQzEwLjg5NiAxMiAxMCAxMS4xMDQgMTAgMTBDMTAgOC44OTYgMTAuODk2IDggMTIgOEMxMy4xMDQgOCAxNCA4Ljg5NiAxNCAxMEMxNCAxMS4xMDQgMTMuMTA0IDEyIDEyIDEyWiIgZmlsbD0iIzI1NjNlYiIvPgo8L3N2Zz4K',
                            scaledSize: new google.maps.Size(24, 24)
                        }
                    },
                    polylineOptions: { 
                        strokeColor: '#2563eb', 
                        strokeWeight: 6,
                        strokeOpacity: 0.8
                    } 
                });
                panorama = new google.maps.StreetViewPanorama(document.getElementById("pano"));
            }

            async function loadInitialData() {
                try {
                    const [warehouses, deliveryTypes, customers, cities] = await Promise.all([
                        fetchData('getSettings'), fetchData('getDeliveryTypes'),
                        fetchData('getCustomers'), fetchData('getCities')
                    ]);
                    populateSelect(elements.warehouse, warehouses.filter(w => w.key.startsWith('warehouse_')).map(w => w.value), "בחר מחסן...");
                    populateSelect(elements.deliveryType, deliveryTypes, "בחר סוג הובלה...");
                    populateSelect(elements.city, cities.sort(), "בחר עיר...");
                    populateDatalist(elements.customersList, customers.map(c => c.name));
                    
                    // הגדרת ערכי ברירת מחדל
                    const today = new Date().toISOString().split('T')[0];
                    elements.date.value = today;
                    
                    const now = new Date();
                    const hours = now.getHours().toString().padStart(2, '0');
                    const minutes = now.getMinutes().toString().padStart(2, '0');
                    elements.time.value = `${hours}:${minutes}`;
                    
                } catch (error) { showError(`שגיאה בטעינת נתונים: ${error.message}`); }
            }
            
            async function fetchData(action) {
                if (!SCRIPT_URL) throw new Error("כתובת ה-URL של הסקריפט אינה מוגדרת.");
                const response = await fetch(`${SCRIPT_URL}?action=${action}`);
                if (!response.ok) throw new Error(`שגיאת רשת: ${response.status}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(`שגיאת שרת (${action}): ${result.message}`);
                return result.data;
            }

            function populateSelect(selectEl, options, placeholder) {
                selectEl.innerHTML = `<option value="">${placeholder}</option>`;
                options.forEach(opt => selectEl.add(new Option(opt, opt)));
                selectEl.disabled = false;
            }

            function populateDatalist(datalistEl, options) {
                datalistEl.innerHTML = '';
                options.forEach(opt => datalistEl.appendChild(new Option(undefined, opt)));
            }

            function handleAddressChange() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(calculateAndDisplayRoutes, 800);
            }
            
            async function calculateAndDisplayRoutes() {
                selectedRouteData = null;
                const originAddress = elements.warehouse.value;
                const destinationAddress = `${elements.street.value} ${elements.street_number.value}, ${elements.city.value}`;
                if (!originAddress || !elements.street.value || !elements.city.value) return;

                directionsService.route({
                    origin: originAddress, 
                    destination: destinationAddress,
                    travelMode: google.maps.TravelMode.DRIVING, 
                    provideRouteAlternatives: true,
                    drivingOptions: {
                        departureTime: new Date(),
                        trafficModel: 'bestguess'
                    }
                }, (result, status) => {
                    if (status === 'OK') {
                        showError(null);
                        currentRoutes = result.routes;
                        directionsRenderer.setDirections(result);
                        const leg = result.routes[0].legs[0];
                        panorama.setPosition(leg.end_location);
                        map.setCenter(leg.end_location); 
                        map.setZoom(14);
                        displayRoutesInfo(result.routes);
                        displayLiveAlerts(result.routes[0]);
                        displayOptimizations();
                        updateRouteStats(leg);
                        calculatePrice(leg);
                        elements.priceCalculator.classList.remove('hidden');
                    } else { 
                        showError(`שגיאה בחישוב מסלול: ${status}.`); 
                        elements.priceCalculator.classList.add('hidden');
                    }
                });
            }
            
            function displayRoutesInfo(routes) {
                elements.routesInfo.innerHTML = '';
                routes.slice(0, 3).forEach((route, index) => {
                    const leg = route.legs[0];
                    const card = document.createElement('div');
                    card.className = `route-option border p-3 rounded-lg cursor-pointer transition-all ${index === 0 ? 'selected border-blue-700 bg-blue-50' : 'border-gray-300 hover:bg-gray-50'}`;
                    card.innerHTML = `
                        <div class="font-bold flex justify-between">
                            <span>מסלול ${index + 1}</span>
                            <span>${leg.duration.text}</span>
                        </div>
                        <div class="text-sm text-gray-600 flex justify-between mt-1">
                            <span>${leg.distance.text}</span>
                            <span>${route.summary}</span>
                        </div>
                    `;
                    card.addEventListener('click', () => {
                        directionsRenderer.setRouteIndex(index);
                        selectedRouteData = { 
                            distance_km: leg.distance.text, 
                            duration_min: leg.duration.text,
                            route_index: index
                        };
                        document.querySelectorAll('.route-option').forEach(el => {
                            el.classList.remove('selected', 'border-blue-700', 'bg-blue-50');
                            el.classList.add('border-gray-300');
                        });
                        card.classList.add('selected', 'border-blue-700', 'bg-blue-50');
                        card.classList.remove('border-gray-300');
                        updateRouteStats(leg);
                        calculatePrice(leg);
                    });
                    elements.routesInfo.appendChild(card);
                });
                elements.routesInfoContainer.classList.remove('hidden', 'fade-in');
                void elements.routesInfoContainer.offsetWidth;
                elements.routesInfoContainer.classList.add('fade-in');
                selectedRouteData = { 
                    distance_km: routes[0].legs[0].distance.text, 
                    duration_min: routes[0].legs[0].duration.text,
                    route_index: 0
                };
            }

            function displayLiveAlerts(route) {
                elements.liveAlerts.innerHTML = '';
                let hasAlerts = false;
                
                // בדיקת עומס תנועה
                if (route.legs[0].duration_in_traffic) {
                    const trafficDuration = route.legs[0].duration_in_traffic.value;
                    const normalDuration = route.legs[0].duration.value;
                    const trafficRatio = trafficDuration / normalDuration;
                    
                    if (trafficRatio > 1.3) {
                        elements.liveAlerts.innerHTML += `
                            <div class="flex items-start gap-2 p-2 bg-red-50 rounded-md">
                                <i class="fa-solid fa-car-burst text-red-500 mt-1"></i>
                                <p>עומס תנועה כבד - זמן נסיעה ארוך ב-${Math.round((trafficRatio - 1) * 100)}% מהרגיל</p>
                            </div>`;
                        hasAlerts = true;
                    } else if (trafficRatio > 1.1) {
                        elements.liveAlerts.innerHTML += `
                            <div class="flex items-start gap-2 p-2 bg-yellow-50 rounded-md">
                                <i class="fa-solid fa-car-side text-yellow-500 mt-1"></i>
                                <p>עומס תנועה בינוני - זמן נסיעה ארוך ב-${Math.round((trafficRatio - 1) * 100)}% מהרגיל</p>
                            </div>`;
                        hasAlerts = true;
                    }
                }
                
                // בדיקת אזורי בנייה
                if (route.warnings && route.warnings.length > 0) {
                    route.warnings.forEach(warning => {
                        if (warning.includes('construction') || warning.includes('closure') || warning.includes('work')) {
                            elements.liveAlerts.innerHTML += `
                                <div class="flex items-start gap-2 p-2 bg-orange-50 rounded-md">
                                    <i class="fa-solid fa-triangle-exclamation text-orange-500 mt-1"></i>
                                    <p>${warning}</p>
                                </div>`;
                            hasAlerts = true;
                        }
                    });
                }
                
                // בדיקת מזג אוויר (סימולציה)
                const weatherAlerts = checkWeatherAlerts();
                if (weatherAlerts) {
                    elements.liveAlerts.innerHTML += weatherAlerts;
                    hasAlerts = true;
                }
                
                elements.liveAlertsContainer.classList.toggle('hidden', !hasAlerts);
                if(hasAlerts) {
                    void elements.liveAlertsContainer.offsetWidth;
                    elements.liveAlertsContainer.classList.add('fade-in');
                }
            }

            function checkWeatherAlerts() {
                // סימולציה של התראות מזג אוויר
                const alerts = [];
                const hour = new Date().getHours();
                
                // סימולציה של גשם בשעות מסוימות
                if (hour >= 6 && hour <= 12) {
                    alerts.push(`
                        <div class="flex items-start gap-2 p-2 bg-blue-50 rounded-md">
                            <i class="fa-solid fa-cloud-rain text-blue-500 mt-1"></i>
                            <p>גשם קל צפוי באזור - נהג בזהירות</p>
                        </div>
                    `);
                }
                
                // סימולציה של רוחות חזקות
                if (hour >= 14 && hour <= 18) {
                    alerts.push(`
                        <div class="flex items-start gap-2 p-2 bg-purple-50 rounded-md">
                            <i class="fa-solid fa-wind text-purple-500 mt-1"></i>
                            <p>רוחות חזקות צפויות - נא להיזהר בנהיגה</p>
                        </div>
                    `);
                }
                
                return alerts.join('');
            }

            function displayOptimizations() {
                elements.optimizationSuggestions.innerHTML = '';
                let hasSuggestion = false;
                const currentHour = new Date().getHours();
                
                // הצעות על בסיס שעת היום
                if ((currentHour >= 7 && currentHour <= 9) || (currentHour >= 16 && currentHour <= 18)) {
                    elements.optimizationSuggestions.innerHTML += `
                        <div class="flex items-start gap-2 p-2 bg-orange-50 rounded-md">
                            <i class="fa-solid fa-clock text-orange-500 mt-1"></i>
                            <p>נסיעה בשעות העומס. שקלו יציאה מחוץ לשעות 07-09 או 16-18 לחיסכון בזמן.</p>
                        </div>`;
                    hasSuggestion = true;
                }
                
                // הצעות על בסיס סוג הובלה
                const deliveryType = elements.deliveryType.value;
                if (deliveryType === 'שבירה') {
                    elements.optimizationSuggestions.innerHTML += `
                        <div class="flex items-start gap-2 p-2 bg-green-50 rounded-md">
                            <i class="fa-solid fa-boxes-packing text-green-500 mt-1"></i>
                            <p>להובלת פריטים שבירים - ודאו ריפוד מתאים ואריזה בטוחה.</p>
                        </div>`;
                    hasSuggestion = true;
                }
                
                if (deliveryType === 'מקרר') {
                    elements.optimizationSuggestions.innerHTML += `
                        <div class="flex items-start gap-2 p-2 bg-blue-50 rounded-md">
                            <i class="fa-solid fa-snowflake text-blue-500 mt-1"></i>
                            <p>להובלה בקירור - ודאו טמפרטורה מתאימה ומערכת קירור תקינה.</p>
                        </div>`;
                    hasSuggestion = true;
                }
                
                elements.optimizationContainer.classList.toggle('hidden', !hasSuggestion);
                if(hasSuggestion) {
                    void elements.optimizationContainer.offsetWidth;
                    elements.optimizationContainer.classList.add('fade-in');
                }
            }
            
            function updateRouteStats(leg) {
                elements.routeDistance.textContent = leg.distance.text;
                elements.routeDuration.textContent = leg.duration.text;
            }
            
            function calculatePrice(leg) {
                // חילוץ קילומטרים מהמחרוזת
                const distanceText = leg.distance.text;
                const distanceKm = parseFloat(distanceText.replace('ק"מ', '').replace(',', '').trim());
                
                // חישוב על בסיס מרחק
                const basePrice = priceData.basePrice;
                const distanceCost = distanceKm * priceData.perKm;
                
                // חישוב על בסיס סוג הובלה
                const deliveryType = elements.deliveryType.value;
                const typeMultiplier = priceData.deliveryTypeMultipliers[deliveryType] || 1.0;
                const typeSurcharge = (basePrice + distanceCost) * (typeMultiplier - 1);
                
                // חישוב על בסיס עומס תנועה
                const currentHour = new Date().getHours();
                let trafficMultiplier = 1.0;
                if ((currentHour >= 7 && currentHour <= 9) || (currentHour >= 16 && currentHour <= 18)) {
                    trafficMultiplier = priceData.trafficMultipliers.high;
                } else if ((currentHour >= 10 && currentHour <= 12) || (currentHour >= 14 && currentHour <= 15)) {
                    trafficMultiplier = priceData.trafficMultipliers.medium;
                }
                const trafficSurcharge = (basePrice + distanceCost + typeSurcharge) * (trafficMultiplier - 1);
                
                // חישוב סופי
                const total = basePrice + distanceCost + typeSurcharge + trafficSurcharge;
                
                // עדכון תצוגה
                elements.basePrice.textContent = `₪${basePrice}`;
                elements.distanceSurcharge.textContent = `₪${distanceCost.toFixed(2)}`;
                elements.deliveryTypeSurcharge.textContent = `₪${typeSurcharge.toFixed(2)}`;
                elements.trafficSurcharge.textContent = `₪${trafficSurcharge.toFixed(2)}`;
                elements.totalPrice.textContent = `₪${total.toFixed(2)}`;
                elements.routePrice.textContent = `₪${total.toFixed(2)}`;
                
                // עדכון פירוט מחיר
                elements.breakdownBase.textContent = `₪${basePrice}`;
                elements.breakdownPerKm.textContent = `₪${priceData.perKm}`;
                elements.breakdownKm.textContent = `${distanceKm.toFixed(1)}`;
                elements.breakdownTypeMultiplier.textContent = `${typeMultiplier.toFixed(1)}x`;
                elements.breakdownTrafficMultiplier.textContent = `${trafficMultiplier.toFixed(1)}x`;
            }
            
            async function saveOrder() {
                const required = [elements.customer, elements.street, elements.city, elements.deliveryType, elements.warehouse, elements.date];
                const isValid = required.every(el => el.value ? (el.classList.remove('border-red-500'), true) : (el.classList.add('border-red-500'), false));
                if (!isValid) return showError("נא למלא שדות חובה.");
                if (!selectedRouteData) return showError("יש לחשב מסלול לפני שמירה.");
                
                elements.saveSpinner.classList.remove('hidden');
                elements.btnSaveOrder.disabled = true;

                try {
                    // FIX: Collect data directly from elements
                    const payload = {
                        customer: elements.customer.value,
                        street: elements.street.value,
                        street_number: elements.street_number.value,
                        city: elements.city.value,
                        delivery_type: elements.deliveryType.value,
                        warehouse: elements.warehouse.value,
                        date: elements.date.value,
                        time: elements.time.value,
                        notes: elements.notes.value,
                        distance_km: selectedRouteData.distance_km,
                        duration_min: selectedRouteData.duration_min,
                        route_index: selectedRouteData.route_index
                    };
                    
                    const response = await fetch(`${SCRIPT_URL}?action=createOrder`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error(`שגיאת רשת: ${response.status}`);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        showError(null);
                        alert("ההזמנה נשמרה בהצלחה!");
                        resetForm();
                    } else {
                        throw new Error(result.message || "שגיאה לא ידועה");
                    }
                } catch (error) {
                    showError(`שגיאה בשמירת ההזמנה: ${error.message}`);
                } finally {
                    elements.saveSpinner.classList.add('hidden');
                    elements.btnSaveOrder.disabled = false;
                }
            }
            
            function resetForm() {
                elements.customer.value = '';
                elements.street.value = '';
                elements.street_number.value = '';
                elements.city.value = '';
                elements.deliveryType.value = '';
                elements.warehouse.value = '';
                elements.notes.value = '';
                elements.priceCalculator.classList.add('hidden');
                elements.routesInfoContainer.classList.add('hidden');
                elements.liveAlertsContainer.classList.add('hidden');
                elements.optimizationContainer.classList.add('hidden');
                directionsRenderer.set('directions', null);
                map.setCenter({ lat: 31.7, lng: 35.2 });
                map.setZoom(8);
            }
            
            function showError(message) {
                if (!message) {
                    elements.errorBanner.classList.add('hidden');
                    return;
                }
                elements.errorBanner.textContent = message;
                elements.errorBanner.classList.remove('hidden');
            }
            
            function updateCurrentTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateString = now.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                elements.currentTime.textContent = `${dateString} | ${timeString}`;
            }
            
            function togglePriceBreakdown() {
                const isHidden = elements.priceBreakdown.classList.contains('hidden');
                elements.priceBreakdown.classList.toggle('hidden', !isHidden);
                elements.breakdownArrow.className = isHidden ? 'fa-solid fa-chevron-up text-xs' : 'fa-solid fa-chevron-down text-xs';
                elements.btnToggleBreakdown.innerHTML = isHidden ? 
                    '<i class="fa-solid fa-receipt"></i> הסתר פירוט מחיר <i id="breakdown-arrow" class="fa-solid fa-chevron-up text-xs"></i>' : 
                    '<i class="fa-solid fa-receipt"></i> הצג פירוט מחיר <i id="breakdown-arrow" class="fa-solid fa-chevron-down text-xs"></i>';
            }

            // אתחול
            initializeMap();
            loadInitialData();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);

            // מאזינים לאירועים
            [elements.street, elements.street_number, elements.city].forEach(el => {
                el.addEventListener('input', handleAddressChange);
            });
            elements.warehouse.addEventListener('change', handleAddressChange);
            elements.deliveryType.addEventListener('change', () => {
                if (selectedRouteData) {
                    const leg = currentRoutes[selectedRouteData.route_index].legs[0];
                    calculatePrice(leg);
                }
            });
            elements.btnSaveOrder.addEventListener('click', saveOrder);
            elements.btnToggleBreakdown.addEventListener('click', togglePriceBreakdown);
            elements.btnRefreshRoutes.addEventListener('click', calculateAndDisplayRoutes);
        };
    </script>
</body>
</html>
