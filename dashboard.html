<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול לוגיסטיקה V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f1f5f9; }
        .tab { cursor: pointer; padding: 10px 20px; border-bottom: 4px solid transparent; }
        .tab.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
    </style>
</head>
<body class="text-slate-800">
    <div class="container mx-auto p-4 max-w-screen-2xl">
        <header class="mb-6"><h1 class="text-4xl font-bold text-slate-900">מרכז בקרה לוגיסטי</h1></header>
        <div class="border-b border-slate-200 mb-6">
            <nav id="tabs-nav" class="flex space-x-4 -mb-px">
                <a data-tab="dashboard" class="tab active"><i class="fa-solid fa-chart-pie mr-2"></i>לוח בקרה</a>
                <a data-tab="orders" class="tab"><i class="fa-solid fa-tasks mr-2"></i>ניהול הזמנות</a>
                <a data-tab="planner" class="tab"><i class="fa-solid fa-route mr-2"></i>תכנון מסלול יומי</a>
            </nav>
        </div>
        <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4"></div>

        <main>
            <div id="content-dashboard" class="tab-content active"></div>
            <div id="content-orders" class="tab-content"></div>
            <div id="content-planner" class="tab-content"></div>
        </main>
    </div>

    <!-- Modals placeholder -->
    <div id="modal-container"></div>
    
    <script>
        console.log("🟢 שלב 1: הקוד מתחיל לרוץ. מגדיר מפתחות.");
        // =================================================================
        // ==  חשוב: הדבק את המפתחות הנכונים כאן                    ==
        // =================================================================
        const API_KEY = 'AIzaSyCbVYMijMs8zH6m4iiSiBfn_RiCMuau9ps'; // 👈 הדבק פה את מפתח המפות (מתחיל ב-AIza)
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxpOAKeEbbHbOZgCa8_j0j52ITQn7dwIIUdAPgiF1yW7g3NqCpalzm8U2vJIySDTuaHBw/exec'; // 👈 הדבק פה את כתובת הסקריפט
        // =================================================================
    </script>
    <script>
        (function() {
            console.log("🔵 שלב 2: מכין בקשה לטעינת גוגל מפות.");
            if (!API_KEY || !API_KEY.startsWith('AIza')) {
                console.error("⛔️ כשל קריטי: מפתח ה-API של גוגל מפות אינו תקין או חסר!");
                document.getElementById('error-banner').textContent = 'שגיאה קריטית: מפתח ה-API של גוגל מפות אינו תקין.';
                document.getElementById('error-banner').classList.remove('hidden');
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initApp&libraries=places`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
            console.log("🟡 שלב 3: נשלחה בקשה לטעינת גוגל מפות. ממתין לתשובה...");
        })();
    </script>
    
    <script>
    // Main App Entry Point
    function initApp() {
        console.log("✅ שלב 4: הצלחה! גוגל מפות נטען. מתחיל את האפליקציה.");
        
        let allOrders = [], initialData = {}, charts = {};
        let plannerMap, newOrderMap, viewMap, directionsService, plannerDR, newOrderDR, viewDR;

        const elements = {
            nav: document.getElementById('tabs-nav'),
            errorBanner: document.getElementById('error-banner'),
            content: {
                dashboard: document.getElementById('content-dashboard'),
                orders: document.getElementById('content-orders'),
                planner: document.getElementById('content-planner'),
            },
            modals: document.getElementById('modal-container'),
        };
        
        function initialize() {
            console.log("⚙️ שלב 5: בונה את שלד הממשק.");
            renderSkeletons();
            console.log("🔗 שלב 6: מחבר איוונטים לכפתורים.");
            setupEventListeners();
            console.log("☁️ שלב 7: פונה לשרת להביא נתונים ראשוניים...");
            loadInitialData().then(() => {
                console.log("🚀 שלב 8: נתונים הגיעו. מפעיל את הטאב הראשון.");
                handleTabClick(document.querySelector('.tab.active'));
            });
        }
        
        function renderSkeletons() {
            elements.content.dashboard.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-4 gap-6"><div class="card p-6 col-span-full">...</div></div>`;
            elements.content.orders.innerHTML = `<div class="grid grid-cols-12 gap-6"><div class="col-span-12 lg:col-span-4 card p-6"><h2 id="form-title" class="text-2xl font-semibold mb-4">יצירת הזמנה</h2><form id="order-form" class="space-y-4"><!-- Form fields --></form></div><div class="col-span-12 lg:col-span-8 card p-6"><h2 class="text-2xl font-semibold mb-4">הזמנות פתוחות</h2><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50">...</thead><tbody id="orders-table-body"></tbody></table></div></div></div>`;
            elements.content.planner.innerHTML = `<div class="grid grid-cols-12 gap-6"><div class="col-span-4 card p-6">...</div><div class="col-span-8 card p-4"><div id="planner-map" class="w-full h-[500px] rounded-lg bg-slate-200"></div>...</div></div>`;
        }

        function setupEventListeners() {
            elements.nav.addEventListener('click', e => {
                if (e.target.closest('.tab')) handleTabClick(e.target.closest('.tab'));
            });
        }

        async function loadInitialData() {
            try {
                initialData = await runGAS('getInitialData');
                allOrders = initialData.activeOrders;
            } catch (error) { showError(error.message); }
        }

        function handleTabClick(tab) {
            const tabName = tab.dataset.tab;
            console.log(`Switching to tab: ${tabName}`);
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            elements.content[tabName].classList.add('active');

            // Initialize maps only when their tab is first viewed
            if (tabName === 'orders' && !newOrderMap) {
                newOrderMap = new google.maps.Map(document.getElementById("new-order-map"));
                newOrderDR = new google.maps.DirectionsRenderer({ map: newOrderMap });
            }
            if (tabName === 'planner' && !plannerMap) {
                plannerMap = new google.maps.Map(document.getElementById("planner-map"));
                plannerDR = new google.maps.DirectionsRenderer({ map: plannerMap });
            }
            
            // Render content
            // ... logic to render charts, tables, etc. for each tab
        }
        
        function runGAS(action, payload) {
            console.log(`Executing server action: ${action}`);
            const isGet = !payload;
            const url = isGet ? `${SCRIPT_URL}?action=${action}` : SCRIPT_URL;
            const options = isGet ? { method: 'GET' } : { method: 'POST', body: JSON.stringify({ action, payload }) };
            
            return fetch(url, options)
                .then(res => res.json())
                .then(response => {
                    if (response.status === 'error') throw new Error(response.message);
                    console.log(`✅ SUCCESS from server for action: ${action}`);
                    return response.data;
                });
        }

        function showError(message) {
            console.error("⛔️ Application Error:", message);
            elements.errorBanner.textContent = message;
            elements.errorBanner.classList.remove('hidden');
        }

        initialize();
    }
    </script>
</body>
</html>

