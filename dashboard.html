<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM -  砖爪</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .kpi-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .scheduling-board {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .driver-column {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .driver-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .driver-header img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .timeline {
            padding: 10px;
            min-height: 400px;
        }
        
        .time-slot {
            display: flex;
            margin-bottom: 5px;
            border: 1px dashed #ddd;
            border-radius: 4px;
        }
        
        .time-label {
            background: #f8f9fa;
            padding: 5px;
            min-width: 50px;
            text-align: center;
            font-size: 12px;
        }
        
        .drop-zone {
            flex: 1;
            min-height: 60px;
            padding: 5px;
        }
        
        .order-card {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .address-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }
        
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #1976d2;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .log-entry {
            position: fixed;
            bottom: 10px;
            left: 10px;
            padding: 10px;
            border-radius: 4px;
            color: white;
            max-width: 300px;
            z-index: 1001;
        }
        
        .log-entry.error { background: #f44336; }
        .log-entry.success { background: #4caf50; }
        .log-entry.info { background: #2196f3; }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="logger"></div>

    <div class="header">
        <h1> 砖爪</h1>
        <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
            <input type="date" id="datePicker">
            <button id="addNewOrderBtn">+  砖</button>
            <button id="testConnectionBtn">拽转 专</button>
        </div>
    </div>

    <div class="kpi-container">
        <div class="kpi-card">
            <div style="font-size: 24px; font-weight: bold;" id="totalOrders">0</div>
            <div>转 驻注转</div>
        </div>
        <div class="kpi-card">
            <div style="font-size: 24px; font-weight: bold;" id="activeDrivers">2</div>
            <div> 驻注</div>
        </div>
        <div class="kpi-card">
            <div style="font-size: 24px; font-weight: bold;" id="totalKm">0</div>
            <div>拽" 砖注专</div>
        </div>
    </div>

    <div class="scheduling-board">
        <div class="driver-column">
            <div class="driver-header">
                <img src="https://i.postimg.cc/d3S0NJJZ/Screenshot-20250623-200646-Facebook.jpg" alt="转">
                <div>
                    <h3>转</h3>
                    <div style="font-size: 12px; color: #666;">
                        <span id="hakmat-orders-count">0 转</span> | 
                        <span id="hakmat-km-total">0 拽"</span>
                    </div>
                </div>
            </div>
            <div class="timeline" id="timeline-hakmat"></div>
        </div>

        <div class="driver-column">
            <div class="driver-header">
                <img src="https://i.postimg.cc/tCNbgXK3/Screenshot-20250623-200744-Tik-Tok.jpg" alt="注">
                <div>
                    <h3>注</h3>
                    <div style="font-size: 12px; color: #666;">
                        <span id="ali-orders-count">0 转</span> | 
                        <span id="ali-km-total">0 拽"</span>
                    </div>
                </div>
            </div>
            <div class="timeline" id="timeline-ali"></div>
        </div>
    </div>

    <!-- Modal -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                <h2 id="form-title"> 砖</h2>
                <button onclick="closeModal()" style="background: #f44336;">X</button>
            </div>
            
            <form id="createOrderForm">
                <input type="hidden" id="orderId">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>拽 *</label>
                        <input list="customers-list" id="orderCustomer" required>
                        <datalist id="customers-list"></datalist>
                    </div>
                    
                    <div class="form-group">
                        <label>驻 *</label>
                        <input type="tel" id="orderPhone" required>
                    </div>
                    
                    <div class="form-group">
                        <label>砖 砖 拽砖专</label>
                        <input type="text" id="orderContactName">
                    </div>
                    
                    <div class="form-group">
                        <label>注专 *</label>
                        <select id="orderCity" required>
                            <option value="">专 注专...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>住  *</label>
                        <select id="orderDeliveryType" required>
                            <option value="">专 住 ...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label> *</label>
                        <select id="orderDriver" required>
                            <option value="转">转</option>
                            <option value="注">注</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>转专 *</label>
                        <input type="date" id="orderDate" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>砖注 *</label>
                        <input type="time" id="orderTime" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>转转 *</label>
                    <div class="address-row">
                        <input type="text" id="orderStreet" placeholder="专" required>
                        <input type="text" id="orderStreetNumber" placeholder="住驻专 转">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>住 *</label>
                    <select id="orderWarehouse" required>
                        <option value="转 6,  砖专">转 6,  砖专</option>
                        <option value="专砖 10,  砖专">专砖 10,  砖专</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>注专转</label>
                    <textarea id="orderNotes" rows="3"></textarea>
                </div>
                
                <button type="submit" id="submitOrderBtn">砖专 </button>
            </form>
        </div>
    </div>

<script>
// 转转 -URL 砖 Google Apps Script
const BACKEND_BASE = 'https://script.google.com/macros/s/AKfycbyKWp5aQQNSg27l60Ex3MFtDOzKD3eGUE5ABHNogVpj9JbM5YJs1q6wNvlv9vv410MMWg/exec';

// 驻拽爪 爪专转 URL 注 CORS proxy
function getBackendURL(params = '') {
    // 住 住驻专 proxies 砖
    const proxies = [
        `https://api.allorigins.win/get?url=${encodeURIComponent(BACKEND_BASE + params)}`,
        `https://corsproxy.io/?${encodeURIComponent(BACKEND_BASE + params)}`,
        `https://thingproxy.freeboard.io/fetch/${encodeURIComponent(BACKEND_BASE + params)}`,
        BACKEND_BASE + params // 住 砖专转
    ];
    
    return proxies[0]; // 转 注 专砖
}

let allOrders = [];
let customersData = [];
let citiesData = [];

// 注专转 注转
function showMessage(message, type = 'info') {
    const logger = document.getElementById('logger');
    const messageDiv = document.createElement('div');
    messageDiv.className = `log-entry ${type}`;
    messageDiv.textContent = message;
    logger.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 5000);
}

// 转 转专
function initializeDate() {
    const now = new Date();
    document.getElementById('datePicker').value = now.toISOString().split('T')[0];
}

// 爪专转 转 
function generateTimeSlots() {
    const timelines = ['hakmat', 'ali'];
    
    timelines.forEach(driver => {
        const timeline = document.getElementById(`timeline-${driver}`);
        timeline.innerHTML = '';
        
        for (let hour = 6; hour < 18; hour++) {
            for (let minute of ['00', '30']) {
                const time = `${hour.toString().padStart(2, '0')}:${minute}`;
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.innerHTML = `
                    <div class="time-label">${time}</div>
                    <div class="drop-zone" data-time="${time}" data-driver="${driver}"></div>
                `;
                timeline.appendChild(timeSlot);
            }
        }
    });
}

// 注转 转
async function loadOrders(date) {
    try {
        showMessage('注 转...', 'info');
        
        const url = getBackendURL(`?action=getActiveOrders&date=${date}`);
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`砖: ${response.status}`);
        }
        
        let result = await response.json();
        
        // 驻 转转 proxy
        if (result.contents) {
            result = JSON.parse(result.contents);
        }
        
        if (result.status === 'success') {
            allOrders = result.data || [];
            renderOrders();
            updateKPIs();
            showMessage(`注 ${allOrders.length} 转`, 'success');
        } else {
            throw new Error(result.data || '砖 注转 转');
        }
        
    } catch (error) {
        console.error('Error loading orders:', error);
        showMessage('砖 注转 转: ' + error.message, 'error');
        allOrders = [];
        renderOrders();
    }
}

// 爪转 转
function renderOrders() {
    // 拽 转 拽转
    document.querySelectorAll('.order-card').forEach(card => card.remove());
    
    const stats = {
        hakmat: { orders: 0, km: 0 },
        ali: { orders: 0, km: 0 }
    };
    
    allOrders.forEach(order => {
        const driver = order[''] || order.driver;
        const driverKey = driver === '转' ? 'hakmat' : 'ali';
        const time = order['砖注'] || order.time;
        
        const timeSlot = document.querySelector(`#timeline-${driverKey} .drop-zone[data-time="${time}"]`);
        
        if (timeSlot) {
            const orderCard = createOrderCard(order);
            timeSlot.appendChild(orderCard);
            
            stats[driverKey].orders++;
            
            // 砖 拽"
            const city = citiesData.find(c => c['注专'] === (order['注专'] || order.city));
            if (city && city['专拽  砖专 (拽")']) {
                stats[driverKey].km += parseFloat(city['专拽  砖专 (拽")']);
            }
        }
    });
    
    // 注 住住拽转
    document.getElementById('hakmat-orders-count').textContent = `${stats.hakmat.orders} 转`;
    document.getElementById('hakmat-km-total').textContent = `${stats.hakmat.km.toFixed(1)} 拽"`;
    document.getElementById('ali-orders-count').textContent = `${stats.ali.orders} 转`;
    document.getElementById('ali-km-total').textContent = `${stats.ali.km.toFixed(1)} 拽"`;
}

// 爪专转 专住 
function createOrderCard(order) {
    const div = document.createElement('div');
    div.className = 'order-card';
    div.innerHTML = `
        <div style="font-weight: bold;">${order['拽'] || order.customer}</div>
        <div style="font-size: 12px; color: #666;">${order['转转 住驻拽'] || ''}</div>
        <div style="font-size: 11px; color: #888;">${order['砖注'] || ''} | ${order['住 '] || ''}</div>
    `;
    
    div.addEventListener('click', () => {
        openEditModal(order);
    });
    
    return div;
}

// 注 KPI
function updateKPIs() {
    document.getElementById('totalOrders').textContent = allOrders.length;
    
    const totalKm = allOrders.reduce((sum, order) => {
        const city = citiesData.find(c => c['注专'] === (order['注专'] || order.city));
        return sum + (city && city['专拽  砖专 (拽")'] ? parseFloat(city['专拽  砖专 (拽")']) : 0);
    }, 0);
    
    document.getElementById('totalKm').textContent = totalKm.toFixed(0);
}

// 注转 拽转
async function loadCustomers() {
    try {
        const url = getBackendURL('?action=getCustomers');
        const response = await fetch(url);
        
        if (!response.ok) throw new Error(`砖: ${response.status}`);
        
        let result = await response.json();
        
        // 驻 转转 proxy
        if (result.contents) {
            result = JSON.parse(result.contents);
        }
        
        if (result.status === 'success') {
            customersData = result.data || [];
            populateCustomersList();
        }
    } catch (error) {
        console.error('Error loading customers:', error);
        showMessage('砖 注转 拽转', 'error');
        customersData = [];
    }
}

// 注转 注专
async function loadCities() {
    try {
        const url = getBackendURL('?action=getCities');
        const response = await fetch(url);
        
        if (!response.ok) throw new Error(`砖: ${response.status}`);
        
        let result = await response.json();
        
        // 驻 转转 proxy
        if (result.contents) {
            result = JSON.parse(result.contents);
        }
        
        if (result.status === 'success') {
            citiesData = result.data || [];
            populateCitiesList();
            populateDeliveryTypes();
        }
    } catch (error) {
        console.error('Error loading cities:', error);
        showMessage('砖 注转 注专', 'error');
        citiesData = [];
        
        // 注 注专 拽转 
        loadLocalCities();
    }
}

// 注转 注专 拽转 
function loadLocalCities() {
    const localCities = [
        '转 -驻', '专砖', '驻', '专砖 爪', '驻转 转拽',
        '砖', '转', '专 砖注', ' 专拽', '', '专转 ',
        '砖拽', '专转', '转 ', '专爪', '驻专 住', '专',
        '注--专注转', '', '专注', '专', ' 砖专',
        '拽专转 转', '拽专转 转', '转', '专', '注', '注驻',
        '专', '爪驻转', '', '砖专转', '转转', '驻拽', '注专',
        '拽专转 砖', '', '注转', '拽专转 ', '专 ',
        '-住', '住 爪', '专转 砖专', '专转 专', '砖专',
        ' 注拽', '拽注 注转', '驻专 ', '专', '注 ',
        '转专 注转', '注', '专砖 注', '专', '驻专 拽住', '拽住',
        '拽 -专', ' -驻', '住\'', '专', '砖驻专注',
        '专', '祝 ', '转 砖', '拽专转 ', '拽专转 拽',
        '拽专转 爪拽', '注转 砖', ' 专', '砖'
    ];
    
    citiesData = localCities.map(city => ({
        '注专': city,
        '专拽  砖专 (拽")': Math.floor(Math.random() * 100) + 10,
        '住 ': '转 砖转'
    }));
    
    populateCitiesList();
    populateDeliveryTypes();
}

//  专砖转 拽转
function populateCustomersList() {
    const datalist = document.getElementById('customers-list');
    datalist.innerHTML = '';
    
    customersData.forEach(customer => {
        const option = document.createElement('option');
        option.value = customer['砖 拽'] || customer.name || '';
        datalist.appendChild(option);
    });
}

//  专砖转 注专
function populateCitiesList() {
    const select = document.getElementById('orderCity');
    select.innerHTML = '<option value="">专 注专...</option>';
    
    citiesData.forEach(city => {
        const option = document.createElement('option');
        option.value = city['注专'] || city.name || '';
        option.textContent = city['注专'] || city.name || '';
        select.appendChild(option);
    });
}

//  住 
function populateDeliveryTypes() {
    const select = document.getElementById('orderDeliveryType');
    select.innerHTML = '<option value="">专 住 ...</option>';
    
    const types = new Set();
    citiesData.forEach(city => {
        if (city['住 ']) {
            types.add(city['住 ']);
        }
    });
    
    //   住, 住祝 专专转 
    if (types.size === 0) {
        types.add('转 砖转');
        types.add('转 祝');
        types.add('转 祝 15 专');
        types.add('砖 注爪转');
    }
    
    types.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        select.appendChild(option);
    });
}

// 驻转转  注专
function openEditModal(order) {
    document.getElementById('form-title').textContent = '注专转 ';
    document.getElementById('orderId').value = order['转转 '] || order.id || '';
    document.getElementById('orderCustomer').value = order['拽'] || order.customer || '';
    document.getElementById('orderPhone').value = order['驻'] || order.phone || '';
    document.getElementById('orderContactName').value = order['砖 砖 拽砖专'] || order.contactName || '';
    document.getElementById('orderCity').value = order['注专'] || order.city || '';
    document.getElementById('orderDeliveryType').value = order['住 '] || order.deliveryType || '';
    document.getElementById('orderDriver').value = order[''] || order.driver || '转';
    document.getElementById('orderDate').value = (order['转专'] || order.date || '').split(' ')[0] || document.getElementById('datePicker').value;
    document.getElementById('orderTime').value = (order['砖注'] || order.time || '').replace(':00', '') || '09:00';
    document.getElementById('orderWarehouse').value = order['住'] || order.warehouse || '转 6,  砖专';
    document.getElementById('orderNotes').value = order['注专转'] || order.notes || '';
    
    // 驻专拽 转转
    const address = order['转转 住驻拽'] || '';
    const streetMatch = address.match(/^(.*?)\s+(\d+.*)?$/);
    if (streetMatch) {
        document.getElementById('orderStreet').value = streetMatch[1] || '';
        document.getElementById('orderStreetNumber').value = streetMatch[2] || '';
    }
    
    openModal();
}

// 驻转转  砖
function openNewModal(driver, time) {
    document.getElementById('form-title').textContent = ' 砖';
    document.getElementById('createOrderForm').reset();
    document.getElementById('orderId').value = '';
    document.getElementById('orderDate').value = document.getElementById('datePicker').value;
    document.getElementById('orderTime').value = time || '09:00';
    document.getElementById('orderDriver').value = driver || '转';
    openModal();
}

function openModal() {
    document.getElementById('orderModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('orderModal').style.display = 'none';
}

// 砖转 驻住
async function handleFormSubmit(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitOrderBtn');
    const originalText = submitBtn.textContent;
    
    submitBtn.disabled = true;
    submitBtn.textContent = '砖专...';
    
    try {
        const formData = {
            id: document.getElementById('orderId').value,
            customer: document.getElementById('orderCustomer').value,
            phone: document.getElementById('orderPhone').value,
            contactName: document.getElementById('orderContactName').value,
            street: document.getElementById('orderStreet').value,
            streetNumber: document.getElementById('orderStreetNumber').value,
            city: document.getElementById('orderCity').value,
            deliveryType: document.getElementById('orderDeliveryType').value,
            driver: document.getElementById('orderDriver').value,
            date: document.getElementById('orderDate').value,
            time: document.getElementById('orderTime').value,
            warehouse: document.getElementById('orderWarehouse').value,
            notes: document.getElementById('orderNotes').value
        };
        
        //  砖转 
        if (!formData.customer || !formData.phone || !formData.street || !formData.city) {
            throw new Error('  转  砖转 住 -*');
        }
        
        const response = await fetch(getBackendURL(), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'saveOrder',
                ...formData
            })
        });
        
        if (!response.ok) {
            throw new Error(`砖转 专砖转: ${response.status}`);
        }
        
        let result = await response.json();
        
        // 驻 转转 proxy
        if (result.contents) {
            result = JSON.parse(result.contents);
        }
        
        if (result.status === 'success') {
            showMessage(' 砖专 爪!', 'success');
            closeModal();
            await loadOrders(document.getElementById('datePicker').value);
        } else {
            throw new Error(result.data || '砖 砖专转 ');
        }
        
    } catch (error) {
        console.error('Error saving order:', error);
        showMessage('砖 砖专转 : ' + error.message, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

// 拽转 专
async function testConnection() {
    try {
        const url = getBackendURL('?action=test');
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`砖: ${response.status}`);
        }
        
        let result = await response.json();
        
        // 驻 转转 proxy
        if (result.contents) {
            result = JSON.parse(result.contents);
        }
        
        console.log('Connection test:', result);
        showMessage('拽转 专: ' + (result.status === 'success' ? '爪' : '砖'), 
                   result.status === 'success' ? 'success' : 'error');
        return result;
    } catch (error) {
        console.error('Connection test failed:', error);
        showMessage('拽转 专 砖: ' + error.message, 'error');
        return null;
    }
}

// 转 驻拽爪
async function initializeApp() {
    initializeDate();
    generateTimeSlots();
    
    // 注 转 专砖
    await Promise.all([
        loadCustomers(),
        loadCities()
    ]);
    
    // 注 转 转专 
    await loadOrders(document.getElementById('datePicker').value);
    
    // 专  专注
    setupEventListeners();
    
    showMessage('注专转  砖砖', 'success');
}

function setupEventListeners() {
    // 砖 转专
    document.getElementById('datePicker').addEventListener('change', function() {
        loadOrders(this.value);
    });
    
    // 驻转专  砖
    document.getElementById('addNewOrderBtn').addEventListener('click', () => {
        openNewModal('转', '09:00');
    });
    
    // 驻转专 拽转 专
    document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
    
    // 砖转 驻住
    document.getElementById('createOrderForm').addEventListener('submit', handleFormSubmit);
    
    // 爪 注 转  专拽
    document.querySelectorAll('.timeline').forEach(timeline => {
        timeline.addEventListener('click', (e) => {
            if (e.target.classList.contains('drop-zone') && e.target.children.length === 0) {
                const driver = e.target.dataset.driver === 'hakmat' ? '转' : '注';
                const time = e.target.dataset.time;
                openNewModal(driver, time);
            }
        });
    });
    
    // 驻 拽
    document.getElementById('orderCustomer').addEventListener('change', function() {
        const customer = customersData.find(c => c['砖 拽'] === this.value);
        if (customer) {
            document.getElementById('orderPhone').value = customer['驻'] || '';
            document.getElementById('orderContactName').value = customer['砖 砖 拽砖专'] || '';
        }
    });
}

// 转 转 驻拽爪
initializeApp().catch(error => {
    console.error('Failed to initialize app:', error);
    showMessage('砖 驻注转 注专转: ' + error.message, 'error');
});
</script>
</body>
</html>
