<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注专转  住拽 V3.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f1f5f9; }
        .tab { cursor: pointer; padding: 10px 20px; border-bottom: 4px solid transparent; }
        .tab.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
    </style>
</head>
<body class="text-slate-800">
    <div class="container mx-auto p-4 max-w-screen-2xl">
        <header class="mb-6"><h1 class="text-4xl font-bold text-slate-900">专 拽专 住</h1></header>
        <div class="border-b border-slate-200 mb-6">
            <nav id="tabs-nav" class="flex space-x-4 -mb-px">
                <a data-tab="dashboard" class="tab active"><i class="fa-solid fa-chart-pie mr-2"></i> 拽专</a>
                <a data-tab="orders" class="tab"><i class="fa-solid fa-tasks mr-2"></i> 转</a>
                <a data-tab="planner" class="tab"><i class="fa-solid fa-route mr-2"></i>转 住 </a>
            </nav>
        </div>
        <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4"></div>

        <main>
            <div id="content-dashboard" class="tab-content active"></div>
            <div id="content-orders" class="tab-content"></div>
            <div id="content-planner" class="tab-content"></div>
        </main>
    </div>
    <div id="modal-container"></div>
    
    <script>
        const API_KEY = 'AIzaSyCbVYMijMs8zH6m4iiSiBfn_RiCMuau9ps'; //  PASTE YOUR GOOGLE MAPS API KEY
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwK9U8fx5PbMI4JewoOVoIojhE7VXcM2njTnvVrIqFV_m_up3lkbYfZvPx7MTR6Lz4j8g/exec'; //  PASTE YOUR SCRIPT URL
    </script>
    <script async defer src=`https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initApp&libraries=places`></script>

    <script>
    function initApp() {
        let allOrders = [], initialData = {}, charts = {};
        let plannerMap, newOrderMap, viewMap, directionsService;
        let plannerDR, newOrderDR, viewDR;

        const elements = { nav: document.getElementById('tabs-nav'), errorBanner: document.getElementById('error-banner'), content: { dashboard: document.getElementById('content-dashboard'), orders: document.getElementById('content-orders'), planner: document.getElementById('content-planner'), }, modals: document.getElementById('modal-container'), };
        
        function initialize() {
            renderSkeletons();
            setupEventListeners();
            loadInitialData().then(() => handleTabClick(document.querySelector('.tab.active')));
        }
        
        function renderSkeletons() {
            elements.content.dashboard.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-4 gap-6"><div class="card p-6 col-span-full"><h2 class="text-xl font-semibold">住拽专 转</h2><p>住" 转: <span id="total-orders-stat" class="font-bold text-2xl">...</span></p></div><div class="card p-6 lg:col-span-2"><h2 class="text-xl font-semibold">注专 转</h2><canvas id="cities-chart"></canvas></div><div class="card p-6"><h2 class="text-xl font-semibold">住 </h2><canvas id="types-chart"></canvas></div><div class="card p-6"><h2 class="text-xl font-semibold">拽转 </h2><canvas id="customers-chart"></canvas></div></div>`;
            elements.content.orders.innerHTML = `<div class="grid grid-cols-12 gap-6"><div class="col-span-12 lg:col-span-4 card p-6"><h2 id="form-title" class="text-2xl font-semibold mb-4">爪专转 </h2><form id="order-form" class="space-y-4"></form></div><div class="col-span-12 lg:col-span-8 card p-6"><div id="new-order-map" class="w-full h-64 rounded-lg bg-slate-200 mb-4"></div><h2 class="text-2xl font-semibold mb-4">转 驻转转</h2><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-right text-xs">拽</th><th class="px-6 py-3 text-right text-xs">转转</th><th class="px-6 py-3 text-right text-xs">转专</th><th class="px-6 py-3 text-right text-xs">驻注转</th></tr></thead><tbody id="orders-table-body"></tbody></table></div></div></div>`;
            elements.content.planner.innerHTML = `<div class="grid grid-cols-12 gap-6"><div class="col-span-4 card p-6"><h2 class="text-xl font-semibold mb-4">专 转</h2><div class="space-y-4"><div class="form-group"><label for="planner-date">转专</label><input type="date" id="planner-date"></div><div class="form-group"><label for="planner-warehouse">住</label><select id="planner-warehouse"></select></div><div id="planner-orders-list"></div></div><button id="btn-optimize-route" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg mt-4">砖 住</button></div><div class="col-span-8 card p-4"><div id="planner-map" class="w-full h-[500px] rounded-lg bg-slate-200"></div><div id="planner-summary"></div></div></div>`;
        }

        function setupEventListeners() {
            elements.nav.addEventListener('click', e => { if (e.target.closest('.tab')) handleTabClick(e.target.closest('.tab')); });
        }

        async function loadInitialData() {
            try {
                initialData = await runGAS('getInitialData');
                allOrders = initialData.activeOrders;
            } catch (error) { showError(error.message); }
        }

        function handleTabClick(tab) {
            const tabName = tab.dataset.tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            elements.content[tabName].classList.add('active');

            if (tabName === 'orders' && !newOrderMap) {
                newOrderMap = new google.maps.Map(document.getElementById("new-order-map"), { zoom: 8, center: { lat: 31.7, lng: 35.2 } });
                newOrderDR = new google.maps.DirectionsRenderer({ map: newOrderMap });
                renderOrderManagement();
            } else if (tabName === 'planner' && !plannerMap) {
                plannerMap = new google.maps.Map(document.getElementById("planner-map"), { zoom: 8, center: { lat: 31.7, lng: 35.2 } });
                plannerDR = new google.maps.DirectionsRenderer({ map: plannerMap });
                renderPlanner();
            } else if (tabName === 'dashboard') {
                renderDashboard();
            }
        }
        
        function renderDashboard() { /* ... Chart logic ... */ }
        
        function renderOrderManagement() { 
            const form = document.getElementById('order-form');
            form.innerHTML = `
                <input type="hidden" id="id" name="id">
                <div><label for="customer">拽</label><input type="text" id="customer" name="customer" list="customers-list" class="mt-1 block w-full rounded-md border-gray-300"></div>
                <datalist id="customers-list"></datalist>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="date">转专</label><input type="date" id="date" name="date" class="mt-1 block w-full rounded-md border-gray-300"></div>
                    <div><label for="time">砖注</label><input type="time" id="time" name="time" class="mt-1 block w-full rounded-md border-gray-300"></div>
                </div>
                <div><label for="city">注专</label><select id="city" name="city" class="mt-1 block w-full rounded-md border-gray-300"></select></div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2"><label for="street">专</label><input type="text" id="street" name="street" class="mt-1 block w-full rounded-md border-gray-300"></div>
                    <div><label for="street_number">住驻专</label><input type="text" id="street_number" name="street_number" class="mt-1 block w-full rounded-md border-gray-300"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="delivery_type">住 </label><select id="delivery_type" name="delivery_type" class="mt-1 block w-full rounded-md border-gray-300"></select></div>
                    <div><label for="warehouse">住</label><select id="warehouse" name="warehouse" class="mt-1 block w-full rounded-md border-gray-300"></select></div>
                </div>
                <div><label for="notes">注专转</label><textarea id="notes" name="notes" rows="2" class="mt-1 block w-full rounded-md border-gray-300"></textarea></div>
                <div class="flex gap-4"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">砖专</button><button type="button" id="btn-clear-form" class="w-full bg-slate-200 py-3 rounded-lg">拽</button></div>
            `;
            
            populateSelect(document.getElementById('warehouse'), initialData.warehouses, "专 住");
            populateSelect(document.getElementById('delivery_type'), initialData.deliveryTypes, "专 住");
            populateSelect(document.getElementById('city'), initialData.cities, "专 注专");
            populateDatalist(document.getElementById('customers-list'), initialData.customers.map(c => c.name));
            
            renderOrdersTable();
            form.addEventListener('submit', handleSaveOrder);
            document.getElementById('btn-clear-form').addEventListener('click', clearOrderForm);
        }

        function renderPlanner() { /* ... Planner logic ... */ }

        function renderOrdersTable() {
            const tableBody = document.getElementById('orders-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = allOrders.map(order => `...`).join('');
        }
        
        function runGAS(action, payload) { /* ... Server communication ... */ }
        function showError(message) { /* ... Error display ... */ }

        // --- Initialize the App ---
        directionsService = new google.maps.DirectionsService();
        initialize();
    }
    </script>
</body>
</html>

