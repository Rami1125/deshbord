<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ×¡×™×“×•×¨ ×¢×‘×•×“×”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2C3E50">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/2C3E50/FFFFFF?text=Work&font=sans">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-blue: #0066cc;
            --light-blue: #f0f8ff;
            --white: #ffffff;
            --dark-color: #2C3E50;
            --accent-color: #E74C3C;
            --success-color: #27ae60;
            --warning-color: #f39c12;
        }
        body {
            font-family: 'Assistant', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--dark-color);
        }
        .task-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .task-card:hover {
            transform: translateY(-4px);
        }
        .btn-primary {
            background-color: var(--primary-blue);
        }
        .btn-success {
            background-color: var(--success-color);
        }
        .btn-accent {
            background-color: var(--accent-color);
        }
        #loading-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="text-white">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center hidden">
        <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Screen 0: Login -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="text-center w-full max-w-sm">
            <svg class="w-24 h-24 mx-auto mb-4 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor"><path d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
            <h1 class="text-4xl font-bold mb-2">×¡×™×“×•×¨ ×¢×‘×•×“×”</h1>
            <p class="text-gray-400 mb-8">×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª</p>
            <div class="space-y-4">
                <input id="username" type="text" placeholder="×©× ××©×ª××©" class="w-full bg-gray-700 text-white placeholder-gray-400 px-4 py-3 rounded-lg border-2 border-gray-600 focus:outline-none focus:border-blue-500">
                <input id="password" type="password" placeholder="×¡×™×¡××”" class="w-full bg-gray-700 text-white placeholder-gray-400 px-4 py-3 rounded-lg border-2 border-gray-600 focus:outline-none focus:border-blue-500">
                <button onclick="handleLogin()" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">
                    ×›× ×™×¡×”
                </button>
                <p id="login-error" class="text-red-400 h-4"></p>
            </div>
        </div>
    </div>

    <!-- Screen 1: Driver Selection (Dashboard) -->
    <div id="driver-selection-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
        <!-- Dashboard content here -->
        <div class="text-center w-full max-w-md">
             <h1 class="text-4xl font-bold mb-2">×œ×•×— ×‘×§×¨×”</h1>
            <p class="text-gray-400 mb-8">×‘×—×¨ × ×”×’ ×œ×”×¦×’×ª ×”×¡×™×“×•×¨ ×”×™×•××™</p>
            <div class="space-y-4">
                <button onclick="showSchedule('×—×›××ª')" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300">
                    ×—×›××ª (×× ×•×£)
                </button>
                <button onclick="showSchedule('×¢×œ×™')" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300">
                    ×¢×œ×™ (×¤×¨×™×§×” ×™×“× ×™×ª)
                </button>
                 <button onclick="showSchedule('×× ×•×£')" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300">
                    × ×”×’ ×× ×•×£ × ×•×¡×£
                </button>
            </div>
        </div>
    </div>

    <!-- Screen 2: Schedule View -->
    <div id="schedule-screen" class="hidden min-h-screen flex flex-col">
        <header class="bg-gray-800 p-4 shadow-md sticky top-0 z-10">
             <div class="max-w-4xl mx-auto flex items-center justify-between">
                <button onclick="showScreen('driver-selection-screen')" class="p-2 rounded-md hover:bg-gray-700 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H3"></path></svg>
                </button>
                <div class="text-center">
                    <h2 id="driver-name-header" class="text-xl font-bold"></h2>
                    <p id="date-header" class="text-sm text-gray-400"></p>
                </div>
                <div class="w-10"></div>
            </div>
            <div class="max-w-4xl mx-auto flex items-center justify-between mt-4">
                <button onclick="changeDate(1)" class="w-1/3 bg-gray-700 hover:bg-gray-600 font-semibold py-2 px-4 rounded-r-lg transition">×”×‘× &larr;</button>
                <button onclick="setCurrentDateToToday()" class="w-1/3 btn-primary hover:opacity-90 font-bold py-2 px-4 transition">×”×™×•×</button>
                <button onclick="changeDate(-1)" class="w-1/3 bg-gray-700 hover:bg-gray-600 font-semibold py-2 px-4 rounded-l-lg transition">&rarr; ×”×§×•×“×</button>
            </div>
        </header>
        <main id="task-list" class="flex-grow p-4 space-y-4 max-w-4xl mx-auto w-full"></main>
    </div>
    
    <!-- Floating Action Button to Add Order -->
    <button id="fab-add-order" onclick="openAddOrderModal()" class="hidden fixed bottom-6 left-6 btn-primary text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl font-bold z-20">
        +
    </button>

    <!-- Modal for adding a new order -->
    <div id="add-order-modal" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg p-6 relative">
            <button onclick="closeAddOrderModal()" class="absolute top-4 left-4 text-gray-400 hover:text-white">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4">×”×•×¡×¤×ª ×”×–×× ×” ×—×“×©×”</h2>
            <form id="add-order-form" class="space-y-3">
                <select name="driver" class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg border-2 border-gray-600 focus:outline-none focus:border-blue-500">
                    <option>×—×›××ª</option>
                    <option>×¢×œ×™</option>
                    <option>×× ×•×£</option>
                </select>
                <input type="date" name="date" required class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg border-2 border-gray-600">
                <input type="time" name="time" required class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg border-2 border-gray-600">
                <input type="text" name="customer" placeholder="×œ×§×•×—" required class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg border-2 border-gray-600">
                <input type="text" name="address" placeholder="×›×ª×•×‘×ª" required class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg border-2 border-gray-600">
                 <select name="warehouse" class="w-full bg-gray-700 text-white px-4 py-3 rounded-lg border-2 border-gray-600">
                    <option>××—×¡×Ÿ 4 ×”×—×¨×©</option>
                    <option>××—×¡×Ÿ 1 ×”×ª×œ××™×“</option>
                </select>
                <button type="submit" class="w-full btn-success text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">×©××•×¨ ×•×©×“×¨</button>
            </form>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        // IMPORTANT: Replace this with your actual Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqdk48j2HOBuicBTjg_Hc58wGlx9GMJdCrhALyVCYRCowjAVmsVGJwObc2ILNslsdpAA/exec';

        // --- STATE MANAGEMENT ---
        let appState = {
            isLoggedIn: false,
            currentScreen: 'login-screen',
            currentDriver: null,
            currentDate: new Date(),
            orders: [],
            isLoading: false,
        };

        // --- DOM Elements ---
        const screens = {
            login: document.getElementById('login-screen'),
            driverSelection: document.getElementById('driver-selection-screen'),
            schedule: document.getElementById('schedule-screen'),
        };
        const loadingOverlay = document.getElementById('loading-overlay');
        const driverNameHeader = document.getElementById('driver-name-header');
        const dateHeader = document.getElementById('date-header');
        const taskList = document.getElementById('task-list');
        const fab = document.getElementById('fab-add-order');
        const addOrderModal = document.getElementById('add-order-modal');
        const addOrderForm = document.getElementById('add-order-form');

        // --- MOCK API (SIMULATION) ---
        // This function simulates calls to your Google Apps Script backend.
        // It allows us to build the UI without a live backend.
        // Once your backend is ready, we will replace `mockApiCall` with a real `fetch` call.
        async function mockApiCall(body) {
            console.log("Mock API Call:", body);
            const { action } = body;

            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 500));

            switch (action) {
                case 'getOrders':
                    return {
                        status: 'success',
                        data: [
                            // Using the new data structure with Emojis as keys
                            { id: 1, "ğŸš› × ×”×’:": "×—×›××ª", "ğŸ—“ï¸ ×ª××¨×™×š:": "15/10/2025", "â° ×©×¢×”:": "08:00", "ğŸ“¦ ××—×¡×Ÿ:": "×”×—×¨×©", "ğŸ§¾ ×¡×˜×˜×•×¡:": "×‘×˜×™×¤×•×œâ³", "ğŸ™‹â€â™‚ï¸×œ×§×•×—": "×§×•×‘×™ ×¤×¨×•×¤×™×œ×™×", "ğŸ¯×›×ª×•×‘×ª ××¡×¤×§×”": "××ª×Ÿ" },
                            { id: 2, "ğŸš› × ×”×’:": "×¢×œ×™", "ğŸ—“ï¸ ×ª××¨×™×š:": "15/10/2025", "â° ×©×¢×”:": "09:30", "ğŸ“¦ ××—×¡×Ÿ:": "×”×ª×œ××™×“", "ğŸ§¾ ×¡×˜×˜×•×¡:": "××•×›× ×”âœ”ï¸", "ğŸ™‹â€â™‚ï¸×œ×§×•×—": "×§×“× ×’×œ×¢×“/×”×™×“×™×“", "ğŸ¯×›×ª×•×‘×ª ××¡×¤×§×”": "×›×¤×¨ ×¡×‘×" },
                            { id: 3, "ğŸš› × ×”×’:": "×¢×œ×™", "ğŸ—“ï¸ ×ª××¨×™×š:": "15/10/2025", "â° ×©×¢×”:": "11:00", "ğŸ“¦ ××—×¡×Ÿ:": "×”×ª×œ××™×“", "ğŸ§¾ ×¡×˜×˜×•×¡:": "×‘×˜×™×¤×•×œâ³", "ğŸ™‹â€â™‚ï¸×œ×§×•×—": "×–×‘×•×œ×•×Ÿ-×¢×“×™×¨×Ÿ/×—×“×“", "ğŸ¯×›×ª×•×‘×ª ××¡×¤×§×”": "×‘× ×™ ×“×¨×•×¨" },
                            { id: 4, "ğŸš› × ×”×’:": "×—×›××ª", "ğŸ—“ï¸ ×ª××¨×™×š:": "16/10/2025", "â° ×©×¢×”:": "10:00", "ğŸ“¦ ××—×¡×Ÿ:": "×”×—×¨×©", "ğŸ§¾ ×¡×˜×˜×•×¡:": "××•×›× ×”âœ”ï¸", "ğŸ™‹â€â™‚ï¸×œ×§×•×—": "×œ×§×•×— ×œ×“×•×’××”", "ğŸ¯×›×ª×•×‘×ª ××¡×¤×§×”": "×ª×œ ××‘×™×‘" },
                        ]
                    };
                case 'broadcastOrder':
                     console.log("Broadcasting order:", body.order);
                     return {
                        status: 'success',
                        data: {
                            message: 'Data broadcasted successfully (mock)',
                            broadcastId: `BRC_${Date.now()}`
                        }
                     };
                default:
                    return { status: 'error', message: 'Unknown action' };
            }
        }

        // --- API-FACING FUNCTIONS ---
        async function apiCall(body) {
            setLoading(true);
            try {
                // When you have the real URL, uncomment the fetch and remove the mockApiCall
                /*
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(body),
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error('Network response was not ok.');
                const result = await response.json();
                */
                const result = await mockApiCall(body); // Using the mock for now
                
                if (result.status === 'success') {
                    return result.data;
                } else {
                    throw new Error(result.message || 'API Error');
                }
            } catch (error) {
                console.error("API Call failed:", error);
                alert(`×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª: ${error.message}`);
                return null;
            } finally {
                setLoading(false);
            }
        }

        // --- UI & LOGIC FUNCTIONS ---
        function setLoading(isLoading) {
            appState.isLoading = isLoading;
            if (isLoading) {
                loadingOverlay.classList.remove('hidden');
            } else {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if(screens[screenId]) {
                 screens[screenId].classList.remove('hidden');
            } else {
                // Fallback for dynamically named screens
                 document.getElementById(screenId).classList.remove('hidden');
            }
            appState.currentScreen = screenId;

            // Show FAB only on schedule and dashboard screens
            if (screenId === 'schedule-screen' || screenId === 'driver-selection-screen') {
                fab.classList.remove('hidden');
            } else {
                fab.classList.add('hidden');
            }
        }

        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');
            
            // IMPORTANT: This is a simple, insecure, client-side login for demonstration only.
            // In a real application, authentication should be handled on the server.
            if (username === '×¡×™×“×•×¨' && password === '×¡×‘×Ÿ') {
                appState.isLoggedIn = true;
                errorEl.textContent = '';
                showScreen('driverSelection');
            } else {
                errorEl.textContent = '×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×';
            }
        }
        
        function formatToDDMMYYYY(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        async function renderSchedule() {
            if (!appState.currentDriver) return;

            driverNameHeader.textContent = `×¡×™×“×•×¨ ×œ× ×”×’: ${appState.currentDriver}`;
            dateHeader.textContent = appState.currentDate.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // In a real scenario, we would fetch data for the specific date.
            // For this mock, we fetch all data and then filter it.
            const allOrders = await apiCall({ action: 'getOrders' });
            if (!allOrders) return;

            const currentDateStr = formatToDDMMYYYY(appState.currentDate);
            const filteredTasks = allOrders.filter(task => {
                const driverKey = "ğŸš› × ×”×’:";
                const dateKey = "ğŸ—“ï¸ ×ª××¨×™×š:";
                return task[driverKey] === appState.currentDriver && task[dateKey] === currentDateStr;
            });
            
            filteredTasks.sort((a, b) => a["â° ×©×¢×”:"].localeCompare(b["â° ×©×¢×”:"]));

            taskList.innerHTML = '';
            if (filteredTasks.length === 0) {
                taskList.innerHTML = `<div class="text-center py-16 px-4 text-gray-400">××™×Ÿ ××©×™××•×ª ×œ×”×¦×’×” ×‘×ª××¨×™×š ×–×”.</div>`;
            } else {
                filteredTasks.forEach(task => {
                    const status = task["ğŸ§¾ ×¡×˜×˜×•×¡:"];
                    const statusColor = status.includes('××•×›× ×”') ? 'border-green-500' : 'border-yellow-500';
                    const taskCard = document.createElement('div');
                    taskCard.className = `task-card bg-gray-800 p-5 rounded-xl shadow-lg border-r-4 ${statusColor}`;
                    taskCard.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="text-2xl font-bold text-indigo-400">${task["â° ×©×¢×”:"]}</div>
                                <div>
                                    <h3 class="text-lg font-semibold">${task["ğŸ™‹â€â™‚ï¸×œ×§×•×—"]}</h3>
                                    <p class="text-gray-400">${task["ğŸ¯×›×ª×•×‘×ª ××¡×¤×§×”"]}</p>
                                </div>
                            </div>
                            <div class="text-sm font-medium">${status}</div>
                        </div>
                    `;
                    taskList.appendChild(taskCard);
                });
            }
        }

        async function showSchedule(driverName) {
            appState.currentDriver = driverName;
            await setCurrentDateToToday();
            showScreen('schedule');
        }

        async function setCurrentDateToToday() {
            appState.currentDate = new Date();
            // For demo, set to a date with data
            appState.currentDate = new Date('2025-10-15');
            await renderSchedule();
        }

        async function changeDate(days) {
            appState.currentDate.setDate(appState.currentDate.getDate() + days);
            await renderSchedule();
        }

        function openAddOrderModal() {
            const dateInput = addOrderForm.querySelector('input[name="date"]');
            const timeInput = addOrderForm.querySelector('input[name="time"]');
            
            // Pre-fill with current date and time
            const now = new Date();
            dateInput.value = now.toISOString().split('T')[0];
            timeInput.value = now.toTimeString().split(' ')[0].substring(0, 5);
            
            addOrderModal.classList.remove('hidden');
        }
        
        function closeAddOrderModal() {
            addOrderModal.classList.add('hidden');
        }
        
        addOrderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(addOrderForm);
            const order = {
                driver: formData.get('driver'),
                date: formData.get('date').split('-').reverse().join('/'), // Format to DD/MM/YYYY
                time: formData.get('time'),
                warehouse: formData.get('warehouse'),
                status: "×‘×˜×™×¤×•×œâ³", // Default status
                customer: formData.get('customer'),
                address: formData.get('address'),
                broadcastTo: ['orders', 'morning', formData.get('driver').toLowerCase()]
            };
            
            const result = await apiCall({ action: 'broadcastOrder', order: order });
            
            if (result) {
                alert(`×”×–×× ×” ×©×•×“×¨×” ×‘×”×¦×œ×—×”! ID: ${result.broadcastId}`);
                closeAddOrderModal();
                // If the new order is for the currently viewed schedule, refresh it
                if (order.driver === appState.currentDriver && order.date === formatToDDMMYYYY(appState.currentDate)) {
                    await renderSchedule();
                }
            }
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('login');
        });

    </script>
</body>
</html>

