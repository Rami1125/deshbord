<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注专转  住拽 V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f1f5f9; }
        .tab { cursor: pointer; padding: 10px 20px; border-bottom: 4px solid transparent; transition: all 0.2s; }
        .tab.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .table-action-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; }
    </style>
</head>
<body class="text-slate-800">
    <div class="container mx-auto p-4 max-w-screen-2xl">
        <header class="mb-6"><h1 class="text-4xl font-bold text-slate-900">专 拽专 住</h1></header>
        <div class="border-b border-slate-200 mb-6">
            <nav id="tabs-nav" class="flex space-x-4 -mb-px" aria-label="Tabs">
                <a data-tab="dashboard" class="tab active"><i class="fa-solid fa-chart-pie mr-2"></i> 拽专</a>
                <a data-tab="orders" class="tab"><i class="fa-solid fa-tasks mr-2"></i> 转</a>
                <a data-tab="planner" class="tab"><i class="fa-solid fa-route mr-2"></i>转 住 </a>
            </nav>
        </div>
        <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert"></div>

        <div id="content-dashboard" class="tab-content active">...</div>
        <div id="content-orders" class="tab-content">...</div>
        <div id="content-planner" class="tab-content">...</div>
    </div>

    <!-- Modals and Templates can be defined here -->
    <div id="view-modal" class="modal-overlay hidden"> ... </div>
    <div id="archive-modal" class="modal-overlay hidden"> ... </div>
    
    <!-- SCRIPT SECTION -->
    <script>
        // =================================================================
        // ==  IMPORTANT: PASTE YOUR KEYS HERE                          ==
        // =================================================================
        
        // This is your Google Maps API Key. It should start with "AIza..."
        const API_KEY = 'AIzaSyCbVYMijMs8zH6m4iiSiBfn_RiCMuau9ps'; //  PASTE YOUR GOOGLE MAPS API KEY
        
        // This is your Apps Script deployment URL.
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyu1p19fHqnQQRWJw9o5UI5mnCJ_-S3p934dTAN80_qRnLonlJ-AinhyjYR3WutzkOH/exec'; //  PASTE YOUR SCRIPT URL
        
        // =================================================================
    </script>
    <script>
        // This loads the Google Maps script dynamically AFTER the keys are defined
        (function() {
            if (typeof google === 'object' && typeof google.maps === 'object') {
                window.initMaps();
            } else {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&callback=initMaps&libraries=places`;
                script.async = true;
                script.defer = true;
                document.head.appendChild(script);
            }
        })();
    </script>
    
    <script>
        // The main application logic will be wrapped in the initMaps function
        // to ensure Google Maps is loaded first.
        window.initMaps = function() {
            
            let allOrders = [];
            let initialData = {};
            let charts = {};
            let plannerMap, newOrderMap, directionsService, plannerDirectionsRenderer, newOrderDirectionsRenderer;

            // All your application functions (setupEventListeners, loadInitialData, renderOrdersTable, etc.)
            // will now be defined *inside* this initMaps function.
            
            function setupEventListeners() {
                document.getElementById('tabs-nav').addEventListener('click', (e) => {
                    if (e.target.matches('.tab')) {
                        handleTabClick(e.target);
                    }
                });
                document.getElementById('order-form').addEventListener('submit', handleSaveOrder);
                // ... all other event listeners
            }
            
            function handleTabClick(clickedTab) {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                clickedTab.classList.add('active');
                const tabName = clickedTab.dataset.tab;
                const contentEl = document.getElementById(`content-${tabName}`);
                if(contentEl) contentEl.classList.add('active');
                
                if (tabName === 'dashboard') {
                    loadDashboardData();
                }
            }
            
            // ... the rest of the JavaScript logic from the previous turn goes here ...
            // (loadInitialData, renderOrdersTable, handleSaveOrder, handleEdit, etc.)
            
            // Initialize maps
            const centerOfIsrael = { lat: 31.7, lng: 35.2 };
            plannerMap = new google.maps.Map(document.getElementById("planner-map") || document.createElement('div'), { zoom: 8, center: centerOfIsrael });
            newOrderMap = new google.maps.Map(document.getElementById("new-order-map") || document.createElement('div'), { zoom: 8, center: centerOfIsrael });
            directionsService = new google.maps.DirectionsService();
            plannerDirectionsRenderer = new google.maps.DirectionsRenderer({ map: plannerMap });
            newOrderDirectionsRenderer = new google.maps.DirectionsRenderer({ map: newOrderMap });

            // Start the app
            setupEventListeners();
            loadInitialData();
            handleTabClick(document.querySelector('.tab.active'));
        }
    </script>
</body>
</html>

