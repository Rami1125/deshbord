<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“‹ ×“×•×— ×‘×•×§×¨ - ×¡×™×“×•×¨ ×¢×‘×•×“×”</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Google Maps JavaScript API loading -->
    <!-- Replace 'YOUR_GOOGLE_MAPS_JAVASCRIPT_API_KEY' with your actual API Key -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_JAVASCRIPT_API_KEY&libraries=places&callback=initMapLibraries"></script>

    <style>
        /* General styling for the application */
        :root {
            --primary-color: #3498db; /* Blue */
            --secondary-color: #2ecc71; /* Green */
            --dark-color: #2c3e50; /* Dark blue-gray */
            --light-color: #ecf0f1; /* Light gray */
            --accent-color: #e74c3c; /* Red */
            --text-color: #333; /* Dark text */
            --shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Enhanced shadow */
            --card-bg: rgba(255, 255, 255, 0.98); /* Less transparent white for cards */
            --modal-bg: rgba(255, 255, 255, 0.98); /* Near opaque white for modals */
            --overlay-bg: rgba(0, 0, 0, 0.7); /* Darker overlay for modals */
        }
        
        body {
            font-family: 'Rubik', Arial, sans-serif;
            text-align: center;
            direction: rtl; /* Right-to-left for Hebrew */
            background-color: #f0f2f5; /* Light background for app feel */
            background-image: url('https://i.postimg.cc/mD2FXJ7B/Whats-App-Image-2025-06-23-at-8-07-26-AM.jpg'); /* User provided background image */
            background-size: cover; /* Cover the entire background */
            background-position: center;
            background-attachment: fixed; /* Keep background fixed when scrolling */
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column; /* For sticky footer/bottom content */
        }

        /* Main container for app content - wider for grid layout */
        .container {
            max-width: 1100px; /* Wider to accommodate two columns */
            margin: 20px auto;
            padding: 0 20px; /* Increased padding */
            flex-grow: 1; /* Allows container to grow and push footer/bottom elements down */
        }
        
        /* Header styling with gradient and clock/date */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px 0; /* More padding for a bolder header */
            border-radius: 0 0 40px 40px; /* More pronounced border-radius */
            box-shadow: var(--shadow);
            margin-bottom: 40px; /* More margin */
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 140px; /* Ensure a minimum height for the header */
        }
        
        .header-content {
            position: relative;
            z-index: 1; /* Ensure content is above any background effects */
            padding: 0 20px;
            width: 100%;
        }
        
        .datetime {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px; /* Increased gap */
            margin-bottom: 20px; /* More margin */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        
        .time {
            font-size: 3.5rem; /* Even larger time font */
            font-weight: 700;
            text-shadow: 0 3px 5px rgba(0, 0, 0, 0.3); /* Stronger text shadow */
        }
        
        .date {
            font-size: 2rem; /* Even larger date font */
            font-weight: 500;
            text-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            margin: 0;
            font-size: 3rem; /* Larger main title */
            font-weight: 700;
            text-shadow: 0 4px 7px rgba(0, 0, 0, 0.4); /* Stronger shadow */
        }
        
        /* WhatsApp Share Button styling */
        .share-button, .add-order-button {
            background-color: #25D366; /* WhatsApp green */
            color: white;
            padding: 20px 35px; /* More padding for a bigger button */
            font-size: 22px; /* Larger font */
            font-weight: bold;
            border: none;
            border-radius: 60px; /* More pill-shaped */
            cursor: pointer;
            margin: 50px 10px 40px 10px; /* More margin, adjusted for two buttons */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px; /* Increased gap */
            width: 90%;
            max-width: 350px; /* Max width for button */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); /* Deeper shadow */
            transition: all 0.3s ease;
            text-decoration: none; /* Remove underline from link if used */
            position: relative; /* For shine effect */
            overflow: hidden; /* For shine effect */
        }

        .add-order-button {
            background: linear-gradient(135deg, #FF9900, #FFCC66); /* Orange/Yellow gradient for add order */
        }

        .share-button:hover {
            transform: translateY(-5px); /* More pronounced lift effect on hover */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4); /* Even deeper shadow */
            background-color: #128C7E; /* Darker green on hover */
        }
        .add-order-button:hover {
            transform: translateY(-5px); /* More pronounced lift effect on hover */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4); /* Even deeper shadow */
            background: linear-gradient(135deg, #E68A00, #E0B354); /* Darker orange on hover */
        }

        /* Shine effect for buttons */
        .share-button::before, .add-order-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -75%;
            width: 50%;
            height: 100%;
            background: rgba(255, 255, 255, 0.4); /* White shimmer */
            transform: skewX(-20deg);
            transition: left 0.5s ease-in-out;
        }

        .share-button:hover::before, .add-order-button:hover::before {
            left: 125%;
        }

        .main-buttons-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 20px; /* Space between buttons */
            margin-bottom: 40px;
        }

        /* Section title for each driver */
        .driver-section-title {
            font-size: 32px; /* Larger title for driver sections */
            font-weight: 700;
            margin: 50px 0 35px; /* More spacing */
            color: var(--dark-color);
            display: flex; /* Use flexbox to align title and button */
            justify-content: center; /* Center the content */
            align-items: center; /* Align items vertically */
            gap: 20px; /* Space between title and button */
            padding: 10px 30px;
            border-radius: 60px;
            background-color: var(--light-color); /* Light background for the title */
            box-shadow: var(--shadow);
            position: relative;
            z-index: 2; /* Ensure title is above timeline elements */
            border: 3px solid var(--primary-color); /* Thicker border to highlight */
            overflow: hidden; /* For shine effect */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        
        .driver-section-title::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: skewX(-20deg);
            transition: left 0.7s ease;
        }

        .driver-section-title:hover::before {
            left: 100%;
        }

        /* AI Summary Button */
        .ai-summary-button {
            background: linear-gradient(45deg, #FF6B6B, #FFCD6B); /* Warm, energetic gradient */
            color: white;
            padding: 10px 20px;
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap; /* Prevent text wrapping */
        }

        .ai-summary-button:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #FF8E8E, #FFDA8E); /* Lighter gradient on hover */
        }


        /* Styling for the timeline effect - now a grid container for two columns */
        .timeline-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); /* Two columns on larger screens, single on smaller */
            gap: 40px; /* Increased space between cards */
            padding: 20px 0;
            margin: 0 auto;
            width: 100%; /* Expand to full width of container */
            max-width: 100%; /* Ensure it takes full width */
            justify-content: center; /* Center items in the grid */
            align-items: start; /* Align items to the start of their grid area */
        }

        /* Individual order "cube" styling */
        .order-card {
            background: var(--card-bg);
            border-radius: 25px; /* Even larger rounded corners */
            box-shadow: var(--shadow);
            padding: 30px; /* Increased padding for larger box */
            margin-bottom: 0; /* No bottom margin, gap handles spacing */
            text-align: right;
            position: relative;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, border-color 0.3s ease;
            border-left: 8px solid var(--primary-color); /* Thicker accent border for orders */
            display: flex;
            flex-direction: column;
            gap: 15px; /* Increased gap between elements */
            overflow: hidden; /* For shine effect */
            animation: fadeIn 0.8s ease-out forwards; /* Fade in animation */
            cursor: pointer; /* Indicate clickable */
            z-index: 1; /* Ensure cards are above timeline effects */
        }

        .order-card:hover {
            transform: translateY(-10px); /* More pronounced lift effect on hover */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.35); /* Deeper shadow on hover */
            border-color: var(--accent-color); /* Change border color on hover */
        }

        /* Shine effect for order cards */
        .order-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 0%;
            height: 200%;
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(45deg);
            transition: all 0.7s ease;
            opacity: 0;
            z-index: 0; /* Ensure it's behind content */
        }

        .order-card:hover::before {
            left: 100%;
            opacity: 1;
        }

        /* Timeline arrow styling - adjusted for grid layout, now a more decorative element */
        .order-arrow {
            position: absolute;
            right: -20px; /* Position to the right of the card */
            top: 50%;
            transform: translateY(-50%) rotate(0deg); /* No rotation, just pointing right */
            width: 0;
            height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-left: 15px solid var(--secondary-color); /* Green arrow */
            z-index: 2; /* Ensure arrow is on top of card but behind shine */
        }

        /* Specific styling for the content within the order card */
        .order-time {
            font-size: 2rem; /* Larger time font */
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 12px; /* Increased gap */
            margin-bottom: 20px; /* More space below time */
            border-bottom: 2px dashed rgba(0, 0, 0, 0.1); /* Thicker separator line */
            padding-bottom: 15px;
        }

        .order-time i {
            color: var(--accent-color); /* Clock icon color */
            font-size: 1.8rem; /* Make icon slightly smaller than text */
        }

        .order-details p {
            margin: 8px 0; /* More spacing */
            font-size: 1.3rem; /* Larger detail font */
            color: var(--text-color);
            display: flex;
            align-items: flex-start; /* Align text to top */
            gap: 12px; /* Increased gap */
        }

        .order-details p strong {
            color: var(--dark-color);
            font-weight: 600; /* Slightly bolder */
            min-width: 90px; /* Align content */
            text-align: left;
        }

        .order-details i {
            color: var(--secondary-color); /* Icon color for details */
            font-size: 1.2rem; /* Make icon slightly smaller than text */
            margin-top: 4px; /* Adjust icon vertical alignment */
        }

        /* Changed to <a> tag for clickability */
        .order-details p .city-link {
            text-decoration: underline;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 700; /* Made bolder */
            transition: color 0.2s ease, text-shadow 0.2s ease;
            position: relative; /* For text effects */
            overflow: hidden;
            display: inline-block; /* Essential for text overflow and effects */
            padding-right: 5px; /* Little space from icon */
            text-shadow: 0 0 5px rgba(52, 152, 219, 0.3); /* Subtle glow */
            animation: sparkle 2s infinite alternate; /* Add sparkle animation */
        }

        .order-details p .city-link:hover {
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.5); /* Stronger glow on hover */
        }

        /* Keyframe animation for sparkle effect */
        @keyframes sparkle {
            0% { text-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
            50% { text-shadow: 0 0 15px rgba(52, 152, 219, 0.8), 0 0 20px rgba(52, 152, 219, 0.4); }
            100% { text-shadow: 0 0 5px rgba(52, 152, 219, 0.3); }
        }

        /* Modal styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--modal-bg);
            padding: 35px; /* More padding */
            border-radius: 25px; /* Larger radius */
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4); /* Deeper shadow */
            max-width: 550px; /* Slightly wider */
            width: 90%;
            position: relative;
            transform: translateY(30px); /* More pronounced slide-in */
            transition: transform 0.3s ease;
            text-align: right;
            border: 3px solid var(--primary-color); /* Thicker border */
            display: flex;
            flex-direction: column;
            gap: 20px; /* More gap */
        }

        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--dark-color);
            font-size: 2.5rem; /* Larger title */
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 12px;
            margin-bottom: 25px;
        }

        .modal-content p {
            margin: 10px 0;
            font-size: 1.4rem; /* Larger text */
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal-content p strong {
            color: var(--dark-color);
            font-weight: 600;
            min-width: 90px; /* Align content */
        }

        .modal-close-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px; /* Larger close button */
            height: 40px;
            font-size: 1.8rem; /* Larger font */
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .modal-close-button:hover {
            background-color: #c0392b;
            transform: rotate(90deg) scale(1.1); /* Rotate and scale on hover */
        }

        /* City Map Modal specific styling */
        #cityMapModal .modal-content {
            max-width: 800px; /* Even wider for map */
            height: 600px; /* Larger fixed height for the map view */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to start */
            align-items: center;
            text-align: center;
            padding-top: 25px; /* Adjust padding due to new header */
        }

        #cityMapModal .modal-content h2 {
            font-size: 2.5rem;
            border-bottom: none;
            margin-bottom: 15px; /* Space above map */
        }

        #mapContainer {
            width: 95%; /* Take more width */
            height: 400px; /* Larger map area */
            background-color: #e0e0e0;
            border-radius: 15px; /* Larger radius */
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.15); /* Deeper inset shadow */
            border: 2px solid rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative; /* For Street View panorama */
        }

        #streetViewPanorama {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            z-index: 2; /* Above map */
            display: none; /* Hidden by default */
        }

        #mapControls {
            margin-top: 15px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        #mapControls button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #mapControls button:hover {
            background-color: var(--dark-color);
            transform: translateY(-2px);
        }

        #mapControls button.active {
            background-color: var(--secondary-color);
        }

        /* Password Modal Styling */
        #passwordModal .modal-content {
            max-width: 400px;
            gap: 15px;
            text-align: center;
        }

        #passwordModal .modal-content h2 {
            font-size: 2rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
        }

        #passwordModal input[type="password"] {
            width: calc(100% - 20px); /* Adjust width for padding */
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            font-size: 1.3rem;
            text-align: center;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #passwordModal input[type="password"]:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.4);
        }

        #passwordModal button {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.4rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            width: 100%; /* Full width button */
            max-width: 250px; /* Limit max width */
            margin: 0 auto;
        }

        #passwordModal button:hover {
            background-color: var(--dark-color);
            transform: translateY(-2px);
        }

        #passwordError {
            font-size: 1.1rem;
            margin-top: 10px;
            padding: 5px;
            background-color: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
        }

        /* Daily Summary Modal Styling - Now for general AI interaction */
        #aiInteractionModal .modal-content {
            max-width: 600px;
            text-align: right;
        }

        #aiInteractionModal pre,
        #aiInteractionModal textarea { /* Apply to pre and textarea */
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            font-size: 1.1rem;
            line-height: 1.6;
            text-align: right;
            width: calc(100% - 30px); /* Adjust for padding */
            box-sizing: border-box; /* Include padding in width */
            resize: vertical; /* Allow vertical resizing */
        }
        
        #aiInteractionModal .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AI Customer Message Button */
        .ai-customer-message-button {
            background: linear-gradient(90deg, #6BFF6B, #6BBFFF); /* Green-blue gradient */
            color: white;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center; /* Center content */
            gap: 8px;
            white-space: nowrap;
            margin-top: 20px; /* Space from other modal content */
            width: fit-content; /* Adjust width to content */
            margin-right: auto; /* Push to the right (rtl) */
            margin-left: auto;
        }

        .ai-customer-message-button:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            background: linear-gradient(90deg, #8EFF8E, #8ECFFF); /* Lighter gradient on hover */
        }

        /* AI Copy Button */
        .ai-copy-button {
            background-color: var(--secondary-color); /* Green */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 15px;
            transition: background-color 0.2s ease;
            display: block; /* Make it a block element */
            width: fit-content; /* Fit content */
            margin-right: auto; /* Align to center */
            margin-left: auto; /* Align to center */
        }

        .ai-copy-button:hover {
            background-color: #28a745; /* Darker green */
        }

        /* Add Order Modal Styling */
        #addOrderModal .modal-content {
            max-width: 600px;
            text-align: right;
        }
        #addOrderModal form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #addOrderModal label {
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 5px;
            display: block; /* Ensures label takes full width */
        }
        #addOrderModal input[type="text"],
        #addOrderModal input[type="time"],
        #addOrderModal input[type="date"],
        #addOrderModal select {
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            direction: rtl; /* For Hebrew input */
            text-align: right;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        #addOrderModal input[type="text"]:focus,
        #addOrderModal input[type="time"]:focus,
        #addOrderModal input[type="date"]:focus,
        #addOrderModal select:focus {
            border-color: var(--primary-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 0 8px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        #addOrderModal button[type="submit"] {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.4rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            margin-top: 20px;
        }
        #addOrderModal button[type="submit"]:hover {
            background-color: #28a745;
            transform: translateY(-2px);
        }
        
        /* Stats and Charts Section */
        .stats-and-charts {
            background-color: var(--card-bg);
            border-radius: 25px;
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 40px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .stats-summary {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            text-align: center;
        }

        .stat-item {
            background-color: var(--light-color);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 180px; /* Ensure items don't get too small */
            transition: transform 0.2s ease;
        }

        .stat-item:hover {
            transform: translateY(-5px);
        }

        .stat-item h3 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-item p {
            font-size: 1.1rem;
            color: var(--text-color);
            margin: 0;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .chart-box {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-box h3 {
            font-size: 1.5rem;
            color: var(--dark-color);
            margin-top: 0;
            margin-bottom: 15px;
        }

        /* Refresh Button for Stats/Charts */
        .refresh-stats-button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            margin-top: 20px;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .refresh-stats-button:hover {
            background-color: var(--dark-color);
            transform: translateY(-2px);
        }

        /* Horizontal Timeline */
        .horizontal-timeline-container {
            background-color: var(--card-bg);
            border-radius: 25px;
            box-shadow: var(--shadow);
            padding: 25px 20px;
            margin-bottom: 40px;
            overflow-x: auto; /* Allow horizontal scrolling if content overflows */
            direction: ltr; /* Force LTR for the timeline axis */
            position: relative;
            min-height: 150px; /* Ensure space for pins */
            display: flex;
            align-items: center; /* Vertically center the line */
        }

        .timeline-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            transform: translateY(-50%);
            z-index: 0;
        }

        .timeline-pin {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%); /* Center pin on the line */
            width: 30px;
            height: 30px;
            background-color: white;
            border: 3px solid var(--accent-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .timeline-pin:hover {
            transform: translate(-50%, -65%) scale(1.1); /* Lift and scale on hover */
            border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 2; /* Bring to front on hover */
        }

        .pin-info {
            position: absolute;
            background-color: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            padding: 15px;
            white-space: nowrap;
            font-size: 0.9rem;
            text-align: right;
            box-shadow: var(--shadow);
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(-10px); /* Initial offset for animation */
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            z-index: 10; /* Above all other elements */
            top: -100px; /* Position above the pin */
            left: 50%;
            direction: rtl; /* Ensure Hebrew text is right-to-left */
        }

        .timeline-pin:hover .pin-info {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-110px); /* Final position above the pin */
        }

        .pin-info p {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pin-info p i {
            color: var(--secondary-color);
        }
        .pin-info p .driver-icon {
            color: var(--accent-color);
        }

        /* Responsive adjustments for timeline */
        @media (max-width: 768px) {
            .horizontal-timeline-container {
                padding: 15px 10px;
                min-height: 120px;
            }
            .timeline-pin {
                width: 25px;
                height: 25px;
                font-size: 1rem;
                border-width: 2px;
            }
            .timeline-pin:hover {
                transform: translate(-50%, -60%) scale(1.08);
            }
            .pin-info {
                font-size: 0.8rem;
                padding: 10px;
                top: -80px; /* Adjust vertical position */
            }
            .timeline-pin:hover .pin-info {
                 transform: translateX(-50%) translateY(-90px);
            }
        }
        @media (max-width: 480px) {
            .horizontal-timeline-container {
                padding: 10px 5px;
                min-height: 100px;
            }
            .timeline-pin {
                width: 20px;
                height: 20px;
                font-size: 0.9rem;
                border-width: 2px;
            }
            .timeline-pin:hover {
                transform: translate(-50%, -55%) scale(1.05);
            }
            .pin-info {
                font-size: 0.75rem;
                padding: 8px;
                top: -70px; /* Adjust vertical position */
            }
            .timeline-pin:hover .pin-info {
                 transform: translateX(-50%) translateY(-80px);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="datetime">
                <div class="time" id="currentDate"></div> <!-- Swapped for Hebrew display -->
                <div class="date" id="currentTime"></div> <!-- Swapped for Hebrew display -->
            </div>
            <h1>ğŸš› ×“×•×— ×‘×•×§×¨ - ×¡×™×“×•×¨ ×”×•×‘×œ×•×ª</h1>
        </div>
    </div>

    <div class="container">
        <!-- Stats and Charts Section -->
        <div class="stats-and-charts">
            <h2 style="color: var(--dark-color); margin-bottom: 20px;">ğŸ“Š ×¡×™×›×•× ×•×”×–×× ×•×ª</h2>
            <div class="stats-summary">
                <div class="stat-item">
                    <h3><span id="totalOrdersCount">0</span></h3>
                    <p>×¡×”"×› ×”×–×× ×•×ª</p>
                </div>
                <div class="stat-item">
                    <h3><span id="morningOrdersCount">0</span></h3>
                    <p>×”×–×× ×•×ª 06:00-09:00</p>
                </div>
                <!-- Warehouse counts will be dynamically added here -->
            </div>
            <div class="charts-container">
                <div class="chart-box">
                    <h3>×”×–×× ×•×ª ×œ×¤×™ ××—×¡×Ÿ</h3>
                    <canvas id="warehouseChart"></canvas>
                </div>
                <div class="chart-box">
                    <h3>×”×–×× ×•×ª ×‘×•×§×¨</h3>
                    <canvas id="morningOrdersChart"></canvas>
                </div>
            </div>
            <button class="refresh-stats-button" onclick="updateAllStatsAndCharts()">×¨×¢× ×Ÿ × ×ª×•× ×™× ×•×’×¨×¤×™×</button>
        </div>

        <!-- Horizontal Timeline Section -->
        <div class="horizontal-timeline-container" id="horizontalTimeline">
             <div class="timeline-line"></div>
             <!-- Timeline pins will be dynamically inserted here -->
        </div>

        <!-- Driver Ali's section -->
        <div class="driver-section-title" id="aliSectionTitle">
            <span>× ×”×’: ×¢×œ×™</span>
            <button class="ai-summary-button" onclick="showDailySummary('×¢×œ×™')">âœ¨ ×¡×™×›×•× ×™×•××™ ×œ× ×”×’</button>
        </div>
        <div id="aliTimeline" class="timeline-grid">
            <!-- Orders for Ali will be dynamically inserted here -->
        </div>

        <!-- Driver Hakmat's section -->
        <div class="driver-section-title" id="hakmatSectionTitle">
            <span>× ×”×’: ×—×›××ª</span>
            <button class="ai-summary-button" onclick="showDailySummary('×—×›××ª')">âœ¨ ×¡×™×›×•× ×™×•××™ ×œ× ×”×’</button>
        </div>
        <div id="hakmatTimeline" class="timeline-grid">
            <!-- Orders for Hakmat will be dynamically inserted here -->
        </div>

        <!-- Main action buttons -->
        <div class="main-buttons-container">
            <button class="share-button" onclick="showPasswordModal()">
                <i class="fab fa-whatsapp"></i> ×©×ª×£ ×œ×•×•×¦××¤
            </button>
            <button class="add-order-button" onclick="showAddOrderModal()">
                <i class="fas fa-plus-circle"></i> ×”×•×¡×£ ×”×–×× ×”
            </button>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('orderDetailsModal')">&times;</button>
            <h2 id="modalTitle">×¤×¨×˜×™ ×”×–×× ×” ××œ××™×</h2>
            <p><strong><i class="far fa-calendar-alt"></i> ×ª××¨×™×š:</strong> <span id="modalDate"></span></p>
            <p><strong><i class="far fa-clock"></i> ×©×¢×”:</strong> <span id="modalTime"></span></p>
            <p><strong><i class="fas fa-user"></i> ×œ×§×•×—:</strong> <span id="modalCustomer"></span></p>
            <p><strong><i class="fas fa-map-marker-alt"></i> ×›×ª×•×‘×ª:</strong> <span id="modalAddress"></span></p>
            <p><strong><i class="fas fa-warehouse"></i> ××—×¡×Ÿ:</strong> <span id="modalWarehouse"></span></p>
            <p><strong><i class="fas fa-info-circle"></i> ×¡×˜×˜×•×¡:</strong> <span id="modalStatus"></span></p>
            <button class="ai-customer-message-button" onclick="generateAndShowCustomerMessage(this.dataset.order)">
                <i class="fas fa-magic"></i> âœ¨ ×¦×•×¨ ×”×•×“×¢×” ×œ×œ×§×•×—
            </button>
        </div>
    </div>

    <!-- City Map Modal -->
    <div id="cityMapModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('cityMapModal')">&times;</button>
            <h2 id="cityModalTitle">××¤×”</h2>
            <div id="mapContainer">
                <!-- Google Map will be rendered here -->
            </div>
            <div id="streetViewPanorama">
                <!-- Street View Panorama will be rendered here -->
            </div>
            <div id="mapControls">
                <button onclick="toggleStreetView()"><i class="fas fa-street-view"></i> Street View</button>
                <button onclick="openInGoogleMaps()"><i class="fas fa-map-marked-alt"></i> ×¤×ª×— ×‘××¤×•×ª Google</button>
            </div>
        </div>
    </div>

    <!-- Add Order Modal -->
    <div id="addOrderModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('addOrderModal')">&times;</button>
            <h2>×”×•×¡×£ ×”×–×× ×” ×—×“×©×”</h2>
            <form id="addOrderForm">
                <label for="orderDate">×ª××¨×™×š:</label>
                <input type="date" id="orderDate" required>

                <label for="orderTime">×©×¢×”:</label>
                <input type="time" id="orderTime" required>

                <label for="orderCustomer">×œ×§×•×—:</label>
                <input type="text" id="orderCustomer" placeholder="×©× ×”×œ×§×•×—" required>

                <label for="orderAddress">×›×ª×•×‘×ª:</label>
                <input type="text" id="orderAddress" placeholder="×¨×—×•×‘, ××¡×¤×¨, ×¢×™×¨" required>

                <label for="orderWarehouse">××—×¡×Ÿ:</label>
                <input type="text" id="orderWarehouse" placeholder="×©× ×”××—×¡×Ÿ" required>

                <label for="orderStatus">×¡×˜×˜×•×¡:</label>
                <select id="orderStatus" required>
                    <option value="">×‘×—×¨ ×¡×˜×˜×•×¡</option>
                    <option value="×××ª×™×Ÿ">×××ª×™×Ÿ</option>
                    <option value="×‘×“×¨×š">×‘×“×¨×š</option>
                    <option value="×‘×•×¦×¢">×‘×•×¦×¢</option>
                    <option value="× ×“×—×”">× ×“×—×”</option>
                </select>

                <label for="orderDriver">× ×”×’:</label>
                <select id="orderDriver" required>
                    <option value="">×‘×—×¨ × ×”×’</option>
                    <option value="×¢×œ×™">×¢×œ×™</option>
                    <option value="×—×›××ª">×—×›××ª</option>
                </select>
                
                <button type="submit">×”×•×¡×£ ×”×–×× ×”</button>
            </form>
        </div>
    </div>


    <!-- Password Modal -->
    <div id="passwordModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('passwordModal')">&times;</button>
            <h2>×”×›× ×¡ ×¡×™×¡××”</h2>
            <input type="password" id="passwordInput" placeholder="×”×›× ×¡ ×¡×™×¡××”" onkeyup="if(event.keyCode === 13) checkPassword()">
            <button onclick="checkPassword()">××©×¨</button>
            <p id="passwordError" style="color: var(--accent-color); margin-top: 10px; font-size: 0.9rem; display: none;">×¡×™×¡××” ×©×’×•×™×”. × ×¡×” ×©×•×‘.</p>
        </div>
    </div>

    <!-- Generic Alert Modal (for non-critical messages like Street View unavailable) -->
    <div id="alertModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('alertModal')">&times;</button>
            <h2 id="alertTitle"></h2>
            <p id="alertMessage"></p>
            <button onclick="closeModal('alertModal')" style="background-color: var(--primary-color); color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px;">××™×©×•×¨</button>
        </div>
    </div>

    <!-- AI Interaction Modal (for Daily Summary and Customer Message) -->
    <div id="aiInteractionModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('aiInteractionModal')">&times;</button>
            <h2 id="aiModalTitle"></h2>
            <div id="aiModalContent">
                <div class="loading-spinner"></div>
                <p style="text-align: center;">×˜×•×¢×Ÿ ×ª×•×›×Ÿ...</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables for Google Maps
        let map;
        let panorama;
        let geocoder;
        let currentLatLng; // To store the last geocoded location

        // Callback function for Google Maps API loading
        function initMapLibraries() {
            geocoder = new google.maps.Geocoder();
            // Once map libraries are loaded, fetch data and render everything
            fetchDataAndRender(aliRange, "aliTimeline");
            fetchDataAndRender(hakmatRange, "hakmatTimeline");
        }

        // Function to update the current time and date
        function updateDateTime() {
            const now = new Date();
            
            // Format time (HH:MM:SS)
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            const formattedTime = now.toLocaleTimeString('he-IL', timeOptions);
            
            // Format date (Day, Month Day, Year)
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            let formattedDate = now.toLocaleDateString('he-IL', dateOptions);
            
            // Remove "×™×•× " prefix for a more natural Hebrew feel
            formattedDate = formattedDate.replace('×™×•× ', '');
            
            document.getElementById('currentTime').textContent = formattedTime; // Corrected: Time for current time element
            document.getElementById('currentDate').textContent = formattedDate; // Corrected: Date for current date element
        }
        
        // Update date and time every second
        setInterval(updateDateTime, 1000);
        updateDateTime(); // Call immediately to display on load
        
        // Google Sheets API configuration
        const sheetId = '1LM1rUju2EXcdKb97HbfYguanHJ6YGxULKAvQLvxPQhU'; // Your Google Sheet ID
        const apiKey = 'YOUR_GOOGLE_SHEETS_API_KEY'; // Your Google API Key (ensure it has access to Google Sheets API)
        
        // Google Maps JavaScript API Key - REPLACE WITH YOUR ACTUAL KEY
        // This key MUST be enabled for Maps JavaScript API, Places API, and Geocoding API
        const GOOGLE_MAPS_JAVASCRIPT_API_KEY = 'AIzaSyCd8lAxk7KfQvwuDGszaseiJXgc4eMfq-E'; 

        // Gemini API Key (leave empty, Canvas will inject it)
        const GEMINI_API_KEY = "AIzaSyCNn7GZMsQPCdRSfgz_o08M1YV63CkA3Ow"; 

        // Updated ranges to include column H
        const aliRange = 'Sheet2!B2:H10'; 
        const hakmatRange = 'Sheet1!B2:H10'; 

        // Password for WhatsApp share button
        const WHATSAPP_PASSWORD = "1125";

        // Global storage for orders data by driver
        let allOrders = []; // Stores all fetched orders
        let aliOrdersData = [];
        let hakmatOrdersData = [];

        // Chart instances
        let warehouseChart;
        let morningOrdersChart;

        /**
         * Parses a time string (e.g., "14:30") into a Date object for sorting.
         * Assumes times are for the current date for comparison purposes.
         * @param {string} timeStr The time string in HH:MM format.
         * @returns {Date} A Date object representing the time.
         */
        function parseTimeForSorting(timeStr) {
            if (!timeStr) return new Date(0); // Return a very early date for empty times
            const [hours, minutes] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        /**
         * Fetches data from Google Sheets and renders it as "order cubes" in the timeline.
         * Also updates global order data arrays.
         * @param {string} range The A1 notation of the range to retrieve from the spreadsheet.
         * @param {string} timelineId The ID of the HTML element where the orders will be rendered.
         */
        async function fetchDataAndRender(range, timelineId) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                const timelineContainer = document.getElementById(timelineId);
                timelineContainer.innerHTML = ""; // Clear existing content

                let currentDriverOrders = []; // To store orders for the current driver

                if (data.values && data.values.length > 0) {
                    // Filter out empty rows and sort by time.
                    const filteredAndSortedData = data.values
                        .filter(row => row.length >= 6 && row[1]) 
                        .sort((a, b) => {
                            const timeA = parseTimeForSorting(a[1]);
                            const timeB = parseTimeForSorting(b[1]);
                            return timeA - timeB;
                        });

                    filteredAndSortedData.forEach((row) => {
                        const date = row[0] || "×œ× ×™×“×•×¢";
                        const time = row[1] || "×œ× ×™×“×•×¢";
                        const warehouse = row[2] || "×œ× ×™×“×•×¢";
                        const status = row[3] || "×œ× ×™×“×•×¢";
                        const customer = row[4] || "×œ× ×™×“×•×¢";
                        const address = row[5] || "×œ× ×™×“×•×¢";
                        const driver = (timelineId === "aliTimeline") ? "×¢×œ×™" : "×—×›××ª"; // Determine driver based on timeline ID
                        const additionalData = row.length > 6 ? row[6] : "×œ× ×™×“×•×¢"; 

                        const fullAddressForMap = address; 

                        const orderDetails = { date, time, warehouse, status, customer, address, driver, additionalData };
                        currentDriverOrders.push(orderDetails); // Store for summary

                        const orderCard = document.createElement("div");
                        orderCard.classList.add("order-card");
                        orderCard.dataset.order = JSON.stringify(orderDetails);
                        
                        orderCard.onclick = () => showOrderDetails(orderCard.dataset.order);

                        orderCard.innerHTML = `
                            <div class="order-time">
                                <i class="far fa-clock"></i> ${time || "×œ× ×™×“×•×¢"}
                            </div>
                            <div class="order-details">
                                <p><strong><i class="far fa-calendar-alt"></i> ×ª××¨×™×š:</strong> ${date || "×œ× ×™×“×•×¢"}</p>
                                <p><strong><i class="fas fa-user"></i> ×œ×§×•×—:</strong> ${customer || "×œ× ×™×“×•×¢"}</p>
                                <p><strong><i class="fas fa-map-marker-alt"></i> ×›×ª×•×‘×ª:</strong> <a href="#" class="city-link" data-full-address="${fullAddressForMap}">${address || "×œ× ×™×“×•×¢"}</a></p>
                                <p><strong><i class="fas fa-warehouse"></i> ××—×¡×Ÿ:</strong> ${warehouse || "×œ× ×™×“×•×¢"}</p>
                                <p><strong><i class="fas fa-info-circle"></i> ×¡×˜×˜×•×¡:</strong> ${status || "×œ× ×™×“×•×¢"}</p>
                            </div>
                            <div class="order-arrow"></div>
                        `;
                        timelineContainer.appendChild(orderCard);
                    });

                    // Store the fetched orders data globally for each driver
                    if (timelineId === "aliTimeline") {
                        aliOrdersData = currentDriverOrders;
                    } else if (timelineId === "hakmatTimeline") {
                        hakmatOrdersData = currentDriverOrders;
                    }
                    allOrders = aliOrdersData.concat(hakmatOrdersData); // Update combined orders

                    // Add event listeners for city links after all cards are rendered
                    timelineContainer.querySelectorAll('.city-link').forEach(link => {
                        link.onclick = (event) => {
                            event.preventDefault(); 
                            event.stopPropagation(); 
                            showCityMap(link.dataset.fullAddress);
                        };
                    });

                } else {
                    const noOrdersMessage = document.createElement("p");
                    noOrdersMessage.textContent = "××™×Ÿ ×”×–×× ×•×ª ×–××™× ×•×ª ×¢×‘×•×¨ × ×”×’ ×–×”.";
                    noOrdersMessage.style.textAlign = "center";
                    noOrdersMessage.style.marginTop = "30px";
                    noOrdersMessage.style.fontSize = "1.2rem";
                    noOrdersMessage.style.color = getComputedStyle(document.documentElement).getPropertyValue('--dark-color'); 
                    timelineContainer.appendChild(noOrdersMessage);
                }
            }
            catch (error) {
                console.error("×©×’×™××” ×‘×©×œ×™×¤×ª ×”× ×ª×•× ×™×:", error);
                const errorMessage = document.createElement("p");
                errorMessage.textContent = "××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.";
                errorMessage.style.textAlign = "center";
                errorMessage.style.marginTop = "30px";
                errorMessage.style.fontSize = "1.2rem";
                errorMessage.style.color = getComputedStyle(document.documentElement).getPropertyValue('--accent-color');
                timelineContainer.appendChild(errorMessage);
            }
            updateAllStatsAndCharts(); // Update stats after data fetch
            updateHorizontalTimeline(); // Update horizontal timeline
        }
        
        /**
         * Displays the full order details in a modal.
         * @param {string} orderJson The JSON string of the order data.
         */
        function showOrderDetails(orderJson) {
            const order = JSON.parse(orderJson);
            document.getElementById('modalDate').textContent = order.date || '××™×Ÿ × ×ª×•× ×™×';
            document.getElementById('modalTime').textContent = order.time || '××™×Ÿ × ×ª×•× ×™×';
            document.getElementById('modalCustomer').textContent = order.customer || '××™×Ÿ × ×ª×•× ×™×';
            document.getElementById('modalAddress').textContent = order.address || '××™×Ÿ × ×ª×•× ×™×';
            document.getElementById('modalWarehouse').textContent = order.warehouse || '××™×Ÿ × ×ª×•× ×™×';
            document.getElementById('modalStatus').textContent = order.status || '××™×Ÿ × ×ª×•× ×™×';

            const customerMessageButton = document.querySelector('#orderDetailsModal .ai-customer-message-button');
            if (customerMessageButton) {
                customerMessageButton.dataset.order = orderJson; // Set the full JSON string
            }

            document.getElementById('orderDetailsModal').classList.add('visible');
        }

        /**
         * Displays a dynamic map view for a given address in a modal.
         * @param {string} fullAddress The full address to display on the map.
         */
        async function showCityMap(fullAddress) {
            document.getElementById('cityModalTitle').textContent = `××¤×” ×¢×‘×•×¨: ${fullAddress || '×›×ª×•×‘×ª ×œ× ×™×“×•×¢×”'}`;
            const mapContainer = document.getElementById('mapContainer');
            const streetViewPanoramaDiv = document.getElementById('streetViewPanorama');
            const toggleSvButton = document.querySelector('#mapControls button:first-child');
            
            // Defensive check: Ensure elements exist before trying to manipulate them
            if (!mapContainer) {
                showAlertModal("×©×’×™××”", "×©×’×™××” ×¤× ×™××™×ª: ××œ×× ×˜ ×”××¤×” ×”×¨××©×™ (mapContainer) ×œ× × ××¦× ×‘-HTML.");
                console.error("Critical: mapContainer element not found.", { mapContainer });
                return;
            }
            if (!streetViewPanoramaDiv) {
                showAlertModal("×©×’×™××”", "×©×’×™××” ×¤× ×™××™×ª: ××œ×× ×˜ Street View (streetViewPanorama) ×œ× × ××¦× ×‘-HTML. ×× × ×•×•×“× ×©×›×œ ×”×§×•×“ ×”×•×¢×ª×§ ×‘××“×•×™×§.");
                console.error("Critical: streetViewPanoramaDiv element not found.", { streetViewPanoramaDiv });
                return;
            }
            if (!toggleSvButton) {
                showAlertModal("×©×’×™××”", "×©×’×™××” ×¤× ×™××™×ª: ×›×¤×ª×•×¨ Street View (toggleSvButton) ×œ× × ××¦× ×‘-HTML.");
                console.error("Critical: toggleSvButton element not found.", { toggleSvButton });
                return;
            }

            // Reset map container if Street View was active
            streetViewPanoramaDiv.style.display = 'none'; 
            toggleSvButton.classList.remove('active');
            mapContainer.style.display = 'block'; // Ensure map is visible

            // Clear previous map content if any
            mapContainer.innerHTML = '';
            streetViewPanoramaDiv.innerHTML = '';

            // Check if Google Maps API libraries are loaded
            if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.Geocoder === 'undefined') {
                showAlertModal("×©×’×™××”", `×˜×¢×™× ×ª ××¤×•×ª Google × ×›×©×œ×”. ×× × ×•×•×“× ×©××¤×ª×— ×”-API ×ª×§×™×Ÿ ×‘-Google Cloud Console ×•×©×©×™×¨×•×ª×™ Maps JavaScript API ×•-Places API ××•×¤×¢×œ×™×.`);
                document.getElementById('cityMapModal').classList.add('visible');
                return;
            }

            // Geocode the address to get coordinates
            geocoder.geocode({ 'address': fullAddress }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    currentLatLng = results[0].geometry.location; // Store for Street View and external link
                    
                    // Define a custom map style for "colorful" effect
                    const mapStyle = [
                        { elementType: 'geometry', stylers: [{ color: '#f5f5f5' }] },
                        { elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
                        { elementType: 'labels.text.fill', stylers: [{ color: '#616161' }] },
                        { elementType: 'labels.text.stroke', stylers: [{ color: '#f5f5f5' }] },
                        {
                            featureType: 'administrative.land_parcel',
                            elementType: 'labels.text.fill',
                            stylers: [{ color: '#bdbdbd' }]
                        },
                        {
                            featureType: 'poi',
                            elementType: 'geometry',
                            stylers: [{ color: '#eeeeee' }]
                        },
                        {
                            featureType: 'poi',
                            elementType: 'labels.text.fill',
                            stylers: [{ color: '#757575' }]
                        },
                        {
                            featureType: 'poi.park',
                            elementType: 'geometry',
                            stylers: [{ color: '#e5e5e5' }]
                        },
                        {
                            featureType: 'poi.park',
                            elementType: 'labels.text.fill',
                            stylers: [{ color: '#9e9e9e' }]
                        },
                        {
                            featureType: 'road',
                            elementType: 'geometry',
                            stylers: [{ color: '#ffffff' }]
                        },
                        {
                            featureType: 'road.arterial',
                            elementType: 'labels.text.fill',
                            stylers: [{ color: '#757575' }]
                        },
                        {
                            featureType: 'road.highway',
                            elementType: 'geometry',
                            stylers: [{ color: '#dadada' }]
                        },
                        {
                            featureType: 'road.highway',
                            elementType: 'labels.text.fill',
                            stylers: [{ color: '#616161' }]
                        },
                        {
                            featureType: 'road.local',
                            elementType: 'labels.text.fill',
                            stylers: [{ color: '#9e9e9e' }]
                        },
                        {
                            featureType: 'transit.line',
                            elementType: 'geometry',
                            stylers: [{ color: '#e5e5e5' }]
                        },
                        {
                            featureType: 'transit.station',
                            elementType: 'geometry',
                            stylers: [{ color: '#eeeeee' }]
                        },
                        {
                            featureType: 'water',
                            elementType: 'geometry',
                            stylers: [{ color: '#c9c9c9' }]
                        },
                        {
                            featureType: 'water',
                            elementType: 'labels.text.fill',
                            stylers: [{ color: '#9e9e9e' }]
                        }
                    ];

                    // Initialize the map with the geocoded location and custom style
                    map = new google.maps.Map(mapContainer, {
                        center: currentLatLng,
                        zoom: 17, // Increased zoom for more detail
                        fullscreenControl: true, /* Enabled fullscreen control */
                        mapTypeControl: true, /* Enabled map type control */
                        streetViewControl: false, // We will handle Street View button manually
                        zoomControl: true, /* Enabled zoom control explicitly */
                        styles: mapStyle // Apply the custom colorful style
                    });

                    // Add a marker to the map for the precise address
                    new google.maps.Marker({
                        position: currentLatLng,
                        map: map,
                        title: fullAddress, // Show full address on marker hover
                        label: 'ğŸ ' // A house emoji as label for the address
                    });

                    // Initialize Street View Panorama
                    panorama = new google.maps.StreetViewPanorama(streetViewPanoramaDiv, {
                        position: currentLatLng,
                        pov: { heading: 270, pitch: 0 },
                        zoom: 1
                    });

                    // Bind the panorama to the map for manual control
                    map.setStreetView(panorama);

                    // Add event listener to Street View button
                    toggleSvButton.onclick = () => toggleStreetView();

                } else {
                    showAlertModal("×©×’×™××”", `×œ× × ×™×ª×Ÿ ×œ××¦×•× ××ª ×”××™×§×•× ×”××“×•×™×§ ×¢×‘×•×¨: ${fullAddress}. ×™×™×ª×›×Ÿ ×©×”×›×ª×•×‘×ª ×œ× × ×›×•× ×” ××• ×©××™×Ÿ × ×ª×•× ×™× ×–××™× ×™×. ×¡×™×‘×”: ${status}`);
                    console.error('Geocode was not successful for the following reason: ' + status);
                }
            });
            document.getElementById('cityMapModal').classList.add('visible');
        }

        /**
         * Toggles the Street View display in the map modal.
         */
        function toggleStreetView() {
            const streetViewPanoramaDiv = document.getElementById('streetViewPanorama');
            const mapContainer = document.getElementById('mapContainer');
            const toggleSvButton = document.querySelector('#mapControls button:first-child');

            // Defensive checks again (though should be caught by showCityMap)
            if (!streetViewPanoramaDiv || !mapContainer || !toggleSvButton) {
                showAlertModal("×©×’×™××”", "×©×’×™××” ×‘×˜×¢×™× ×ª ××œ×× ×˜×™× ×©×œ Street View. ×× × ×¨×¢× ×Ÿ ××ª ×”×“×£.");
                console.error("Critical: Missing elements in toggleStreetView.", { mapContainer, streetViewPanoramaDiv, toggleSvButton });
                return;
            }

            if (streetViewPanoramaDiv.style.display === 'block') {
                streetViewPanoramaDiv.style.display = 'none';
                mapContainer.style.display = 'block';
                toggleSvButton.classList.remove('active');
            } else {
                // Check if Street View data is available for the current location
                const streetViewService = new google.maps.StreetViewService();
                streetViewService.getPanorama({ location: currentLatLng, radius: 50 }, (data, status) => {
                    if (status === 'OK' && data && data.location && data.location.latLng) {
                        panorama.setPosition(data.location.latLng); // Set panorama to the best available location
                        streetViewPanoramaDiv.style.display = 'block';
                        mapContainer.style.display = 'none';
                        toggleSvButton.classList.add('active');
                    } else {
                        showAlertModal("Street View ××™× ×• ×–××™×Ÿ", "Street View ××™× ×• ×–××™×Ÿ ×¢×‘×•×¨ ××™×§×•× ×–×”. × ×¡×” ××™×§×•× ××—×¨ ××• ×—×¤×© ×™×©×™×¨×•×ª ×‘××¤×•×ª Google.");
                        console.error('Street View data not found for this location: ' + status);
                    }
                });
            }
        }

        /**
         * Opens the current map location in Google Maps.
         */
        function openInGoogleMaps() {
            if (currentLatLng) {
                const lat = currentLatLng.lat();
                const lng = currentLatLng.lng();
                // Get the full address from the modal title to use in the Google Maps URL
                const addressFromTitle = document.getElementById('cityModalTitle').textContent.replace('××¤×” ×¢×‘×•×¨: ', '');
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addressFromTitle)}`;
                window.open(googleMapsUrl, '_blank');
            } else {
                showAlertModal("×©×’×™××”", "×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ×‘××¤×•×ª Google. ××™×§×•× ×œ× ×™×“×•×¢.");
            }
        }

        /**
         * Closes a specified modal.
         * @param {string} modalId The ID of the modal overlay to close.
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('visible');
            // Reset map and panorama when map modal closes
            if (modalId === 'cityMapModal') {
                const mapContainer = document.getElementById('mapContainer');
                const streetViewPanoramaDiv = document.getElementById('streetViewPanorama');
                // Defensive check before clearing/dereferencing
                if (mapContainer) mapContainer.innerHTML = ''; // Clear map div
                if (streetViewPanoramaDiv) streetViewPanoramaDiv.innerHTML = ''; // Clear panorama div
                map = null; // Dereference map object
                panorama = null; // Dereference panorama object
                currentLatLng = null; // Clear current location
            }
        }

        /**
         * Shows a generic alert modal with a title and message.
         * @param {string} title The title of the alert.
         * @param {string} message The message content of the alert.
         */
        function showAlertModal(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            document.getElementById('alertModal').classList.add('visible');
        }
        
        /**
         * Shows the password input modal before allowing WhatsApp share.
         */
        function showPasswordModal() {
            document.getElementById('passwordInput').value = ''; // Clear previous input
            document.getElementById('passwordError').style.display = 'none'; // Hide error message
            document.getElementById('passwordModal').classList.add('visible');
        }

        /**
         * Checks the entered password and proceeds to WhatsApp share if correct.
         */
        function checkPassword() {
            const inputPassword = document.getElementById('passwordInput').value;
            if (inputPassword === WHATSAPP_PASSWORD) {
                closeModal('passwordModal');
                shareToWhatsAppConfirmed(); // Proceed to share if password is correct
            } else {
                document.getElementById('passwordError').style.display = 'block'; // Show error message
            }
        }

        /**
         * Formats the data from a virtual table (fetched from sheets) into a WhatsApp message string.
         * @param {string} range The A1 notation of the range to retrieve from the spreadsheet.
         * @param {string} driverName The name of the driver for WhatsApp formatting.
         * @returns {Promise<string>} A promise that resolves to the formatted message string.
         */
        async function formatWhatsAppData(range, driverName) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                let message = `ğŸ“ *${driverName} - ×“×•×— ×‘×•×§×¨*\n`;

                if (data.values && data.values.length > 0) {
                    // Sort data by time before formatting for WhatsApp
                    const sortedData = data.values
                        .filter(row => row.length >= 6 && row[1])
                        .sort((a, b) => {
                            const timeA = parseTimeForSorting(a[1]);
                            const timeB = parseTimeForSorting(b[1]);
                            return timeA - timeB;
                        });

                    sortedData.forEach((row) => {
                        const [date, time, warehouse, status, customer, address] = row; // Take first 6 for message
                        message += `ğŸ“… ${date || ""} â° ${time || ""}\n`;
                        message += `ğŸ  ${warehouse || ""} ğŸ“„ ${status || ""}\n`;
                        message += `ğŸ‘¤ ${customer || ""} ğŸ“ ${address || ""}\n`;
                        message += `â–â–â–\n`;
                    });
                } else {
                    message += "××™×Ÿ ×”×–×× ×•×ª ×–××™× ×•×ª.\n";
                }
                return message.trim();
            } catch (error) {
                console.error("Error formatting data for WhatsApp:", error);
                return `ğŸ“ *${driverName} - ×“×•×— ×‘×•×§×¨*\n×©×’×™××” ×‘×©×œ×™×¤×ª × ×ª×•× ×™× ×œ×©×™×ª×•×£.`;
            }
        }

        /**
         * Shares the formatted driver reports to WhatsApp (after password confirmation).
         */
        async function shareToWhatsAppConfirmed() {
            const aliData = await formatWhatsAppData(aliRange, "×¢×œ×™");
            const hakmatData = await formatWhatsAppData(hakmatRange, "×—×›××ª");
            const link = "ğŸ”— https://did.li/njaDN"; // Assuming this link is constant

            // Add stats to WhatsApp message
            const totalOrders = allOrders.length;
            const morningOrders = allOrders.filter(order => {
                const timeParts = order.time.split(':').map(Number);
                const hour = timeParts[0];
                return hour >= 6 && hour < 9;
            }).length;

            const warehouseCounts = {};
            allOrders.forEach(order => {
                const warehouse = order.warehouse || '×œ× ×™×“×•×¢';
                warehouseCounts[warehouse] = (warehouseCounts[warehouse] || 0) + 1;
            });

            let warehouseSummary = '';
            for (const warehouse in warehouseCounts) {
                warehouseSummary += `* ${warehouse}: ${warehouseCounts[warehouse]} ×”×–×× ×•×ª\n`;
            }

            const statsMessage = `\nğŸ“Š *×¡×™×›×•× ×™×•××™:*\n` +
                                 `* ×¡×”"×› ×”×–×× ×•×ª: ${totalOrders}\n` +
                                 `* ×”×–×× ×•×ª 06:00-09:00: ${morningOrders}\n` +
                                 `* ×”×–×× ×•×ª ×œ×¤×™ ××—×¡×Ÿ:\n${warehouseSummary}`;

            const fullMessage = `ğŸš› *×¡×™×“×•×¨ ×‘×•×§×¨ - ×”×–×× ×•×ª*\n\n${aliData}\n\n${hakmatData}\n\n${statsMessage}${link}`;
            const phoneNumber = "972508860896"; // Pre-set phone number
            const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(fullMessage)}`;

            window.open(url, "_blank"); // Open WhatsApp in a new tab
        }

        /**
         * Shows the daily summary modal and fetches content from LLM.
         * @param {string} driverName The name of the driver.
         */
        async function showDailySummary(driverName) {
            const aiModal = document.getElementById('aiInteractionModal');
            const aiModalTitle = document.getElementById('aiModalTitle');
            const aiModalContent = document.getElementById('aiModalContent');
            
            aiModalTitle.textContent = `âœ¨ ×¡×™×›×•× ×™×•××™ ×¢×‘×•×¨ ${driverName}`;
            aiModalContent.innerHTML = '<div class="loading-spinner"></div><p style="text-align: center;">×˜×•×¢×Ÿ ×¡×™×›×•× ×™×•××™...</p>';
            aiModal.classList.add('visible');

            let ordersToSummarize = [];
            if (driverName === '×¢×œ×™') {
                ordersToSummarize = aliOrdersData;
            } else if (driverName === '×—×›××ª') {
                ordersToSummarize = hakmatOrdersData;
            }

            if (ordersToSummarize.length === 0) {
                aiModalContent.innerHTML = `<p>××™×Ÿ ×”×–×× ×•×ª ×–××™× ×•×ª ×¢×‘×•×¨ ${driverName} ×œ×¡×™×›×•× ×™×•××™.</p>`;
                return;
            }

            try {
                const summaryText = await getDailySummaryFromLLM(driverName, ordersToSummarize);
                aiModalContent.innerHTML = `<pre>${summaryText}</pre>`;
            } catch (error) {
                console.error("Error fetching daily summary:", error);
                aiModalContent.innerHTML = `<p style="color: var(--accent-color);">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×™×›×•× ×”×™×•××™: ${error.message}. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.</p>`;
            }
        }

        /**
         * Fetches a daily summary from the Gemini LLM.
         * @param {string} driverName The name of the driver.
         * @param {Array<Object>} orders The array of order objects for the driver.
         * @returns {Promise<string>} The generated daily summary text.
         */
        async function getDailySummaryFromLLM(driverName, orders) {
            let ordersPrompt = orders.map((order, index) => {
                return `×”×–×× ×” ${index + 1}: ×–××Ÿ: ${order.time}, ×œ×§×•×—: ${order.customer}, ×›×ª×•×‘×ª: ${order.address}, ××—×¡×Ÿ: ${order.warehouse}, ×¡×˜×˜×•×¡: ${order.status}`;
            }).join('\n');

            if (orders.length === 0) {
                ordersPrompt = "××™×Ÿ ×”×–×× ×•×ª ×œ×”×™×•×.";
            }

            const prompt = `× ×ª×•× ×™× ×™×•××™×™× ×¢×‘×•×¨ × ×”×’ ${driverName}:\n\n${ordersPrompt}\n\n×‘×”×ª×‘×¡×¡ ×¢×œ ×”× ×ª×•× ×™× ×œ×¢×™×œ, ×× × ×›×ª×•×‘ ×¡×™×›×•× ×§×¦×¨ ×•×§×œ×™×œ ×¢×‘×•×¨ ×”× ×”×’, ×©×™×›×œ×•×œ: ××ª ××¡×¤×¨ ×”×”×–×× ×•×ª, ×”×”×–×× ×” ×”××•×§×“××ª ×‘×™×•×ª×¨ ×•×”×××•×—×¨×ª ×‘×™×•×ª×¨, ×•×”×× ×™×© ××©×”×• ××™×•×—×“ (×œ×“×•×’××”, ×¨×™×›×•×– ×”×–×× ×•×ª ×‘××–×•×¨ ××¡×•×™×, ××• ××¡×¤×¨ ×¨×‘ ×©×œ ×”×–×× ×•×ª). ×”×©×ª××© ×‘×˜×•×Ÿ ××§×¦×•×¢×™ ×•×™×“×™×“×•×ª×™. ×× ××™×Ÿ ×”×–×× ×•×ª, ×¦×™×™×Ÿ ×–××ª ×‘××¤×•×¨×©. ×›×ª×•×‘ ××ª ×”×¡×™×›×•× ×‘×©×¤×” ×”×¢×‘×¨×™×ª.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Gemini API error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
            }

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error("×œ× ×”×ª×§×‘×œ×” ×ª×’×•×‘×” ×ª×§×¤×” ×-Gemini API.");
            }
        }

        /**
         * Generates and displays a customer message draft using LLM.
         * @param {string} orderJson The JSON string of the order data.
         */
        async function generateAndShowCustomerMessage(orderJson) {
            const order = JSON.parse(orderJson);
            const aiModal = document.getElementById('aiInteractionModal');
            const aiModalTitle = document.getElementById('aiModalTitle');
            const aiModalContent = document.getElementById('aiModalContent');

            aiModalTitle.textContent = `âœ¨ ×˜×™×•×˜×ª ×”×•×“×¢×” ×œ×œ×§×•×—: ${order.customer}`;
            aiModalContent.innerHTML = '<div class="loading-spinner"></div><p style="text-align: center;">××›×™×Ÿ ×˜×™×•×˜×”...</p>';
            aiModal.classList.add('visible');

            try {
                const messageText = await getCustomerMessageFromLLM(order);
                aiModalContent.innerHTML = `
                    <textarea id="customerMessageTextarea" rows="10" cols="50" readonly>${messageText}</textarea>
                    <button class="ai-copy-button" onclick="copyCustomerMessage()">×”×¢×ª×§ ×”×•×“×¢×”</button>
                `;
            } catch (error) {
                console.error("Error generating customer message:", error);
                aiModalContent.innerHTML = `<p style="color: var(--accent-color);">×©×’×™××” ×‘×™×¦×™×¨×ª ×”×˜×™×•×˜×”: ${error.message}. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.</p>`;
            }
        }

        /**
         * Copies the generated customer message to the clipboard.
         */
        function copyCustomerMessage() {
            const textarea = document.getElementById('customerMessageTextarea');
            if (textarea) {
                textarea.select();
                document.execCommand('copy'); // Use execCommand for broader compatibility in iframes
                showAlertModal("×”×•×¢×ª×§!", "×”×”×•×“×¢×” ×”×•×¢×ª×§×” ×œ×œ×•×— ×”×¢×¨×™×›×”.");
            } else {
                showAlertModal("×©×’×™××”", "×œ× × ××¦××” ×”×•×“×¢×” ×œ×”×¢×ª×§×”.");
            }
        }

        /**
         * Shows the Add Order Modal.
         */
        function showAddOrderModal() {
            // Reset form fields
            document.getElementById('addOrderForm').reset();
            // Set current date as default for orderDate
            document.getElementById('orderDate').valueAsDate = new Date();
            document.getElementById('addOrderModal').classList.add('visible');
        }

        /**
         * Handles the submission of the Add Order Form.
         * For now, it logs the data and can optionally use AI.
         */
        document.getElementById('addOrderForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission

            const newOrder = {
                date: document.getElementById('orderDate').value,
                time: document.getElementById('orderTime').value,
                customer: document.getElementById('orderCustomer').value,
                address: document.getElementById('orderAddress').value,
                warehouse: document.getElementById('orderWarehouse').value,
                status: document.getElementById('orderStatus').value,
                driver: document.getElementById('orderDriver').value
            };

            console.log("New order to add (not saved to Sheets directly):", newOrder);
            showAlertModal("×”×–×× ×” ×”×ª×§×‘×œ×”", `×”×–×× ×” ×—×“×©×” ×œ×œ×§×•×— ${newOrder.customer} ×¢×‘×•×¨ ${newOrder.driver} ×”×ª×§×‘×œ×” ×‘×”×¦×œ×—×” (×œ× × ×©××¨×” ×‘×’×™×œ×™×•×Ÿ).`);
            closeModal('addOrderModal');

            // Optionally, you can trigger an AI action here, e.g., to confirm the order.
            // Example:
            // const aiConfirmationPrompt = `Confirm the following new order: ${JSON.stringify(newOrder)}`;
            // const aiResponse = await getGeminiResponse(aiConfirmationPrompt);
            // console.log("AI confirmation for new order:", aiResponse);

            // Re-fetch data to update display (though new order won't persist without Sheets save)
            fetchDataAndRender(aliRange, "aliTimeline");
            fetchDataAndRender(hakmatRange, "hakmatTimeline");
        });

        /**
         * Updates all statistics and charts based on current allOrders data.
         */
        function updateAllStatsAndCharts() {
            // 1. Total Orders Count
            document.getElementById('totalOrdersCount').textContent = allOrders.length;

            // 2. Morning Orders (06:00-09:00)
            const morningOrders = allOrders.filter(order => {
                try {
                    const timeParts = order.time.split(':').map(Number);
                    const hour = timeParts[0];
                    return hour >= 6 && hour < 9;
                } catch (e) {
                    console.warn("Invalid time format for morning order check:", order.time, e);
                    return false; // Exclude invalid times
                }
            }).length;
            document.getElementById('morningOrdersCount').textContent = morningOrders;

            // 3. Orders by Warehouse
            const warehouseCounts = {};
            allOrders.forEach(order => {
                const warehouse = order.warehouse || '×œ× ×™×“×•×¢';
                warehouseCounts[warehouse] = (warehouseCounts[warehouse] || 0) + 1;
            });

            // Dynamically add warehouse stats
            const statsSummaryContainer = document.querySelector('.stats-summary');
            // Remove existing dynamic warehouse stats (keep total and morning)
            statsSummaryContainer.querySelectorAll('.dynamic-stat-item').forEach(item => item.remove());

            for (const warehouse in warehouseCounts) {
                const statItem = document.createElement('div');
                statItem.classList.add('stat-item', 'dynamic-stat-item');
                statItem.innerHTML = `<h3>${warehouseCounts[warehouse]}</h3><p>×”×–×× ×•×ª ×${warehouse}</p>`;
                statsSummaryContainer.appendChild(statItem);
            }

            // 4. Render Warehouse Chart
            const warehouseCtx = document.getElementById('warehouseChart').getContext('2d');
            const warehouseLabels = Object.keys(warehouseCounts);
            const warehouseData = Object.values(warehouseCounts);

            if (warehouseChart) {
                warehouseChart.destroy(); // Destroy previous chart instance
            }
            warehouseChart = new Chart(warehouseCtx, {
                type: 'pie',
                data: {
                    labels: warehouseLabels,
                    datasets: [{
                        data: warehouseData,
                        backgroundColor: [
                            '#3498db', '#2ecc71', '#e74c3c', '#9b59b6', '#f1c40f', '#1abc9c', '#d35400'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: { family: 'Rubik' }
                            }
                        },
                        title: {
                            display: false,
                        }
                    }
                }
            });

            // 5. Render Morning Orders Chart
            const morningOrdersCtx = document.getElementById('morningOrdersChart').getContext('2d');
            
            // Prepare data for morning orders by hour
            const morningHourCounts = {};
            for (let i = 6; i < 9; i++) { // Hours 6, 7, 8
                morningHourCounts[i] = 0;
            }
            allOrders.forEach(order => {
                try {
                    const timeParts = order.time.split(':').map(Number);
                    const hour = timeParts[0];
                    if (hour >= 6 && hour < 9) {
                        morningHourCounts[hour]++;
                    }
                } catch (e) {
                    console.warn("Invalid time format for morning chart:", order.time, e);
                }
            });

            const morningChartLabels = Object.keys(morningHourCounts).map(hour => `${hour}:00-${parseInt(hour) + 1}:00`);
            const morningChartData = Object.values(morningHourCounts);

            if (morningOrdersChart) {
                morningOrdersChart.destroy(); // Destroy previous chart instance
            }
            morningOrdersChart = new Chart(morningOrdersCtx, {
                type: 'bar',
                data: {
                    labels: morningChartLabels,
                    datasets: [{
                        label: '××¡×¤×¨ ×”×–×× ×•×ª',
                        data: morningChartData,
                        backgroundColor: '#2ecc71',
                        borderColor: '#27ae60',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        title: {
                            display: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0, // Ensure integer ticks
                                font: { family: 'Rubik' }
                            }
                        },
                        x: {
                            ticks: {
                                font: { family: 'Rubik' }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Updates the horizontal timeline with order pins.
         */
        function updateHorizontalTimeline() {
            const timelineContainer = document.getElementById('horizontalTimeline');
            // Clear existing pins, but keep the line div
            timelineContainer.querySelectorAll('.timeline-pin').forEach(pin => pin.remove());

            // Collect all orders and sort them by time
            const sortedAllOrders = [...allOrders].sort((a, b) => {
                const timeA = parseTimeForSorting(a.time);
                const timeB = parseTimeForSorting(b.time);
                return timeA - timeB;
            });

            if (sortedAllOrders.length === 0) {
                // Display a message if no orders for timeline
                timelineContainer.innerHTML = '<div class="timeline-line"></div><p style="text-align: center; width: 100%; position: relative; z-index: 1;">××™×Ÿ ×”×–×× ×•×ª ×œ×”×¦×’×” ×‘×¦×™×¨ ×”×–××Ÿ.</p>';
                return;
            }

            // Find min/max hours to normalize pin positions
            let minHour = 24, maxHour = 0;
            sortedAllOrders.forEach(order => {
                try {
                    const hour = parseInt(order.time.split(':')[0]);
                    if (hour < minHour) minHour = hour;
                    if (hour > maxHour) maxHour = hour;
                } catch (e) {
                    console.warn("Invalid time format for timeline position:", order.time, e);
                }
            });

            // Adjust min/max to ensure a reasonable time window, e.g., 6 AM to 18 PM
            minHour = Math.min(minHour, 6); // At least 6 AM
            maxHour = Math.max(maxHour, 18); // At least 6 PM
            // Add some buffer for visual appeal
            minHour = Math.max(0, minHour - 1); 
            maxHour = Math.min(23, maxHour + 1);

            const totalHoursSpan = maxHour - minHour;
            if (totalHoursSpan <= 0) { // Avoid division by zero or negative span
                 timelineContainer.innerHTML = '<div class="timeline-line"></div><p style="text-align: center; width: 100%; position: relative; z-index: 1;">×œ× × ×™×ª×Ÿ ×œ×”×¦×™×’ ×¦×™×¨ ×–××Ÿ ×¢× ×”×–×× ×•×ª ××œ×•.</p>';
                 return;
            }


            sortedAllOrders.forEach(order => {
                try {
                    const [hour, minute] = order.time.split(':').map(Number);
                    const totalMinutesOfDay = (hour * 60) + minute;
                    const totalMinutesSpan = (maxHour * 60) - (minHour * 60);
                    const currentMinutesFromMin = totalMinutesOfDay - (minHour * 60);

                    // Calculate position as percentage along the timeline
                    const positionPercentage = (currentMinutesFromMin / totalMinutesSpan) * 100;

                    const pin = document.createElement('div');
                    pin.classList.add('timeline-pin');
                    pin.style.left = `${positionPercentage}%`;
                    pin.innerHTML = `ğŸ“Œ
                        <div class="pin-info">
                            <p><i class="far fa-clock"></i> ×©×¢×”: ${order.time}</p>
                            <p><i class="fas fa-user"></i> ×œ×§×•×—: ${order.customer}</p>
                            <p><i class="fas fa-truck driver-icon"></i> × ×”×’: ${order.driver}</p>
                            <p><i class="fas fa-map-marker-alt"></i> ×›×ª×•×‘×ª: ${order.address}</p>
                        </div>
                    `;
                    timelineContainer.appendChild(pin);
                } catch (e) {
                    console.warn("Failed to add pin for order due to invalid time:", order, e);
                }
            });

            // Optionally add hour markers to the timeline (e.g., 07:00, 08:00)
            for (let h = minHour; h <= maxHour; h++) {
                const hourMarker = document.createElement('div');
                hourMarker.classList.add('timeline-pin'); // Reusing pin styling for markers
                hourMarker.style.borderColor = 'transparent'; // No border for hour markers
                hourMarker.style.backgroundColor = 'transparent'; // Transparent background
                hourMarker.style.boxShadow = 'none'; // No shadow
                hourMarker.style.pointerEvents = 'none'; // Not interactive
                hourMarker.style.fontSize = '0.9rem';
                hourMarker.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');


                const totalMinutesSpan = (maxHour * 60) - (minHour * 60);
                const currentMinutesFromMin = (h * 60) - (minHour * 60);
                const positionPercentage = (currentMinutesFromMin / totalMinutesSpan) * 100;
                
                // If it's a valid position, add the marker
                if (positionPercentage >= 0 && positionPercentage <= 100) {
                    hourMarker.style.left = `${positionPercentage}%`;
                    hourMarker.textContent = `${h}:00`;
                    timelineContainer.appendChild(hourMarker);
                }
            }
        }


        // Initial fetch and render of data for both drivers on page load
        // This is called AFTER initMapLibraries to ensure Google Maps objects are ready
        // fetchDataAndRender is now called in initMapLibraries
        // fetchDataAndRender(aliRange, "aliTimeline");
        // fetchDataAndRender(hakmatRange, "hakmatTimeline");
    </script>
</body>
</html>
