<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ğŸ“‹ ×“×•×— ×‘×•×§×¨ - ×–×›×•×›×™×ª ××ª×§×“××ª</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4587de">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/2jQvCKxs/Screenshot-20250508-230911-Gallery.jpg">
    <link rel="manifest" href="manifest.json">

    <!-- External Libraries & Fonts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

    <!-- OneSignal SDK for Push Notifications -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "acc8a2bc-d54e-4261-b3d2-cc5c5f7b39d3",
          safari_web_id: "web.onesignal.auto.5f4f9ed9-fb2e-4d6a-935d-81aa46fccce0",
          notifyButton: {
            enable: true,
          },
        });
      });
    </script>

    <style>
        /* General styling for the application */
        :root {
            --primary-color: #87CEEB; /* Sky Blue - Light Blue */
            --secondary-color: #4587de; /* Light Blue - Slightly lighter */
            --dark-color: #2C3E50; /* Dark blue-gray for strong text contrast */
            --light-color: #F8F8F8; /* Off-white */
            --accent-color: #E74C3C; /* Red for alerts/accents */
            --text-color: #333; /* Dark text */
            --shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            --card-bg: rgba(255, 255, 255, 0.9);
            --modal-bg: rgba(255, 255, 255, 0.95);
            --overlay-bg: rgba(0, 0, 0, 0.6);
            --glass-bg: rgba(255, 255, 255, 0.8);
        }
        
        html, body { overscroll-behavior-y: contain; }

        body {
            font-family: 'Rubik', Arial, sans-serif;
            text-align: center; background-color: var(--light-color);
            color: var(--text-color); margin: 0; padding: 0;
            min-height: 100vh; display: flex; flex-direction: column;
            position: relative; overflow-x: hidden;
        }

        body::before {
            content: ''; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('https://i.postimg.cc/2jQvCKxs/Screenshot-20250508-230911-Gallery.jpg');
            background-size: cover; background-position: center;
            background-attachment: fixed; opacity: 0;
            z-index: -1; transition: opacity 1.5s ease-in-out;
        }

        body.loaded::before { opacity: 0.7; }
        
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #ffffff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10000;
            transition: opacity 0.8s ease-out, visibility 0.8s;
            opacity: 1; visibility: visible;
        }
        #splash-screen.hidden { opacity: 0; visibility: hidden; }
        #splash-screen img {
            width: 150px; height: 150px; border-radius: 20%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); margin-bottom: 20px;
        }
        #splash-screen .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(0,0,0,0.1);
            border-top-color: var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .app-container {
            display: flex; flex-direction: column;
            height: 100vh; width: 100%; overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; padding: 15px 0; box-shadow: var(--shadow);
            position: fixed; top: 0; left: 0; width: 100%;
            z-index: 100; border-radius: 0 0 30px 30px;
        }
        h1 { margin: 0; font-size: 1.8rem; }
        
        .main-content {
            flex: 1; padding: 80px 15px 80px 15px;
            overflow-y: auto; -webkit-overflow-scrolling: touch; position: relative;
        }
        
        .page-content {
            display: none; opacity: 0; transform: translateX(20px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            position: absolute; width: calc(100% - 30px);
            top: 80px; right: 15px; padding-bottom: 80px;
        }

        .page-content.active {
            display: block; opacity: 1; transform: translateX(0);
            position: relative; top: 0; right: 0;
        }
        
        .driver-section-title {
            font-size: 1.8rem; font-weight: 700; margin: 30px 0 25px;
            color: var(--dark-color); display: flex; align-items: center;
            justify-content: center; gap: 15px; padding: 10px 20px;
            border-radius: 50px; background-color: var(--light-color);
            box-shadow: var(--shadow);
        }
        .driver-avatar {
            width: 50px; height: 50px; border-radius: 50%;
            object-fit: cover; border: 3px solid var(--primary-color);
        }

        .timeline-grid { display: grid; grid-template-columns: 1fr; gap: 15px; padding: 10px 0; margin: 0 auto; width: 100%; }

        .order-card {
            background: var(--glass-bg); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.18); padding: 15px;
            text-align: right; transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            display: flex; flex-direction: column; gap: 10px;
        }
        
        .order-card.ali { background: linear-gradient(135deg, rgba(173, 216, 230, 0.8), rgba(135, 206, 235, 0.8)); }
        .order-card.hakmat { background: linear-gradient(135deg, rgba(224, 242, 241, 0.8), rgba(178, 235, 242, 0.8)); }

        .order-time { font-size: 1.4rem; font-weight: 700; color: var(--dark-color); border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 10px; }
        .order-details p { margin: 4px 0; font-size: 1rem; display: flex; align-items: flex-start; gap: 8px; }
        .order-details i { margin-top: 3px; }
        .order-details strong { min-width: 70px; }

        .share-button {
            background-color: #25D366; color: white; padding: 15px 30px;
            font-size: 18px; font-weight: bold; border: none; border-radius: 50px;
            cursor: pointer; margin: 30px auto; display: flex; align-items: center;
            justify-content: center; gap: 10px; width: 90%; max-width: 300px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2); transition: all 0.3s ease;
        }
        .share-button:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }

        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .summary-card { background: var(--glass-bg); border-radius: 15px; padding: 15px; transition: transform 0.3s ease; }
        .summary-card:hover { transform: translateY(-5px); }
        .summary-card h3 { font-size: 1rem; margin-top: 0; }
        .summary-count { font-size: 2.5rem; font-weight: 700; color: var(--dark-color); }
        .chart-card { grid-column: 1 / -1; padding: 15px; }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--overlay-bg); display: flex; justify-content: center;
            align-items: center; z-index: 1000; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--modal-bg); padding: 25px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 90vw; width: 100%;
            position: relative; transform: scale(0.9); transition: transform 0.3s ease;
            max-height: 85vh; overflow-y: auto;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-close-button {
            position: absolute; top: 15px; left: 15px; background: var(--accent-color);
            color: white; border: none; border-radius: 50%; width: 35px; height: 35px;
            font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center;
            align-items: center;
        }
        
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px); box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            display: flex; justify-content: space-around; align-items: center;
            padding: 5px 0; z-index: 999; border-top-left-radius: 20px; border-top-right-radius: 20px;
        }
        .nav-button {
            background-color: transparent; border: none; color: #888; padding: 8px 12px;
            font-size: 0.9rem; font-weight: 500; cursor: pointer; display: flex;
            flex-direction: column; align-items: center; gap: 4px;
            transition: all 0.3s ease; flex: 1;
        }
        .nav-button.active { color: var(--secondary-color); transform: translateY(-5px); }
        .nav-button i { font-size: 1.3rem; }
        .nav-button .button-avatar {
            width: 28px; height: 28px; border-radius: 50%;
            object-fit: cover; border: 2px solid transparent; transition: border-color 0.3s ease;
        }
        .nav-button.active .button-avatar { border-color: var(--secondary-color); }

        .dropdown-menu {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background-color: white; border-radius: 10px; box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
            min-width: 150px; padding: 10px 0; opacity: 0; visibility: hidden;
            transition: all 0.3s ease; z-index: 1001;
        }
        .nav-button.warehouse-button.active .dropdown-menu {
            opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-10px);
        }
        .dropdown-item {
            padding: 10px 15px; color: var(--text-color); cursor: pointer;
            transition: background-color 0.2s ease; display: flex; align-items: center; gap: 8px;
        }
        .dropdown-item:hover { background-color: #f0f0f0; }

        /* Admin Page Styles */
        #adminPage .form-group, #adminLoginModal .form-group {
            margin-bottom: 15px; text-align: right;
        }
        #adminPage label, #adminLoginModal label { display: block; margin-bottom: 5px; font-weight: 500; }
        #adminPage input, #adminPage select, #adminLoginModal input, #adminLoginModal select {
            width: 100%; padding: 12px; border: 1px solid #ccc;
            border-radius: 8px; box-sizing: border-box; font-size: 1rem;
        }
        #adminPage button, #adminLoginModal button {
            background-color: var(--secondary-color); color: white; padding: 15px;
            border: none; border-radius: 8px; width: 100%; font-size: 1.1rem;
            font-weight: bold; cursor: pointer; transition: background-color 0.3s;
        }
        #adminPage button:hover, #adminLoginModal button:hover { background-color: var(--dark-color); }
        #adminLoginModal .modal-content { max-width: 350px; }
        .admin-order-list .order-card {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
        }
        .admin-order-list .order-details { flex-grow: 1; }
        .admin-order-list .status-controls { display: flex; flex-direction: column; gap: 5px; }
        .admin-order-list .status-btn {
            padding: 8px 10px; border-radius: 6px; border: none;
            cursor: pointer; color: white; font-size: 0.8rem;
        }
        .status-btn.complete { background-color: #2ecc71; }
        .status-btn.in-progress { background-color: #f39c12; }
    </style>
</head>
<body>
    
    <div id="splash-screen"><img src="https://i.postimg.cc/2jQvCKxs/Screenshot-20250508-230911-Gallery.jpg" alt="Logo"><div class="spinner"></div></div>
    
    <div class="app-container">
        <header class="header"><h1 id="headerTitle">ğŸš› ×“×•×— ×‘×•×§×¨</h1></header>

        <main class="main-content">
            <!-- Main Page Content -->
            <div id="mainPage" class="page-content">
                <div class="summary-grid">
                    <div class="summary-card"><h3><i class="fas fa-truck"></i> ×¢×œ×™</h3><div class="summary-count" id="aliOrderCount">0</div></div>
                    <div class="summary-card"><h3><i class="fas fa-truck"></i> ×—×›××ª</h3><div class="summary-count" id="hakmatOrderCount">0</div></div>
                    <div class="summary-card"><h3><i class="fas fa-warehouse"></i> ××—×¡×Ÿ</h3><div class="summary-count" id="totalWarehouseOrderCount">0</div></div>
                </div>
                <div class="chart-card summary-card">
                    <h3><i class="fas fa-chart-bar"></i> ×”×–×× ×•×ª ×‘×•×§×¨ (06:00-09:00)</h3>
                    <div class="chart-container" style="height:250px"><canvas id="morningOrdersChart"></canvas></div>
                </div>
                <div class="driver-section-title"><img src="https://i.postimg.cc/tCNbgXK3/Screenshot-20250623-200744-Tik-Tok.jpg" alt="Avatar for Ali" class="driver-avatar">× ×”×’: ×¢×œ×™</div>
                <div id="aliTimeline" class="timeline-grid"></div>
                <div class="driver-section-title"><img src="https://i.postimg.cc/d3S0NJJZ/Screenshot-20250623-200646-Facebook.jpg" alt="Avatar for Hakmat" class="driver-avatar">× ×”×’: ×—×›××ª</div>
                <div id="hakmatTimeline" class="timeline-grid"></div>
                <button class="share-button" onclick="showPasswordModal()"><i class="fab fa-whatsapp"></i> ×©×ª×£ ×“×•×— ×™×•××™</button>
            </div>
            
             <!-- Other pages -->
            <div id="hakmatPage" class="page-content"></div>
            <div id="aliPage" class="page-content"></div>
            <div id="warehousePage" class="page-content"></div>

            <!-- Admin Page (New Dashboard) -->
            <div id="adminPage" class="page-content">
                <div class="summary-card" style="margin-bottom: 20px;">
                    <h3><i class="fas fa-plus-circle"></i> ×™×¦×™×¨×ª ×”×–×× ×” ×—×“×©×”</h3>
                    <form id="createOrderForm">
                        <div class="form-group"><label for="orderDriver">×©×™×™×š ×œ× ×”×’</label><select id="orderDriver" required><option value="×—×›××ª">×—×›××ª</option><option value="×¢×œ×™">×¢×œ×™</option></select></div>
                        <div class="form-group"><label for="orderDate">×ª××¨×™×š</label><input type="date" id="orderDate" required></div>
                        <div class="form-group"><label for="orderTime">×©×¢×”</label><input type="time" id="orderTime" required></div>
                        <div class="form-group"><label for="orderCustomer">×œ×§×•×—</label><input type="text" id="orderCustomer" placeholder="×©× ×”×œ×§×•×—" required></div>
                        <div class="form-group"><label for="orderAddress">×›×ª×•×‘×ª</label><input type="text" id="orderAddress" placeholder="×¢×™×¨, ×¨×—×•×‘, ××¡×¤×¨ ×‘×™×ª" required></div>
                        <div class="form-group"><label for="orderWarehouse">××—×¡×Ÿ</label><select id="orderWarehouse" required><option value="×”×ª×œ××™×“">×”×ª×œ××™×“</option><option value="×”×—×¨×©">×”×—×¨×©</option></select></div>
                        <div class="form-group"><label for="orderOperationType">×¡×•×’ ×¤×¢×•×œ×”</label><input type="text" id="orderOperationType" value="×”×•×‘×œ×”" required></div>
                        <button type="submit" id="createOrderBtn">×¦×•×¨ ×”×–×× ×” ×•×©×œ×— ×”×ª×¨××”</button>
                    </form>
                </div>

                <div class="summary-card" style="margin-bottom: 20px;">
                     <h3><i class="fas fa-tasks"></i> × ×™×”×•×œ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª</h3>
                     <div id="adminOrderList" class="timeline-grid admin-order-list">
                         <p>×˜×•×¢×Ÿ ×”×–×× ×•×ª...</p>
                     </div>
                </div>

                <div class="summary-card">
                     <h3><i class="fab fa-whatsapp"></i> ×“×•×— ×œ××—×¨</h3>
                     <p>×”×›×Ÿ ×•×©×œ×— ××ª ×“×•×— ×”×”×–×× ×•×ª ×”××œ× ×œ×™×•× ×”×¢×‘×•×“×” ×”×‘×.</p>
                     <button onclick="shareTomorrowReport()"><i class="fab fa-whatsapp"></i> ×©×ª×£ ×“×•×— ×œ××—×¨</button>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation Bar -->
        <nav class="bottom-nav">
             <button class="nav-button active" data-page-id="mainPage" data-nav-id="main-nav-button"><i class="fas fa-home"></i><span>×¨××©×™</span></button>
            <button class="nav-button" data-page-id="hakmatPage" data-nav-id="hakmat-nav-button"><img src="https://i.postimg.cc/d3S0NJJZ/Screenshot-20250623-200646-Facebook.jpg" alt="Hakmat" class="button-avatar"><span>×—×›××ª</span></button>
            <button class="nav-button" data-page-id="aliPage" data-nav-id="ali-nav-button"><img src="https://i.postimg.cc/tCNbgXK3/Screenshot-20250623-200744-Tik-Tok.jpg" alt="Ali" class="button-avatar"><span>×¢×œ×™</span></button>
            <button class="nav-button warehouse-button" data-nav-id="warehouse-nav-button">
                <i class="fas fa-boxes"></i><span>××—×¡×Ÿ</span>
                <div class="dropdown-menu">
                    <div class="dropdown-item" data-warehouse-type="×”×ª×œ××™×“"><i class="fas fa-school"></i> ×”×ª×œ××™×“</div>
                    <div class="dropdown-item" data-warehouse-type="×”×—×¨×©"><i class="fas fa-tools"></i> ×”×—×¨×©</div>
                </div>
            </button>
            <button class="nav-button" data-page-id="adminPage" data-nav-id="admin-nav-button"><i class="fas fa-user-shield"></i><span>× ×™×”×•×œ</span></button>
        </nav>
    </div>

    <!-- Modals -->
    <div id="orderDetailsModal" class="modal-overlay"><div class="modal-content"><button class="modal-close-button" onclick="closeModal('orderDetailsModal')">&times;</button><h2 id="modalTitle">×¤×¨×˜×™ ×”×–×× ×”</h2><p><strong><i class="far fa-calendar-alt"></i> ×ª××¨×™×š:</strong> <span id="modalDate"></span></p><p><strong><i class="far fa-clock"></i> ×©×¢×”:</strong> <span id="modalTime"></span></p><p><strong><i class="fas fa-user"></i> ×œ×§×•×—:</strong> <span id="modalCustomer"></span></p><p><strong><i class="fas fa-map-marker-alt"></i> ×›×ª×•×‘×ª:</strong> <span id="modalAddress"></span></p><p><strong><i class="fas fa-warehouse"></i> ××—×¡×Ÿ:</strong> <span id="modalWarehouse"></span></p><p><strong><i class="fas fa-cogs"></i> ×¡×•×’ ×¤×¢×•×œ×”:</strong> <span id="modalOperationType"></span></p><p><strong><i class="fas fa-info-circle"></i> ×¡×˜×˜×•×¡:</strong> <span id="modalStatus"></span></p></div></div>
    <div id="passwordModal" class="modal-overlay"><div class="modal-content" style="text-align: center;"><button class="modal-close-button" onclick="closeModal('passwordModal')">&times;</button><h2>×”×›× ×¡ ×¡×™×¡××”</h2><input type="password" id="passwordInput" placeholder="×¡×™×¡××”" style="width: 80%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; text-align: center;"><button onclick="checkPassword()" style="padding: 10px 20px; border-radius: 8px; border: none; background-color: var(--primary-color); color: white;">××©×¨</button><p id="passwordError" style="color: var(--accent-color); display: none;">×¡×™×¡××” ×©×’×•×™×”.</p></div></div>
    <div id="adminLoginModal" class="modal-overlay"><div class="modal-content"><button class="modal-close-button" onclick="closeModal('adminLoginModal')">&times;</button><h2>×›× ×™×¡×ª ×× ×”×œ</h2><div class="form-group"><label for="adminUsername">×©× ××©×ª××©</label><select id="adminUsername"><option value="×¨×××™">×¨×××™</option><option value="×™×•××‘">×™×•××‘</option></select></div><div class="form-group"><label for="adminPassword">×¡×™×¡××”</label><input type="password" id="adminPassword" placeholder="×¡×™×¡××”"></div><button onclick="checkAdminLogin()">×”×ª×—×‘×¨</button><p id="adminLoginError" style="color: var(--accent-color); display: none; margin-top: 10px;">×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª ×©×’×•×™×™×.</p></div></div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.error('SW registration failed:', err));
            }
            initializeApp();
            setTimeout(() => {
                document.getElementById('splash-screen').classList.add('hidden');
                document.body.classList.add('loaded');
            }, 1500);
        });
        
        // --- GLOBAL STATE & CONFIG ---
        const SHEET_ID = '1LM1rUju2EXcdKb97HbfYguanHJ6YGxULKAvQLvxPQhU';
        const API_KEY = 'AIzaSyBFtr1lU60IdVR1hSlDzGBUHz5gfxk5urI'; // For READ-ONLY access
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxpsy3z-M3z59dmJqzKARbwATqay7zhI2EAaETfqhcs53ysfy1X6vlzhyXEIMu33DRL/exec';
        
        const WHATSAPP_PASSWORD = "1125";
        const ADMIN_PASSWORD = "1125";

        let allOrders = [];
        let morningChartInstance = null;
        
        // --- INITIALIZATION ---
        async function initializeApp() {
            allOrders = await fetchAllActiveOrders();
            renderDashboard();
            setupNavListeners();
            activatePageAndNav('mainPage', 'main-nav-button');
            document.getElementById('createOrderForm').addEventListener('submit', handleCreateOrder);
        }

        // --- DATA FETCHING ---
        async function fetchAllActiveOrders() {
            const sheetName = '×”×–×× ×•×ª ×¤×¢×™×œ×•×ª (×¨××©×™)';
            const range = `${sheetName}!A2:L`; // ×§×¨×™××ª ×›×œ ×”×¢××•×“×•×ª
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                return (data.values || [])
                    .filter(row => row.length > 0) // Ensure row is not empty
                    .map(row => ({ 
                        id: row[0], // ×—×•×ª××ª ×–××Ÿ ×›××–×”×” ×™×™×—×•×“×™
                        driverName: row[1], date: row[2], time: row[3], warehouse: row[4], 
                        status: row[5], customer: row[6], address: row[7], 
                        operationType: row[8] || '×”×•×‘×œ×”'
                    }))
                    .sort((a, b) => parseTimeForSorting(a.time) - parseTimeForSorting(b.time));
            } catch (error) {
                console.error("Error fetching data:", error);
                alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×. ×™×™×ª×›×Ÿ ×©×”××¤×œ×™×§×¦×™×” ×ª×¦×™×’ ××™×“×¢ ×œ× ×¢×“×›× ×™.");
                return [];
            }
        }
        
        // --- UI RENDERING ---
        function renderDashboard() {
            const aliOrders = allOrders.filter(o => o.driverName === '×¢×œ×™');
            const hakmatOrders = allOrders.filter(o => o.driverName === '×—×›××ª');

            renderOrders(aliOrders, "aliTimeline", "×¢×œ×™");
            renderOrders(hakmatOrders, "hakmatTimeline", "×—×›××ª");
            updateSummaryCounts(aliOrders.length, hakmatOrders.length);
            renderMorningChart(aliOrders, hakmatOrders);
        }
        
        function renderOrders(orders, containerId, driverName = null) {
            const container = document.getElementById(containerId);
            container.innerHTML = orders.length > 0 ? orders.map(order => `
                <div class="order-card ${driverName || ''}" onclick='showOrderDetails(${JSON.stringify(order)})'>
                    <div class="order-time"><i class="far fa-clock"></i> ${order.time || 'N/A'} [${order.status}]</div>
                    <div class="order-details">
                        <p><strong><i class="fas fa-user"></i> ×œ×§×•×—:</strong> ${order.customer || 'N/A'}</p>
                        <p><strong><i class="fas fa-map-marker-alt"></i> ×›×ª×•×‘×ª:</strong> ${order.address || 'N/A'}</p>
                    </div>
                </div>`).join('') : "<p>××™×Ÿ ×”×–×× ×•×ª ×–××™× ×•×ª.</p>";
        }

        function updateSummaryCounts(aliCount, hakmatCount) {
            document.getElementById('aliOrderCount').textContent = aliCount;
            document.getElementById('hakmatOrderCount').textContent = hakmatCount;
            const totalWarehouseOrders = allOrders.filter(o => o.warehouse && o.warehouse.trim() !== '').length;
            document.getElementById('totalWarehouseOrderCount').textContent = totalWarehouseOrders;
        }

        function renderMorningChart(aliOrders, hakmatOrders) {
            const sixAM = new Date(); sixAM.setHours(6, 0, 0, 0);
            const nineAM = new Date(); nineAM.setHours(9, 0, 0, 0);
            const isMorning = (order) => {
                 const orderTime = parseTimeForSorting(order.time);
                 return (orderTime >= sixAM && orderTime <= nineAM) || (order.time || "").includes("×‘×™×—×“");
            };
            const aliMorning = aliOrders.filter(isMorning).length;
            const hakmatMorning = hakmatOrders.filter(isMorning).length;

            const ctx = document.getElementById('morningOrdersChart').getContext('2d');
            if(morningChartInstance) morningChartInstance.destroy();
            morningChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['×¢×œ×™', '×—×›××ª'], datasets: [{ label: '×”×–×× ×•×ª ×‘×•×§×¨', data: [aliMorning, hakmatMorning], backgroundColor: ['rgba(135, 206, 235, 0.8)', 'rgba(178, 235, 242, 0.8)'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        function renderAdminOrderList() {
            const container = document.getElementById('adminOrderList');
            container.innerHTML = allOrders.length > 0 ? allOrders.map(order => `
                <div class="order-card">
                    <div class="order-details">
                        <p><strong>× ×”×’:</strong> ${order.driverName}</p>
                        <p><strong>×œ×§×•×—:</strong> ${order.customer}</p>
                        <p><strong>×¡×˜×˜×•×¡:</strong> ${order.status}</p>
                    </div>
                    <div class="status-controls">
                         <button class="status-btn in-progress" onclick="updateStatus('${order.id}', '×‘×˜×™×¤×•×œ')">×‘×˜×™×¤×•×œ</button>
                         <button class="status-btn complete" onclick="updateStatus('${order.id}', '×”×•×©×œ×')">×”×•×©×œ×</button>
                    </div>
                </div>
            `).join('') : "<p>××™×Ÿ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª.</p>";
        }
        
        // --- NAVIGATION & PAGE LOGIC ---
        function activatePageAndNav(pageId, navId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            
            const page = document.getElementById(pageId);
            if(page) page.classList.add('active');
            
            document.querySelectorAll(`[data-nav-id="${navId}"]`).forEach(b => b.classList.add('active'));
            document.getElementById('headerTitle').textContent = pageId === 'adminPage' ? 'ğŸ› ï¸ ×“×©×‘×•×¨×“ × ×™×”×•×œ' : 'ğŸš› ×“×•×— ×‘×•×§×¨';

            if (pageId === 'adminPage') renderAdminOrderList();
            if(pageId === 'hakmatPage' || pageId === 'aliPage'){
                 const driverName = (pageId === 'hakmatPage') ? '×—×›××ª' : '×¢×œ×™';
                 const orders = allOrders.filter(o => o.driverName === driverName);
                 const avatar = (pageId === 'hakmatPage') ? 'https://i.postimg.cc/d3S0NJJZ/Screenshot-20250623-200646-Facebook.jpg' : 'https://i.postimg.cc/tCNbgXK3/Screenshot-20250623-200744-Tik-Tok.jpg';
                 page.innerHTML = `<div class="driver-section-title"><img src="${avatar}" alt="${driverName}" class="driver-avatar">× ×”×’: ${driverName}</div><div id="${driverName}OnlyTimeline" class="timeline-grid"></div>`;
                 renderOrders(orders, `${driverName}OnlyTimeline`, driverName);
            }
        }

        function setupNavListeners() {
            document.querySelectorAll('.nav-button:not(.warehouse-button)').forEach(button => {
                button.onclick = () => {
                    button.dataset.pageId === 'adminPage' ? showAdminLoginModal() : activatePageAndNav(button.dataset.pageId, button.dataset.navId);
                };
            });
            document.querySelector('.nav-button.warehouse-button').onclick = (e) => e.currentTarget.classList.toggle('active');
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.onclick = (e) => {
                    e.stopPropagation();
                    const type = item.dataset.warehouseType;
                    const page = document.getElementById('warehousePage');
                    activatePageAndNav('warehousePage', 'warehouse-nav-button');
                    const filtered = allOrders.filter(o => o.warehouse === type);
                    page.innerHTML = `<div class="driver-section-title"><i class="fas fa-boxes"></i>××—×¡×Ÿ: ${type}</div><div id="warehouseTimeline" class="timeline-grid"></div>`;
                    renderOrders(filtered, 'warehouseTimeline');
                    document.querySelector('.nav-button.warehouse-button').classList.remove('active');
                };
            });
        }
        
        // --- MODALS & USER ACTIONS ---
        function showOrderDetails(order) {
            Object.keys(order).forEach(key => {
                const el = document.getElementById(`modal${key.charAt(0).toUpperCase() + key.slice(1)}`);
                if (el) el.textContent = order[key] || 'N/A';
            });
            document.getElementById('orderDetailsModal').classList.add('visible');
        }
        
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('visible'); }
        function showPasswordModal() { document.getElementById('passwordModal').classList.add('visible'); }
        function checkPassword() {
            if (document.getElementById('passwordInput').value === WHATSAPP_PASSWORD) {
                closeModal('passwordModal');
                shareToWhatsApp(allOrders.filter(o => o.driverName === '×¢×œ×™'), allOrders.filter(o => o.driverName === '×—×›××ª'));
            } else {
                document.getElementById('passwordError').style.display = 'block';
            }
        }
        function shareToWhatsApp(aliOrders, hakmatOrders) {
            const format = (orders, name) => orders.length > 0 ? `*${name}*\n` + orders.map(o => `â° ${o.time} | ğŸ‘¤ ${o.customer} | ğŸ“ ${o.address}`).join('\n') : `*${name}*\n××™×Ÿ ×”×–×× ×•×ª.`;
            const fullMessage = `*ğŸ“‹ ×“×•×— ×‘×•×§×¨ - ×¡×™×›×•×*\n\n${format(aliOrders, "×¢×œ×™")}\n\n${format(hakmatOrders, "×—×›××ª")}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(fullMessage)}`, "_blank");
        }

        // --- ADMIN ACTIONS ---
        function showAdminLoginModal() {
            document.getElementById('adminLoginError').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLoginModal').classList.add('visible');
        }
        function checkAdminLogin() {
            if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
                closeModal('adminLoginModal');
                activatePageAndNav('adminPage', 'admin-nav-button');
            } else {
                document.getElementById('adminLoginError').style.display = 'block';
            }
        }

        async function handleCreateOrder(event) {
            event.preventDefault();
            const btn = document.getElementById('createOrderBtn');
            btn.disabled = true;
            btn.textContent = '×©×•×œ×—...';
            
            const orderData = {
                driverName: document.getElementById('orderDriver').value,
                date: document.getElementById('orderDate').value,
                time: document.getElementById('orderTime').value,
                customer: document.getElementById('orderCustomer').value,
                address: document.getElementById('orderAddress').value,
                warehouse: document.getElementById('orderWarehouse').value,
                operationType: document.getElementById('orderOperationType').value,
                status: '×—×“×©×”'
            };
            
            const result = await postToBackend('addOrder', orderData);
            if (result.status === 'success') {
                alert('×”×”×–×× ×” × ×•×¦×¨×” ×•× ×©×œ×—×” ×”×ª×¨××” ×‘×”×¦×œ×—×”!');
                event.target.reset();
                await initializeApp(); // Refresh all data
            } else {
                alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×”×–×× ×”: ' + result.message);
            }
            btn.disabled = false;
            btn.textContent = '×¦×•×¨ ×”×–×× ×” ×•×©×œ×— ×”×ª×¨××”';
        }

        async function updateStatus(orderId, newStatus) {
            const result = await postToBackend('updateStatus', { orderId, newStatus });
             if (result.status === 'success') {
                alert('×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ!');
                await initializeApp(); // Refresh all data
                renderAdminOrderList(); // Re-render admin list specifically
            } else {
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¡×˜×˜×•×¡: ' + result.message);
            }
        }

        function shareTomorrowReport() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowDateString = tomorrow.toISOString().split('T')[0]; // YYYY-MM-DD
            
            const isTomorrow = (dateStr) => {
                if (!dateStr) return false;
                // Convert DD/MM/YYYY to YYYY-MM-DD for comparison
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}` === tomorrowDateString;
                }
                return false;
            };

            const aliTomorrow = allOrders.filter(o => o.driverName === '×¢×œ×™' && isTomorrow(o.date));
            const hakmatTomorrow = allOrders.filter(o => o.driverName === '×—×›××ª' && isTomorrow(o.date));
            
            if (aliTomorrow.length === 0 && hakmatTomorrow.length === 0) {
                alert('×œ× × ××¦××• ×”×–×× ×•×ª ×œ××—×¨.'); return;
            }
            shareToWhatsApp(aliTomorrow, hakmatTomorrow);
        }

        // --- UTILITIES ---
        function parseTimeForSorting(timeStr) {
            if (!timeStr) return new Date(0);
            if (timeStr.includes("×‘×™×—×“")) { const d = new Date(); d.setHours(7,0,0,0); return d; }
            const [h, m] = (timeStr.split(':') || [0,0]).map(Number);
            const d = new Date(); d.setHours(h, m, 0, 0); return d;
        }

        async function postToBackend(action, data) {
             if (BACKEND_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL') {
                alert('×©×’×™××ª ×”×’×“×¨×”: ×™×© ×œ×¢×“×›×Ÿ ××ª ×›×ª×•×‘×ª ×”-BACKEND_URL ×‘×§×•×“.');
                return { status: 'error', message: 'Backend URL not configured.' };
            }
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Apps Script requires this for simple POST
                    body: JSON.stringify({ action, data })
                });
                // With no-cors, we can't inspect the response, so we assume success
                // Error handling should be robust inside the Apps Script itself (e.g., sending an email on failure)
                return { status: 'success' };
            } catch (error) {
                console.error('Backend Error:', error);
                return { status: 'error', message: error.toString() };
            }
        }
    </script>
</body>
</html>

