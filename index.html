<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>DeliveryMaster - ×¡×™×“×•×¨ ×¢×‘×•×“×”</title>
    
    <!-- PWA and Mobile Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4587de">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/2jQvCKxs/Screenshot-20250508-230911-Gallery.jpg">

    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Google Maps API with Key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbVYMijMs8zH6m4iiSiBfn_RiCMuau9ps&libraries=routes&language=he"></script>

    <style>
        :root {
            --primary-color: #87CEEB;
            --secondary-color: #4587de;
            --dark-color: #2C3E50;
            --light-color: #F8F8F8;
            --text-color: #333;
            --shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            --glass-bg: rgba(255, 255, 255, 0.8);
            --whatsapp-color: #25D366;
        }

        html, body {
            overscroll-behavior-y: contain;
            height: 100%;
            width: 100%;
            overflow: hidden;
            margin: 0;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--light-color);
            color: var(--text-color);
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://i.postimg.cc/2jQvCKxs/Screenshot-20250508-230911-Gallery.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: 0.7;
            z-index: -1;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 15px 0;
            box-shadow: var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            border-radius: 0 0 30px 30px;
            text-align: center;
        }
        .app-header h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .main-content {
            flex: 1;
            padding: 90px 15px 15px 15px; /* Adjusted top padding */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .filter-container {
            padding-bottom: 15px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .filter-container::-webkit-scrollbar {
            height: 4px;
        }
        .filter-container::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }

        .filter-btn {
            display: inline-block;
            padding: 8px 15px;
            margin-left: 8px;
            border-radius: 20px;
            background: var(--glass-bg);
            border: 1px solid rgba(0,0,0,0.1);
            color: var(--dark-color);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .filter-btn.active {
            background: var(--secondary-color);
            color: white;
            transform: scale(1.05);
        }

        .driver-section-header {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 20px 0 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 10px 20px;
            border-radius: 50px;
            background-color: var(--light-color);
            box-shadow: var(--shadow);
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
        }
        
        .driver-section-header:active {
            transform: scale(0.98);
        }

        .driver-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }
        
        .timeline-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 10px 0;
            margin: 0 auto;
            width: 100%;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }

        .timeline-grid.expanded {
            max-height: 2000px; /* Large enough to accommodate orders */
        }
        
        .order-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.18);
            padding: 15px;
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 10px;
            cursor: pointer;
        }

        .order-time {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--dark-color);
            border-bottom: 1px dashed rgba(0,0,0,0.1);
            padding-bottom: 10px;
        }
        .order-details p {
            margin: 4px 0;
            font-size: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .order-details i {
            margin-top: 3px;
        }
        .order-details strong {
             min-width: 85px; /* Increased width to align text */
        }
        .travel-time-data .fa-spinner {
            font-size: 0.9em;
            color: var(--secondary-color);
        }

        /* Modal styling */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; opacity: 0; transition: opacity 0.3s ease; align-items: center; justify-content: center; padding: 20px; }
        .modal.show { display: flex; opacity: 1; }
        .modal-content { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 16px; box-shadow: var(--shadow); max-width: 500px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.3); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-size: 1.3rem; }
        .modal-close-btn { background: none; border: none; font-size: 1.8rem; color: #555; cursor: pointer; }
        .modal-body { padding: 20px; overflow-y: auto; }
        #commentsContainer { margin-top: 15px; max-height: 250px; overflow-y: auto; background: rgba(0,0,0,0.05); border-radius: 8px; padding: 10px; }
        .comment { background-color: #f1f5f9; border-radius: 12px; padding: 10px 15px; margin-bottom: 8px;}
        .comment.own { background-color: #e0f2fe; }
        .comment p { margin: 0; }
        .comment .author { font-weight: 500; font-size: 0.9rem; }
        #commentForm { margin-top: 15px; display: flex; gap: 10px; }
        #commentForm input { flex-grow: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
        #commentForm button { padding: 10px 15px; border-radius: 8px; background: var(--secondary-color); color: white; border: none; cursor: pointer; }
        
        /* Loader */
        .loader-overlay { position: absolute; inset: 0; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(2px); z-index: 999; display: none; align-items: center; justify-content: center; }
        .loader-overlay.show { display: flex; }
        .loader { font-size: 2rem; color: var(--secondary-color); animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* WhatsApp Floating Action Button */
        .whatsapp-fab {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
            background-color: var(--whatsapp-color);
            color: white;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.2s, background-color 0.2s;
        }
        .whatsapp-fab:active {
            transform: scale(0.95);
        }
        .whatsapp-fab.loading {
            background-color: #555;
            cursor: not-allowed;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }

    </style>
</head>
<!-- OneSignal SDK for Push Notifications -->				
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>				
<script>				
window.OneSignalDeferred = window.OneSignalDeferred || [];				
OneSignalDeferred.push(async function(OneSignal) {				
await OneSignal.init({				
appId: "acc8a2bc-d54e-4261-b3d2-cc5c5f7b39d3",				
safari_web_id: "web.onesignal.auto.5f4f9ed9-fb2e-4d6a-935d-81aa46fccce0",				
notifyButton: {				
enable: true,				
},				
});				
});				
</script>			
    <body>
    <div class="app-container">
        <header class="app-header">
            <h1>ğŸ“‹ ×¡×™×“×•×¨ ×¢×‘×•×“×”</h1>
        </header>

        <main class="main-content">
            <div id="filterContainer" class="filter-container"></div>
            <div id="ordersContainer"></div>
        </main>
        
        <div id="loader" class="loader-overlay show">
            <i class="fas fa-spinner loader"></i>
        </div>

        <button id="shareReportBtn" class="whatsapp-fab" title="×©×ª×£ ×“×•×— ×œ××—×¨">
            <i class="fab fa-whatsapp"></i>
        </button>
    </div>

    <!-- Modal for Order Details -->
    <div id="orderDetailsModal" class="modal">
        <div class="modal-content" id="modalContent">
            <!-- Content injected by JS -->
        </div>
    </div>
    
    <!-- Modal for Password -->
    <div id="passwordModal" class="modal">
        <div class="modal-content" style="max-width: 350px; text-align: center;">
            <div class="modal-header">
                <h2>××™××•×ª × ×“×¨×©</h2>
                <button onclick="closeModal('passwordModal')" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p>×™×© ×œ×”×–×™×Ÿ ×¡×™×¡××” ×›×“×™ ×œ×©×ª×£ ××ª ×”×“×•×—.</p>
                <input type="password" id="passwordInput" placeholder="×¡×™×¡××”" style="width: 90%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 8px; text-align: center; font-size: 1.1rem;">
                <button id="submitPasswordBtn" style="width: 100%; padding: 12px; font-size: 1rem; background: var(--secondary-color); color: white; border: none; border-radius: 8px; cursor: pointer;">××™×©×•×¨</button>
                <p id="passwordError" style="color: red; display: none; margin-top: 10px;">×¡×™×¡××” ×©×’×•×™×”.</p>
            </div>
        </div>
    </div>


    <script>
        // *** UNIFIED API URL from sidor94 project ***
        const API_URL = 'https://script.google.com/macros/s/AKfycby_VQ0cAMNBGbCPJVHibQ-k32n0L2pM0NqnhgT27T5jIoKVCbxA8cGmGLspKY7eZvxU/exec';
        
        const ordersContainer = document.getElementById('ordersContainer');
        const filterContainer = document.getElementById('filterContainer');
        const loader = document.getElementById('loader');
        const modal = document.getElementById('orderDetailsModal');
        const passwordModal = document.getElementById('passwordModal');
        
        let allHistoryOrders = [], userName = '', distanceMatrixService;
        let activeFilters = { deliveryType: null };

        const WHATSAPP_PASSWORD = "1234";

        const driverInfo = {
            '×¢×œ×™': { img: 'https://i.postimg.cc/tCNbgXK3/Screenshot-20250623-200744-Tik-Tok.jpg' },
            '×—×›××ª': { img: 'https://i.postimg.cc/d3S0NJJZ/Screenshot-20250623-200646-Facebook.jpg' }
        };

        const warehouseLocations = {
            '×”×—×¨×©': { lat: 32.0553, lng: 34.7852 }, // Approx. HaHarash, Tel Aviv
            '×”×ª×œ××™×“': { lat: 32.0950, lng: 34.7855 }  // Approx. HaTalmid, Tel Aviv
        };

        async function apiFetch(action, params = {}) {
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Network error for action: ${action}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                return result.data;
            } catch (error) {
                console.error(`API Fetch Error (${action}):`, error);
                alert(`×©×’×™××ª ×ª×§×©×•×¨×ª: ${error.message}`);
                throw error;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            userName = localStorage.getItem('deliveryMasterViewerName') || '××•×¨×—';
            if (window.google) {
                distanceMatrixService = new google.maps.DistanceMatrixService();
            }
            setupEventListeners();
            loadInitialData();
        });
        
        function setupEventListeners() {
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('show');
                }
            });
            document.getElementById('shareReportBtn').addEventListener('click', () => {
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordError').style.display = 'none';
                passwordModal.classList.add('show');
            });
            document.getElementById('submitPasswordBtn').addEventListener('click', checkPasswordAndShare);
        }
        
        function checkPasswordAndShare() {
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            if (passwordInput.value === WHATSAPP_PASSWORD) {
                passwordError.style.display = 'none';
                closeModal('passwordModal');
                shareDailyReportToWhatsApp();
            } else {
                passwordError.style.display = 'block';
                const modalContent = passwordModal.querySelector('.modal-content');
                modalContent.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    modalContent.style.animation = '';
                }, 500);
            }
        }

        async function loadInitialData() {
            showLoader(true);
            try {
                const todayStr = new Date().toISOString().split('T')[0];
                allHistoryOrders = await apiFetch('getOrders', { date: todayStr });
                
                renderFilterControls();
                await displayFilteredOrders();

            } catch (error) {
                ordersContainer.innerHTML = `<div class="p-4 text-center text-red-600">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ${error.message}</div>`;
            } finally {
                showLoader(false);
            }
        }

        function renderFilterControls() {
            const deliveryTypes = ['×”×›×œ', ...new Set(allHistoryOrders.map(o => o.deliveryType).filter(Boolean))];
            filterContainer.innerHTML = deliveryTypes.map(type => 
                `<button class="filter-btn ${type === '×”×›×œ' ? 'active' : ''}" data-type="${type}">${type}</button>`
            ).join('');

            filterContainer.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    filterContainer.querySelector('.filter-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    const type = btn.dataset.type;
                    activeFilters.deliveryType = type === '×”×›×œ' ? null : type;
                    displayFilteredOrders();
                });
            });
        }
        
        async function displayFilteredOrders() {
            let filtered = [...allHistoryOrders];

            if (activeFilters.deliveryType) {
                filtered = filtered.filter(o => o.deliveryType === activeFilters.deliveryType);
            }
            
            const ordersByDriver = filtered.reduce((acc, order) => {
                const driver = order.driverId || '×œ× ××©×•×™×š';
                if (!acc[driver]) {
                    acc[driver] = [];
                }
                acc[driver].push(order);
                return acc;
            }, {});

            await renderDriverSections(ordersByDriver);
        }

        async function renderDriverSections(ordersByDriver) {
            ordersContainer.innerHTML = ''; 

            const sortedDrivers = Object.keys(ordersByDriver).sort((a, b) => {
                const aHasInfo = !!driverInfo[a];
                const bHasInfo = !!driverInfo[b];
                if (aHasInfo && !bHasInfo) return -1;
                if (!aHasInfo && bHasInfo) return 1;
                return a.localeCompare(b);
            });
            
            const travelTimePromises = [];

            for (const driver of sortedDrivers) {
                const orders = ordersByDriver[driver];
                const driverImg = driverInfo[driver]?.img || 'https://placehold.co/100x100/ccc/fff?text=ğŸ‘¤';
                
                const section = document.createElement('div');
                section.innerHTML = `
                    <div class="driver-section-header">
                        <img src="${driverImg}" alt="×ª××•× ×ª × ×”×’" class="driver-avatar">
                        <span>${driver} (${orders.length})</span>
                    </div>
                    <div class="timeline-grid"></div>
                `;
                ordersContainer.appendChild(section);

                const timelineGrid = section.querySelector('.timeline-grid');
                orders.sort((a, b) => (a.orderTime || "00:00").localeCompare(b.orderTime || "00:00"));
                orders.forEach(order => {
                    timelineGrid.innerHTML += createOrderCardHTML(order);
                    if (distanceMatrixService) {
                        travelTimePromises.push(calculateAndDisplayTravelTime(order));
                    }
                });

                const header = section.querySelector('.driver-section-header');
                header.addEventListener('click', () => {
                    timelineGrid.classList.toggle('expanded');
                });
            }
            await Promise.all(travelTimePromises);
        }
        
        function createOrderCardHTML(order) {
            return `
                <div class="order-card" onclick="openOrderModal('${order.orderId}')">
                    <div class="order-time"><i class="far fa-clock"></i> ${order.orderTime || 'N/A'}</div>
                    <div class="order-details">
                        <p><strong><i class="fas fa-user"></i> ×œ×§×•×—:</strong> ${order.customerName || 'N/A'}</p>
                        <p><strong><i class="fas fa-map-marker-alt"></i> ×›×ª×•×‘×ª:</strong> ${order.address || 'N/A'}</p>
                        <p><strong><i class="fas fa-truck"></i> ×¡×•×’:</strong> ${order.deliveryType || 'N/A'}</p>
                        <p><strong><i class="fas fa-route"></i> ×–××Ÿ × ×¡×™×¢×”:</strong> <span class="travel-time-data" data-order-id="${order.orderId}"><i class="fas fa-spinner fa-spin"></i></span></p>
                    </div>
                </div>
            `;
        }

        function calculateAndDisplayTravelTime(order) {
            return new Promise(resolve => {
                const travelTimeSpan = document.querySelector(`.travel-time-data[data-order-id="${order.orderId}"]`);
                const origin = warehouseLocations[order.warehouse];

                if (!travelTimeSpan || !origin || !order.address) {
                    if (travelTimeSpan) travelTimeSpan.textContent = '×œ× ×–××™×Ÿ';
                    resolve();
                    return;
                }

                distanceMatrixService.getDistanceMatrix({
                    origins: [origin],
                    destinations: [order.address],
                    travelMode: 'DRIVING',
                }, (response, status) => {
                    if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                        const duration = response.rows[0].elements[0].duration.text;
                        travelTimeSpan.textContent = duration;
                    } else {
                        travelTimeSpan.textContent = '×›×ª×•×‘×ª ×œ× × ××¦××”';
                        console.warn('Distance Matrix error:', status, response);
                    }
                    resolve();
                });
            });
        }
        
        async function openOrderModal(orderId) {
            const content = document.getElementById('modalContent');
            content.innerHTML = '<div class="p-8 text-center"><i class="fas fa-spinner loader"></i></div>';
            modal.classList.add('show');
            
            try {
                const order = allHistoryOrders.find(o => o.orderId === orderId);
                if (!order) {
                    throw new Error('×”×”×–×× ×” ×œ× × ××¦××”');
                }
                const comments = await apiFetch('getComments', { orderId });

                content.innerHTML = `
                    <div class="modal-header">
                        <h2>×¤×¨×˜×™ ×”×–×× ×”: ${order.customerName}</h2>
                        <button onclick="closeModal('orderDetailsModal')" class="modal-close-btn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p><strong><i class="fas fa-info-circle"></i> ×¡×˜×˜×•×¡:</strong> ${order.status || 'N/A'}</p>
                        <p><strong><i class="fas fa-truck"></i> × ×”×’:</strong> ${order.driverId || 'N/A'}</p>
                        <p><strong><i class="far fa-calendar-alt"></i> ×ª××¨×™×š:</strong> ${new Date(order.orderDate).toLocaleDateString('he-IL')}</p>
                        
                        <div style="margin-top: 15px;">
                            <strong><i class="fas fa-map-marked-alt"></i> ××™×§×•×:</strong>
                            <div id="orderMapModal" style="height: 200px; width: 100%; border-radius: 12px; margin-top: 5px; background-color: #e9e9e9;"></div>
                        </div>

                        <div class="mt-4" style="margin-top: 15px;">
                            <h3 style="font-weight: bold; margin-bottom: 10px;">×”×¢×¨×•×ª:</h3>
                            <div id="commentsContainer">
                                ${(comments || []).map(c => `
                                    <div class="comment ${c.author === userName ? 'own' : ''}">
                                        <p class="author">${c.author || '×œ× ×™×“×•×¢'}</p>
                                        <p>${c.text || ''}</p>
                                    </div>`).join('') || '<p>××™×Ÿ ×”×¢×¨×•×ª.</p>'}
                            </div>
                            <form id="commentForm" class="mt-4">
                                <input type="text" id="commentInput" placeholder="×”×•×¡×£ ×”×¢×¨×”..." required>
                                <button type="submit">×©×œ×—</button>
                            </form>
                        </div>
                    </div>`;
                
                document.getElementById('commentForm').addEventListener('submit', (e) => handleCommentSubmit(e, orderId));

                const mapContainer = document.getElementById('orderMapModal');
                if (order.latitude && order.longitude) {
                    const lat = parseFloat(order.latitude);
                    const lon = parseFloat(order.longitude);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        setTimeout(() => {
                            try {
                                const map = L.map(mapContainer).setView([lat, lon], 15);
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                    attribution: 'Â© OpenStreetMap'
                                }).addTo(map);
                                L.marker([lat, lon]).addTo(map).bindPopup(order.address).openPopup();
                                map.invalidateSize();
                            } catch(e) {
                                mapContainer.innerHTML = `<div style="text-align: center; padding: 20px;">×©×’×™××” ×‘×”×¦×’×ª ×”××¤×”.</div>`;
                                console.error("Leaflet error:", e);
                            }
                        }, 100);
                    } else {
                         mapContainer.innerHTML = `<div style="text-align: center; padding-top: 80px; color: #555;">×§×•××•×¨×“×™× ×˜×•×ª ×œ× ×ª×§×™× ×•×ª</div>`;
                    }
                } else {
                    const googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(order.address)}`;
                    mapContainer.innerHTML = `<div style="text-align: center; padding: 20px; color: #555;">
                        ××™×§×•× ×œ× ×–××™×Ÿ ×‘××¤×”.<br>
                        <strong>${order.address || '×œ× ×¦×•×™× ×” ×›×ª×•×‘×ª'}</strong><br><br>
                        <a href="${googleMapsLink}" target="_blank" style="color: var(--secondary-color); text-decoration: none; font-weight: 500;">×¤×ª×— ×‘-Google Maps <i class="fas fa-external-link-alt"></i></a>
                    </div>`;
                }

            } catch (error) {
                content.innerHTML = `<div class="p-8 text-center text-red-500">${error.message} <button onclick="closeModal('orderDetailsModal')">×¡×’×•×¨</button></div>`;
            }
        }
        
        async function shareDailyReportToWhatsApp() {
            const btn = document.getElementById('shareReportBtn');
            btn.classList.add('loading');
            btn.disabled = true;

            try {
                // Fetch tomorrow's orders
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                const tomorrowOrders = await apiFetch('getOrders', { date: tomorrowStr });

                if (tomorrowOrders.length === 0) {
                    alert('×œ× × ××¦××• ×”×–×× ×•×ª ×œ××—×¨.');
                    return;
                }
                
                // Group by driver
                const ordersByDriver = tomorrowOrders.reduce((acc, order) => {
                    const driver = order.driverId || '×œ× ××©×•×™×š';
                    if (!acc[driver]) acc[driver] = [];
                    acc[driver].push(order);
                    return acc;
                }, {});

                // Build message
                let message = `*×“×•×— ×‘×•×§×¨ ×œ××—×¨* ğŸ“‹\n\n`;
                
                const sortedDrivers = Object.keys(ordersByDriver).sort();

                for(const driver of sortedDrivers) {
                    const orders = ordersByDriver[driver];
                    orders.sort((a, b) => (a.orderTime || "00:00").localeCompare(b.orderTime || "00:00"));
                    message += `*× ×”×’: ${driver}* (${orders.length} ×”×–×× ×•×ª)\n`;
                    orders.forEach(o => {
                        message += `â° ${o.orderTime || ''} | ğŸ‘¤ ${o.customerName || ''} | ğŸ“ ${o.address || ''}\n`;
                    });
                    message += '\n';
                }

                message += `--------------------\n`;
                message += `*×œ×¦×¤×™×™×” ×‘×¡×™×“×•×¨ ×”××œ× ×•×¢×“×›×•× ×™× ×‘×–××Ÿ ×××ª, ×”×™×›× ×¡×• ×œ××¤×œ×™×§×¦×™×”:*\n`;
                message += window.location.href;

                // Create WhatsApp link and open it
                const phoneNumber = '972508860896';
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                
                window.open(whatsappUrl, '_blank');

            } catch (error) {
                alert('×©×’×™××” ×‘×”×›× ×ª ×”×“×•×—: ' + error.message);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        async function handleCommentSubmit(e, orderId) {
            e.preventDefault();
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            if (!text) return;
            
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const postApiUrl = 'https://script.google.com/macros/s/AKfycby_VQ0cAMNBGbCPJVHibQ-k32n0L2pM0NqnhgT27T5jIoKVCbxA8cGmGLspKY7eZvxU/exec';
                await fetch(postApiUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'postComment', data: { orderId, author: userName, text } }),
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' }
                });
                await openOrderModal(orderId);
            } catch (error) {
                alert(`×©×’×™××” ×‘×©×œ×™×—×ª ×ª×’×•×‘×”: ${error.message}`);
                btn.disabled = false;
                btn.textContent = '×©×œ×—';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showLoader(show) {
            loader.classList.toggle('show', show);
        }
    </script>
</body>
</html>

