<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>סידור ח.סבן</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1A73E8">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/d1G4bWzG/1000158179.jpg">
    <link rel="icon" href="https://i.postimg.cc/d1G4bWzG/1000158179.jpg" type="image/jpeg">
    <link rel="manifest" href="manifest.json">

    <!-- Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #1A73E8; /* Google Blue */
            --secondary-color: #34A853; /* Google Green */
            --dark-color: #202124; /* Google Dark Gray */
            --light-color: #F8F9FA; /* Google Light Gray */
            --text-color: #3C4043;
            --white-color: #FFFFFF;
            --danger-color: #EA4335; /* Google Red */
            --warning-color: #FBBC04; /* Google Yellow */
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        html { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        *, *:before, *:after { box-sizing: inherit; }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--light-color);
            color: var(--text-color);
            margin: 0;
            padding: 70px 0 80px 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior-y: contain;
        }

        .page { display: none; animation: fadeIn 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header {
            background: var(--white-color);
            color: var(--dark-color);
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
        }
        .header h1 { margin: 0; font-size: 1.4rem; font-weight: 500; }
        .header p { margin: 4px 0 0; font-size: 0.8rem; color: #5f6368; }

        .content-padding { padding: 15px; }
        
        .loader {
            text-align: center;
            padding: 50px;
            font-size: 1.1rem;
            color: #5f6368;
        }
        .loader i {
            font-size: 2.5rem;
            color: var(--primary-color);
            display: block;
            margin-bottom: 15px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .order-card { 
            background: var(--white-color); 
            border-radius: 12px; 
            margin-bottom: 15px; 
            box-shadow: var(--shadow);
            border: 1px solid #DADCE0;
            overflow: hidden;
        }
        .order-card .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 15px;
            background-color: #F1F3F4;
        }
        .order-card .customer-name { font-weight: 500; font-size: 1.1rem; color: var(--dark-color); }
        .order-card .order-time { font-weight: 500; font-size: 1rem; color: var(--primary-color); }
        .order-card .card-body { padding: 15px; font-size: 0.95rem; }
        .order-card .card-body p { margin: 10px 0; display: flex; align-items: center; gap: 12px; }
        .order-card .card-body i { color: #5f6368; width: 20px; text-align: center; }

        .driver-section-title { 
            font-size: 1.4rem; 
            font-weight: 500; 
            margin-bottom: 15px; 
            color: var(--dark-color); 
            display: flex; 
            align-items: center; 
            gap: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #DADCE0;
        }
        .driver-avatar { 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 2px solid var(--primary-color);
            flex-shrink: 0;
        }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--white-color); box-shadow: 0 -2px 5px rgba(0,0,0,0.08); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #DADCE0; z-index: 1000; }
        .nav-button { background: none; border: none; color: #5f6368; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; font-family: 'Rubik', sans-serif; transition: all 0.2s ease; flex-grow: 1; }
        .nav-button i { font-size: 1.4rem; }
        .nav-button.active { color: var(--primary-color); }
        .nav-button.special { transform: translateY(-20px); background: var(--primary-color); color: var(--white-color); width: 60px; height: 60px; border-radius: 50%; box-shadow: 0 4px 12px rgba(26, 115, 232, 0.4); flex-grow: 0; }
        
        #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background-color: var(--dark-color); color: var(--white-color); padding: 12px 20px; border-radius: 8px; box-shadow: var(--shadow); z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.4s ease; font-size: 0.9rem; }
        #toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-10px); }

    </style>
</head>
<body>
    <header class="header">
        <h1><img src="https://i.postimg.cc/d1G4bWzG/1000158179.jpg" alt="Logo" style="height: 24px; vertical-align: middle; border-radius: 4px;"> סידור ח.סבן</h1>
        <p id="header-date"></p>
    </header>

    <main>
        <div id="dashboardPage" class="page active content-padding">
            <div id="ali-section" style="margin-bottom: 30px;">
                <div class="driver-section-title"> <img src="https://i.postimg.cc/tCNbgXK3/Screenshot-20250623-200744-Tik-Tok.jpg" class="driver-avatar"> <span>עלי</span> </div>
                <div id="ali-timeline"><div class="loader"><i class="fas fa-spinner"></i>טוען נתונים...</div></div>
            </div>
            <div id="hakmat-section">
                <div class="driver-section-title"> <img src="https://i.postimg.cc/d3S0NJJZ/Screenshot-20250623-200646-Facebook.jpg" class="driver-avatar"> <span>חכמת</span> </div>
                <div id="hakmat-timeline"><div class="loader"><i class="fas fa-spinner"></i>טוען נתונים...</div></div>
            </div>
        </div>
        
        <div id="customersPage" class="page content-padding">
             <!-- Customer page content will go here -->
             <p>דף לקוחות בבנייה</p>
        </div>

        <div id="adminPage" class="page content-padding">
            <!-- Admin form content will go here -->
            <p>דף ניהול בבנייה</p>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="nav-button active" data-page="dashboardPage"> <i class="fas fa-clipboard-list"></i> <span>דשבורד</span> </button>
        <button class="nav-button" data-page="customersPage"> <i class="fas fa-users"></i> <span>לקוחות</span> </button>
        <button class="nav-button special" data-page="adminPage"> <i class="fas fa-plus"></i> </button>
    </nav>
    
    <div id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // This is the local endpoint for our Cloudflare Worker proxy.
            // All API requests will go through this path.
            const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyHszyq4YxLLQmGSATggvW4YxNWAP5JMtgEEQ46zidkC1KqP-xAmIET-nDD0BhD7KQx/exec';

            // --- PWA SETUP ---
            function initializePWA() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js') // Register the physical sw.js file
                     .then(reg => console.log('Service Worker Registered:', reg.scope))
                     .catch(e => console.error('SW Registration Failed:', e));
                }
            }

            // --- DATA FETCHING ---
            async function loadAllData() {
                 try {
                    // We now fetch from our own domain's API endpoint, not directly from Google.
                    const response = await fetch(API_ENDPOINT);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    if(data.error) throw new Error(data.details);
                    
                    const aliTimeline = document.getElementById('ali-timeline');
                    const hakmatTimeline = document.getElementById('hakmat-timeline');
                    
                    renderTimeline(data.aliData, aliTimeline);
                    renderTimeline(data.hakmatData, hakmatTimeline);

                } catch (error) {
                    console.error('Error fetching data via proxy:', error);
                    const errorMsg = '<p style="color:red; text-align:center;">שגיאת תקשורת. לא ניתן היה לטעון נתונים מהשרת. אנא בדוק את חיבור האינטרנט וודא שהגדרות ה-Worker נכונות.</p>';
                    document.getElementById('ali-timeline').innerHTML = errorMsg;
                    document.getElementById('hakmat-timeline').innerHTML = '';
                }
            }
            
            function renderTimeline(orders, container) {
                if (orders && orders.length > 0) {
                    container.innerHTML = '';
                    orders.forEach(order => container.appendChild(createOrderCard(order)));
                } else {
                    container.innerHTML = '<p style="text-align:center; color: #5f6368;">אין הזמנות להיום.</p>';
                }
            }

            function createOrderCard(order) {
                const card = document.createElement('div');
                card.className = 'order-card';
                // Using the actual headers from your sheet: 'לקוח', 'שעה', 'כתובת', 'מחסן'
                card.innerHTML = `
                    <div class="card-header">
                        <span class="customer-name">${order['לקוח'] || 'לא צוין'}</span>
                        <span class="order-time">${order['שעה'] || 'ביחד'}</span>
                    </div>
                    <div class="card-body">
                        <p><i class="fas fa-map-marker-alt"></i> ${order['כתובת'] || 'לא צוין'}</p>
                        <p><i class="fas fa-warehouse"></i> ${order['מחסן'] || 'לא צוין'}</p>
                    </div>`;
                return card;
            }
            
            // --- UI CONTROL ---
            function switchPage(pageId) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                const page = document.getElementById(pageId);
                if(page) page.classList.add('active');
                
                document.querySelectorAll('.nav-button').forEach(b => {
                    b.classList.toggle('active', b.dataset.page === pageId)
                });
            }
            
            document.querySelectorAll('.nav-button').forEach(b => {
                b.addEventListener('click', () => switchPage(b.dataset.page));
            });

            function init() {
                initializePWA();
                loadAllData();
                setInterval(loadAllData, 90000); // Refresh every 1.5 minutes
                document.getElementById('header-date').textContent = new Date().toLocaleDateString('he-IL', { weekday: 'long', day: 'numeric', month: 'long' });
            }

            init();
        });
    </script>
</body>
</html>

