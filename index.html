<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>住专 .住</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2C3E50">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/pdrgskSr/sa.jpg">
    <link rel="icon" href="https://i.postimg.cc/pdrgskSr/sa.jpg" type="image/jpeg">
    <link rel="manifest" href="manifest.json">

    <!-- Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- OneSignal SDK for Push Notifications -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        try {
            await OneSignal.init({
              appId: "acc8a2bc-d54e-4261-b3d2-cc5c5f7b39d3",
              safari_web_id: "web.onesignal.auto.5f4f9ed9-fb2e-4d6a-935d-81aa46fccce0",
              notifyButton: {
                enable: true,
              },
            });
        } catch (e) {
            console.error("Error initializing OneSignal:", e);
        }
      });
    </script>

    <style>
        :root {
            --primary-color: #4A90E2; /* Bright Blue */
            --secondary-color: #50E3C2; /* Aqua Green */
            --dark-color: #2C3E50; /* Dark Slate Blue */
            --light-color: #F4F7F9; /* Very light gray */
            --text-color: #333;
            --white-color: #FFFFFF;
            --danger-color: #E74C3C;
            --success-color: #2ECC71;
            --warning-color: #F39C12;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        html { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        *, *:before, *:after { box-sizing: inherit; }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--light-color);
            color: var(--text-color);
            margin: 0;
            padding: 70px 0 80px 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior-y: contain;
        }

        .page { display: none; animation: fadeIn 0.4s ease-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: var(--white-color);
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
        }
        .header h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .header p { margin: 5px 0 0; font-size: 0.9rem; opacity: 0.9; }

        .content-padding { padding: 15px; }
        
        .loader {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #888;
        }
        .loader i {
            font-size: 2rem;
            display: block;
            margin-bottom: 10px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .order-card { background: var(--white-color); border-radius: 15px; margin-bottom: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 5px solid var(--primary-color); }
        .order-card .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .order-card .customer-name { font-weight: 700; font-size: 1.2rem; color: var(--dark-color); }
        .order-card .order-time { font-weight: 500; font-size: 1.1rem; background-color: var(--light-color); padding: 5px 10px; border-radius: 20px; color: var(--primary-color); }
        .order-card .card-body p { margin: 8px 0; font-size: 0.95rem; display: flex; align-items: center; gap: 10px; }
        .order-card .card-body i { color: var(--primary-color); width: 20px; text-align: center; }
        .order-card .card-footer { margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .order-status { padding: 5px 12px; border-radius: 20px; color: var(--white-color); font-weight: 500; }
        .travel-info { color: #777; }

        .driver-section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 15px; color: var(--dark-color); display: flex; align-items: center; gap: 10px; }
        .driver-avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 2px solid var(--primary-color); 
        }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--white-color); box-shadow: 0 -5px 20px rgba(0,0,0,0.1); display: flex; justify-content: space-around; padding: 10px 0; border-top-left-radius: 20px; border-top-right-radius: 20px; z-index: 1000; }
        .nav-button { background: none; border: none; color: #aaa; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 0.75rem; font-family: 'Rubik', sans-serif; transition: color 0.2s ease, transform 0.2s ease; flex-grow: 1; }
        .nav-button i { font-size: 1.5rem; }
        .nav-button.active { color: var(--primary-color); transform: translateY(-3px); }
        .nav-button.special { transform: translateY(-20px); background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: var(--white-color); width: 60px; height: 60px; border-radius: 50%; box-shadow: var(--shadow); flex-grow: 0; }
        
        /* Add other styles as needed */
    </style>
</head>
<body>
    <header class="header">
        <h1 id="header-title">  拽专</h1>
        <p id="header-date"></p>
    </header>

    <main>
        <div id="dashboardPage" class="page active content-padding">
            <div id="ali-section">
                <div class="driver-section-title"> <img src="https://i.postimg.cc/tCNbgXK3/Screenshot-20250623-200744-Tik-Tok.jpg" class="driver-avatar"> <span>注</span> </div>
                <div id="ali-timeline"><div class="loader"><i class="fas fa-spinner"></i>注 转...</div></div>
            </div>
            <div id="hakmat-section">
                <div class="driver-section-title"> <img src="https://i.postimg.cc/d3S0NJJZ/Screenshot-20250623-200646-Facebook.jpg" class="driver-avatar"> <span>转</span> </div>
                <div id="hakmat-timeline"><div class="loader"><i class="fas fa-spinner"></i>注 转...</div></div>
            </div>
        </div>
        
        <div id="customersPage" class="page content-padding">
             <input type="search" id="customer-search" class="search-bar" placeholder=" 驻砖 拽...">
            <div id="customer-list"></div>
        </div>

        <div id="adminPage" class="page content-padding">
            <!-- Form HTML from previous versions -->
        </div>
    </main>
    
    <div id="customerHistoryModal" class="modal">
        <!-- Modal HTML from previous versions -->
    </div>

    <nav class="bottom-nav">
        <button class="nav-button active" data-page="dashboardPage"> <i class="fas fa-clipboard-list"></i> <span>砖专</span> </button>
        <button class="nav-button" data-page="customersPage"> <i class="fas fa-users"></i> <span>拽转</span> </button>
        <button class="nav-button special" data-page="adminPage"> <i class="fas fa-plus"></i> </button>
    </nav>
    
    <div id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxt-Htl504dhDTN1cFZqw1foyKucz74Mz0v2Hy8tV85X0dtGUzLmnJ_spCFerv4O7wc/exec';

            // --- PWA SETUP ---
            function initializePWA() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js')
                     .then(() => console.log('Service Worker Registered'))
                     .catch(e => console.error('SW Registration Failed:', e));
                }
            }

            // --- DATA FETCHING ---
            async function loadAllData() {
                 try {
                    const response = await fetch(`${SCRIPT_URL}?action=getAllData`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    if(data.error) throw new Error(data.details);
                    
                    const aliTimeline = document.getElementById('ali-timeline');
                    const hakmatTimeline = document.getElementById('hakmat-timeline');
                    aliTimeline.innerHTML = ''; 
                    hakmatTimeline.innerHTML = '';
                    
                    data.aliData.forEach(order => aliTimeline.appendChild(createOrderCard(order)));
                    data.hakmatData.forEach(order => hakmatTimeline.appendChild(createOrderCard(order)));

                } catch (error) {
                    console.error('Error fetching data from script:', error);
                    document.getElementById('ali-timeline').innerHTML = '<p style="color:red;"> 转  注 转.  砖驻专住转 转 住拽专驻 砖.</p>';
                    document.getElementById('hakmat-timeline').innerHTML = '';
                }
            }

            function createOrderCard(order) {
                const card = document.createElement('div');
                card.className = 'order-card';
                // This is a simplified version, you can add all the details like before
                card.innerHTML = `<div class="card-header"><span class="customer-name">${order.customer}</span><span class="order-time">${order.time}</span></div>`;
                return card;
            }
            
            // --- Other JS functions from previous version ---

            function init() {
                initializePWA();
                loadAllData();
                setInterval(loadAllData, 60000); // Refresh every minute
            }

            init();
        });
    </script>
</body>
</html>

