<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专 拽专 住 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f2f5; }
        .card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #pano { width: 100%; height: 250px; border-radius: 8px; background-color: #e5e7eb; margin-top: 1rem; }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 max-w-7xl">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900"> 拽专 住</h1>
        </header>
        <div id="error-banner" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert"></div>
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <main class="lg:col-span-4 card p-6 space-y-4">
                <h2 class="text-xl font-semibold">驻专 </h2>
                <!-- Removed <form> tag -->
                <div>
                    <label for="customer" class="text-sm font-medium text-gray-600">拽</label>
                    <input type="text" id="customer" name="customer" list="customers-list" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <datalist id="customers-list"></datalist>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="date" class="text-sm font-medium text-gray-600">转专</label>
                        <input type="date" id="date" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="time" class="text-sm font-medium text-gray-600">砖注</label>
                        <input type="time" id="time" name="time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                </div>
                <div>
                    <label for="city" class="text-sm font-medium text-gray-600">注专</label>
                    <select id="city" name="city" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option>注 注专...</option></select>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label for="street" class="text-sm font-medium text-gray-600">专</label>
                        <input type="text" id="street" name="street" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="street_number" class="text-sm font-medium text-gray-600">住驻专</label>
                        <input type="text" id="street_number" name="street_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="delivery_type" class="text-sm font-medium text-gray-600">住 </label>
                        <select id="delivery_type" name="delivery_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" disabled><option>注...</option></select>
                    </div>
                    <div>
                        <label for="warehouse" class="text-sm font-medium text-gray-600">住 爪</label>
                        <select id="warehouse" name="warehouse" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" disabled><option>注...</option></select>
                    </div>
                </div>
                <div>
                    <label for="notes" class="text-sm font-medium text-gray-600">注专转</label>
                    <textarea id="notes" name="notes" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                </div>
                <button id="btn-save-order" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> 砖专 
                    <div id="save-spinner" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
                </button>
            </main>
            <section class="lg:col-span-8 card p-4">
                <div id="map" class="w-full h-[400px] rounded-lg"></div>
                <div id="pano"></div>
            </section>
        </div>
         <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
            <div id="routes-info-container" class="card p-6 hidden">
                <h2 class="text-xl font-semibold mb-3">住 爪</h2>
                <div id="routes-info" class="space-y-3"></div>
            </div>
            <div id="live-alerts-container" class="card p-6 hidden">
                <h2 class="text-xl font-semibold mb-3">转专转  转</h2>
                <div id="live-alerts" class="space-y-2 text-sm"></div>
            </div>
            <div id="optimization-container" class="card p-6 hidden">
                <h2 class="text-xl font-semibold mb-3">爪注转 注</h2>
                <div id="optimization-suggestions" class="space-y-2 text-sm"></div>
            </div>
        </div>
    </div>
    
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbVYMijMs8zH6m4iiSiBfn_RiCMuau9ps&callback=onGoogleMapsApiLoad&libraries=places"></script>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzwqwrsN-H6_3JzK3i_cZhEdhqrfTzB4qRj9Fa9XtOp8u9qTjeek1U21fpaG3VS5axk/exec'; //  PASTE YOUR DEPLOYED SCRIPT URL HERE
        
        let map, directionsService, directionsRenderer, panorama;
        let selectedRouteData = null;
        let debounceTimer;

        window.onGoogleMapsApiLoad = function() {
            const elements = {
                customer: document.getElementById('customer'), customersList: document.getElementById('customers-list'),
                deliveryType: document.getElementById('delivery_type'), warehouse: document.getElementById('warehouse'),
                street: document.getElementById('street'), street_number: document.getElementById('street_number'),
                city: document.getElementById('city'), date: document.getElementById('date'), time: document.getElementById('time'),
                notes: document.getElementById('notes'), btnSaveOrder: document.getElementById('btn-save-order'),
                saveSpinner: document.getElementById('save-spinner'), routesInfo: document.getElementById('routes-info'),
                routesInfoContainer: document.getElementById('routes-info-container'), liveAlerts: document.getElementById('live-alerts'),
                liveAlertsContainer: document.getElementById('live-alerts-container'), optimizationSuggestions: document.getElementById('optimization-suggestions'),
                optimizationContainer: document.getElementById('optimization-container'), errorBanner: document.getElementById('error-banner'),
            };

            function initializeMap() {
                const centerOfIsrael = { lat: 31.7, lng: 35.2 };
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 8, center: centerOfIsrael, streetViewControl: false, mapTypeControl: false
                });
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers: true, polylineOptions: { strokeColor: '#1d4ed8', strokeWeight: 6 } });
                panorama = new google.maps.StreetViewPanorama(document.getElementById("pano"));
            }

            async function loadInitialData() {
                try {
                    const [warehouses, deliveryTypes, customers, cities] = await Promise.all([
                        fetchData('getSettings'), fetchData('getDeliveryTypes'),
                        fetchData('getCustomers'), fetchData('getCities')
                    ]);
                    populateSelect(elements.warehouse, warehouses.filter(w => w.key.startsWith('warehouse_')).map(w => w.value), "专 住...");
                    populateSelect(elements.deliveryType, deliveryTypes, "专 住 ...");
                    populateSelect(elements.city, cities.sort(), "专 注专...");
                    populateDatalist(elements.customersList, customers.map(c => c.name));
                } catch (error) { showError(`砖 注转 转: ${error.message}`); }
            }
            
            async function fetchData(action) {
                if (!SCRIPT_URL) throw new Error("转转 -URL 砖 住拽专驻  专转.");
                const response = await fetch(`${SCRIPT_URL}?action=${action}`);
                if (!response.ok) throw new Error(`砖转 专砖转: ${response.status}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(`砖转 砖专转 (${action}): ${result.message}`);
                return result.data;
            }

            function populateSelect(selectEl, options, placeholder) {
                selectEl.innerHTML = `<option value="">${placeholder}</option>`;
                options.forEach(opt => selectEl.add(new Option(opt, opt)));
                selectEl.disabled = false;
            }

            function populateDatalist(datalistEl, options) {
                datalistEl.innerHTML = '';
                options.forEach(opt => datalistEl.appendChild(new Option(undefined, opt)));
            }

            function handleAddressChange() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(calculateAndDisplayRoutes, 800);
            }
            
            async function calculateAndDisplayRoutes() {
                selectedRouteData = null;
                const originAddress = elements.warehouse.value;
                const destinationAddress = `${elements.street.value} ${elements.street_number.value}, ${elements.city.value}`;
                if (!originAddress || !elements.street.value || !elements.city.value) return;

                directionsService.route({
                    origin: originAddress, destination: destinationAddress,
                    travelMode: google.maps.TravelMode.DRIVING, provideRouteAlternatives: true
                }, (result, status) => {
                    if (status === 'OK') {
                        showError(null);
                        directionsRenderer.setDirections(result);
                        const leg = result.routes[0].legs[0];
                        panorama.setPosition(leg.end_location);
                        map.setCenter(leg.end_location); map.setZoom(14);
                        displayRoutesInfo(result.routes);
                        displayLiveAlerts(result.routes[0]);
                        displayOptimizations();
                    } else { showError(`砖 砖 住: ${status}.`); }
                });
            }
            
            function displayRoutesInfo(routes) {
                elements.routesInfo.innerHTML = '';
                routes.slice(0, 2).forEach((route, index) => {
                    const leg = route.legs[0];
                    const card = document.createElement('div');
                    card.className = `route-option border p-3 rounded-lg cursor-pointer ${index === 0 ? 'selected border-blue-700' : 'border-gray-300'}`;
                    card.innerHTML = `<div class="font-bold flex justify-between"><span>住 ${index + 1}</span><span>${leg.duration.text}</span></div><div class="text-sm text-gray-600">${leg.distance.text} - ${route.summary}</div>`;
                    card.addEventListener('click', () => {
                        directionsRenderer.setRouteIndex(index);
                        selectedRouteData = { distance_km: leg.distance.text, duration_min: leg.duration.text };
                        document.querySelectorAll('.route-option').forEach(el => el.classList.remove('selected', 'border-blue-700'));
                        card.classList.add('selected', 'border-blue-700');
                    });
                    elements.routesInfo.appendChild(card);
                });
                elements.routesInfoContainer.classList.remove('hidden', 'fade-in');
                void elements.routesInfoContainer.offsetWidth;
                elements.routesInfoContainer.classList.add('fade-in');
                selectedRouteData = { distance_km: routes[0].legs[0].distance.text, duration_min: routes[0].legs[0].duration.text };
            }

            function displayLiveAlerts(route) {
                elements.liveAlerts.innerHTML = '';
                let hasAlerts = false;
                if (route.warnings.length > 0) {
                    route.warnings.forEach(warning => {
                        elements.liveAlerts.innerHTML += `<div class="flex items-start gap-2 p-2 bg-yellow-50 rounded-md"><i class="fa-solid fa-triangle-exclamation text-yellow-500 mt-1"></i><p>${warning}</p></div>`;
                        hasAlerts = true;
                    });
                }
                elements.liveAlertsContainer.classList.toggle('hidden', !hasAlerts);
                if(hasAlerts) {
                    void elements.liveAlertsContainer.offsetWidth;
                    elements.liveAlertsContainer.classList.add('fade-in');
                }
            }

            function displayOptimizations() {
                elements.optimizationSuggestions.innerHTML = '';
                let hasSuggestion = false;
                const currentHour = new Date().getHours();
                if ((currentHour >= 7 && currentHour <= 9) || (currentHour >= 16 && currentHour <= 18)) {
                    elements.optimizationSuggestions.innerHTML += `<div class="flex items-start gap-2 p-2 bg-orange-50 rounded-md"><i class="fa-solid fa-clock text-orange-500 mt-1"></i><p>住注 砖注转 注住. 砖拽 爪 抓 砖注转 07-09  16-18 住 .</p></div>`;
                    hasSuggestion = true;
                }
                elements.optimizationContainer.classList.toggle('hidden', !hasSuggestion);
                if(hasSuggestion) {
                    void elements.optimizationContainer.offsetWidth;
                    elements.optimizationContainer.classList.add('fade-in');
                }
            }
            
            async function saveOrder() {
                const required = [elements.customer, elements.street, elements.city, elements.deliveryType, elements.warehouse, elements.date];
                const isValid = required.every(el => el.value ? (el.classList.remove('border-red-500'), true) : (el.classList.add('border-red-500'), false));
                if (!isValid) return showError("  砖转 .");
                if (!selectedRouteData) return showError("砖 砖 住 驻 砖专.");
                
                elements.saveSpinner.classList.remove('hidden');
                elements.btnSaveOrder.disabled = true;

                try {
                    // FIX: Collect data directly from elements
                    const payload = {
                        customer: elements.customer.value,
                        date: elements.date.value,
                        time: elements.time.value,
                        city: elements.city.value,
                        street: elements.street.value,
                        street_number: elements.street_number.value,
                        delivery_type: elements.deliveryType.value,
                        warehouse: elements.warehouse.value,
                        notes: elements.notes.value,
                        ...selectedRouteData
                    };
                    
                    const result = await fetch(SCRIPT_URL, {
                        method: 'POST', 
                        // Apps Script requires the body to be a string, not FormData
                        body: JSON.stringify({ action: 'addOrder', payload })
                    }).then(res => res.json());

                    if (result.status !== 'success') throw new Error(result.message);
                    alert(' 砖专 爪!');
                    // Reset form fields after saving
                    [elements.customer, elements.date, elements.time, elements.street, elements.street_number, elements.notes].forEach(el => el.value = '');
                    directionsRenderer.setDirections({routes: []}); // Clear route from map
                } catch (error) { showError(`砖 砖专转 : ${error.message}`); } 
                finally {
                    elements.saveSpinner.classList.add('hidden');
                    elements.btnSaveOrder.disabled = false;
                }
            }

            function showError(message) {
                elements.errorBanner.textContent = message;
                elements.errorBanner.classList.toggle('hidden', !message);
            }

            ['street', 'street_number', 'city', 'warehouse'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', handleAddressChange);
            });
            elements.btnSaveOrder.addEventListener('click', saveOrder);

            initializeMap();
            loadInitialData();
        };
    </script>
</body>
</html>
