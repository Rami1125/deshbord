<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ניהול הזמנות CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- LeafletJS for Interactive Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        :root {
            --primary-color: #87CEEB; --secondary-color: #4587de; --dark-color: #2C3E50;
            --light-color: #F8F8F8; --accent-color: #E74C3C; --text-color: #333;
            --success-color: #2ecc71; --warning-color: #f39c12; --bg-color: #f4f7fa;
            --sidebar-bg: #ffffff; --sidebar-width: 260px;
        }
        body {
            font-family: 'Rubik', sans-serif; background-color: var(--bg-color); margin: 0;
            color: var(--text-color); display: flex;
        }
        .crm-container { display: flex; width: 100%; height: 100vh; }

        /* --- Sidebar Navigation --- */
        .sidebar {
            width: var(--sidebar-width); background-color: var(--sidebar-bg);
            box-shadow: 4px 0 20px rgba(0,0,0,0.05); display: flex; flex-direction: column;
            padding: 20px 0; z-index: 100;
        }
        .sidebar-header { text-align: center; padding: 0 20px 20px 20px; border-bottom: 1px solid #eee; }
        .sidebar-header h1 { font-size: 1.8rem; color: var(--dark-color); margin: 0; }
        .sidebar nav { flex-grow: 1; margin-top: 20px; }
        .sidebar nav a {
            display: flex; align-items: center; padding: 15px 25px; color: #555;
            text-decoration: none; font-size: 1.1rem; font-weight: 500;
            transition: all 0.3s; border-right: 4px solid transparent;
        }
        .sidebar nav a:hover { background-color: #f8f9fa; color: var(--secondary-color); }
        .sidebar nav a.active {
            background-color: #eef5ff; color: var(--secondary-color);
            border-right-color: var(--secondary-color);
        }
        .sidebar nav a i { margin-left: 15px; width: 20px; }
        
        /* --- Main Content Area --- */
        .main-content {
            flex-grow: 1; padding: 30px; overflow-y: auto;
        }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 15px; margin-top: 0; }

        /* --- Orders Table View --- */
        .table-toolbar { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .search-box input { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 250px; }
        .orders-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .orders-table th { text-align: right; padding: 12px; color: #777; font-weight: 500; }
        .orders-table td { background: #fff; padding: 15px; vertical-align: middle; }
        .orders-table tr:not(:first-child) { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .orders-table td:first-child { border-radius: 0 8px 8px 0; }
        .orders-table td:last-child { border-radius: 8px 0 0 8px; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-weight: 500; font-size: 0.8rem; }
        .status-חדשה { background-color: #e0f7fa; color: #00796b; }
        .status-בטיפול { background-color: #fff9c4; color: #f57f17; }
        .status-הושלם { background-color: #e8f5e9; color: #388e3c; }
        .action-buttons button { background: none; border: none; cursor: pointer; color: #888; font-size: 1.1rem; padding: 5px; }
        .action-buttons button:hover { color: var(--secondary-color); }

        /* --- Order Form View --- */
        .form-container { display: grid; grid-template-columns: 1fr 300px; gap: 30px; }
        .progress-bar-container { background: #eee; border-radius: 20px; overflow: hidden; margin-bottom: 20px; }
        .progress-bar {
            height: 10px; width: 0%; background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            transition: width 0.5s;
        }
        .form-group label { font-weight: 500; color: #555; display: block; margin-bottom: 8px; }
        input, select {
            width: 100%; padding: 12px; font-size: 1rem; border: 1px solid #ddd;
            border-radius: 8px; box-sizing: border-box; background: #fafafa;
        }
        #map-container { height: 200px; border-radius: 12px; background: #eee; margin-bottom: 15px; }
        .insights-card { background: #eef5ff; padding: 15px; border-radius: 12px; }
        .insight { display: flex; align-items: center; margin-bottom: 10px; }
        .insight i { color: var(--secondary-color); font-size: 1.2rem; margin-left: 10px; }
        
        /* --- Notifications View --- */
        .notification-templates { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .notification-card {
            background: white; border-radius: 12px; padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.07);
        }
        .notification-card h3 { margin-top: 0; }
        .notification-card p { font-size: 0.9rem; color: #666; }
        .notification-card button { width: 100%; padding: 12px; font-size: 1rem; }
    </style>
</head>
<body>
    <div class="crm-container">
        <aside class="sidebar">
            <div class="sidebar-header"><h1>CRM ניהול</h1></div>
            <nav>
                <a href="#" class="nav-link active" data-view="dashboard-view"><i class="fas fa-tachometer-alt"></i> לוח מחוונים</a>
                <a href="#" class="nav-link" data-view="order-form-view"><i class="fas fa-plus-circle"></i> הזמנה חדשה</a>
                <a href="#" class="nav-link" data-view="notifications-view"><i class="fas fa-bell"></i> מרכז התראות</a>
            </nav>
        </aside>

        <main class="main-content">
            <!-- Dashboard / Orders Table View -->
            <section id="dashboard-view" class="view active">
                <h2><i class="fas fa-list-ul"></i> הזמנות פעילות</h2>
                <div class="table-toolbar">
                    <div class="search-box"><input type="text" id="searchInput" placeholder="חיפוש לפי לקוח או כתובת..."></div>
                    <button id="addNewOrderBtn">הוסף הזמנה חדשה</button>
                </div>
                <div style="overflow-x:auto;">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>לקוח</th><th>כתובת</th><th>נהג</th><th>שעה</th><th>סטטוס</th><th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                            <!-- Rows will be injected by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Create/Edit Order Form View -->
            <section id="order-form-view" class="view">
                <h2 id="form-title"><i class="fas fa-edit"></i> יצירת הזמנה חדשה</h2>
                <div class="progress-bar-container"><div class="progress-bar"></div></div>
                <div class="form-container">
                    <div class="form-fields">
                         <form id="createOrderForm">
                            <input type="hidden" id="orderId">
                            <div class="form-group"><label for="orderCustomer">לקוח</label><input list="customers-list" id="orderCustomer" required><datalist id="customers-list"></datalist></div>
                            <div class="form-group"><label for="orderAddress">כתובת אספקה</label><input type="text" id="orderAddress" required></div>
                            <div class="form-group"><label for="orderCity">עיר</label><select id="orderCity" required><option value="">בחר עיר...</option></select></div>
                            <div class="form-group"><label for="orderDriver">נהג</label><select id="orderDriver" required><option value="חכמת">חכמת</option><option value="עלי">עלי</option></select></div>
                            <div class="form-group"><label for="orderDate">תאריך</label><input type="date" id="orderDate" required></div>
                            <div class="form-group"><label for="orderTime">שעה</label><input type="time" id="orderTime" required></div>
                            <button type="submit" id="submitOrderBtn">שמור הזמנה</button>
                         </form>
                    </div>
                    <div class="form-sidebar">
                        <h3><i class="fas fa-map-marked-alt"></i> מפה ותובנות</h3>
                        <div id="map-container"></div>
                        <div class="insights-card">
                            <div id="insights-content">
                                <p>בחר עיר לקבלת תובנות</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Notifications View -->
            <section id="notifications-view" class="view">
                <h2><i class="fas fa-paper-plane"></i> שליחת התראות מהירות</h2>
                <div class="notification-templates">
                    <div class="notification-card">
                        <h3>עיכוב צפוי</h3>
                        <p>שליחת התראה כללית על עיכובים אפשריים באספקות עקב עומסי תנועה.</p>
                        <button class="send-notification-btn" data-template="delay_traffic">שלח התראה</button>
                    </div>
                    <div class="notification-card">
                        <h3>מבצע!</h3>
                        <p>עדכון כללי על מבצע חדש או הודעה שיווקית חשובה אחרת ללקוחות.</p>
                        <button class="send-notification-btn" data-template="promo_special">שלח התראה</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzUeFaV_N2a1G5U-cz5VRepqXuLXWlWy8QqsMkrCjX-czOCzokv9cUzkretMo-YY5JJ/exec'; // Must be correct
    let allOrders = [], customersData = [], citiesData = [];
    let map;

    // --- VIEW MANAGEMENT ---
    const views = document.querySelectorAll('.view');
    const navLinks = document.querySelectorAll('.nav-link');

    function showView(viewId) {
        views.forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        navLinks.forEach(l => l.classList.toggle('active', l.dataset.view === viewId));
    }

    navLinks.forEach(link => link.addEventListener('click', (e) => {
        e.preventDefault();
        showView(e.currentTarget.dataset.view);
    }));
    document.getElementById('addNewOrderBtn').addEventListener('click', () => {
        resetForm();
        showView('order-form-view');
    });

    // --- INITIALIZATION ---
    async function initializeApp() {
        try {
            [allOrders, customersData, citiesData] = await Promise.all([
                fetchFromBackend('getActiveOrders'),
                fetchFromBackend('getCustomers'),
                fetchFromBackend('getCities')
            ]);
            
            renderOrdersTable();
            populateFormDatalists();
            initializeMap();
        } catch (error) {
            alert('שגיאה קריטית בטעינת הנתונים: ' + error.message);
        }
    }

    // --- DASHBOARD ---
    function renderOrdersTable() {
        const tbody = document.getElementById('orders-tbody');
        const filter = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = '';
        allOrders
            .filter(o => o.customer.toLowerCase().includes(filter) || o.address.toLowerCase().includes(filter))
            .forEach(order => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${order.customer}</strong><br><small>${order.id.substring(0,8)}</small></td>
                    <td>${order.address}</td>
                    <td>${order.driverName}</td>
                    <td>${order.time}</td>
                    <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                    <td class="action-buttons">
                        <button onclick="editOrder('${order.id}')" title="עריכה"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="duplicateOrder('${order.id}')" title="שכפול"><i class="fas fa-copy"></i></button>
                        <button onclick="archiveOrder('${order.id}')" title="סגירה/ארכוב"><i class="fas fa-archive"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
    }
    document.getElementById('searchInput').addEventListener('input', renderOrdersTable);

    // --- MAP & FORM LOGIC ---
    function initializeMap() {
        map = L.map('map-container').setView([32.293, 34.855], 13); // Hod HaSharon Coords
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
    }

    function populateFormDatalists() {
        const customerDatalist = document.getElementById('customers-list');
        customersData.forEach(c => customerDatalist.innerHTML += `<option value="${c.name}"></option>`);

        const citySelect = document.getElementById('orderCity');
        citiesData.forEach(c => citySelect.innerHTML += `<option value="${c.name}">${c.name}</option>`);
    }
    
    document.getElementById('orderCity').addEventListener('change', async (e) => {
        const cityName = e.target.value;
        const insightsContent = document.getElementById('insights-content');
        if (!cityName) {
            insightsContent.innerHTML = '<p>בחר עיר לקבלת תובנות</p>';
            return;
        }
        insightsContent.innerHTML = '<p>טוען מידע על תנועה...</p>';
        try {
            const trafficInfo = await fetchFromBackend('getTrafficInfo', { destination: cityName });
            insightsContent.innerHTML = `
                <div class="insight"><i class="fas fa-road"></i> <span><strong>מרחק:</strong> ${trafficInfo.distance}</span></div>
                <div class="insight"><i class="fas fa-car"></i> <span><strong>זמן נסיעה נוכחי:</strong> ${trafficInfo.duration_in_traffic}</span></div>
                <div class="insight"><i class="far fa-clock"></i> <span><strong>זמן ללא תנועה:</strong> ${trafficInfo.duration}</span></div>
                <p style="font-size:0.8em; margin-top:10px;">מומלץ להוסיף <strong>${trafficInfo.delay_minutes} דקות</strong> לנסיעה.</p>
            `;
            // Update map
            if(trafficInfo.destination_coords) {
                map.setView([trafficInfo.destination_coords.lat, trafficInfo.destination_coords.lng], 14);
                L.marker([trafficInfo.destination_coords.lat, trafficInfo.destination_coords.lng]).addTo(map);
            }

        } catch (error) {
            insightsContent.innerHTML = '<p style="color:red;">שגיאה בקבלת מידע על תנועה.</p>';
        }
    });

    function resetForm() {
        document.getElementById('createOrderForm').reset();
        document.getElementById('orderId').value = '';
        document.getElementById('form-title').innerHTML = '<i class="fas fa-plus-circle"></i> יצירת הזמנה חדשה';
    }

    // --- FORM SUBMISSION ---
    document.getElementById('createOrderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitOrderBtn');
        btn.disabled = true; btn.textContent = 'שומר...';
        
        const orderData = {
            id: document.getElementById('orderId').value, // Will be empty for new orders
            customer: document.getElementById('orderCustomer').value,
            address: document.getElementById('orderAddress').value,
            driverName: document.getElementById('orderDriver').value,
            date: document.getElementById('orderDate').value,
            time: document.getElementById('orderTime').value,
            // Add other fields: warehouse, operationType etc.
        };

        try {
            const result = await postToBackend('saveOrder', orderData);
            allOrders = result.updatedOrders; // Backend returns the full updated list
            renderOrdersTable();
            showView('dashboard-view');
        } catch (error) {
            alert('שגיאה בשמירת ההזמנה: ' + error.message);
        } finally {
            btn.disabled = false; btn.textContent = 'שמור הזמנה';
        }
    });
    
    // --- NOTIFICATIONS ---
    document.querySelectorAll('.send-notification-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const template = e.currentTarget.dataset.template;
            if(confirm(`האם אתה בטוח שברצונך לשלוח את התראת "${template}" לכל המשתמשים?`)){
                try {
                    await postToBackend('sendBroadcastNotification', { template });
                    alert('ההתראה נשלחה בהצלחה!');
                } catch(error) {
                    alert('שגיאה בשליחת ההתראה: ' + error.message);
                }
            }
        });
    });

    // --- API & GLOBAL FUNCTIONS ---
    window.editOrder = (orderId) => {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) return;
        resetForm();
        // Populate form
        document.getElementById('orderId').value = order.id;
        document.getElementById('orderCustomer').value = order.customer;
        document.getElementById('orderAddress').value = order.address;
        document.getElementById('orderDriver').value = order.driverName;
        document.getElementById('orderDate').value = order.date;
        document.getElementById('orderTime').value = order.time;
        // ... populate other fields
        document.getElementById('form-title').innerHTML = '<i class="fas fa-edit"></i> עריכת הזמנה';
        showView('order-form-view');
    };
    
    async function fetchFromBackend(action, params = {}) {
        const url = new URL(BACKEND_URL);
        url.searchParams.append('action', action);
        for(const key in params) { url.searchParams.append(key, params[key]); }
        
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Network error`);
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        return result.data;
    }
    
    async function postToBackend(action, data) {
        const response = await fetch(BACKEND_URL, {
            method: 'POST',
            mode: 'no-cors', // Important for simple triggers in Apps Script
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ action, data })
        });
        // Since it's no-cors, we can't read the response, but we can assume success if no network error
        return {status: 'success'};
    }

    initializeApp();
});
</script>

</body>
</html>

