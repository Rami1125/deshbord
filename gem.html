<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注专转  转 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f2f5; }
        .card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(20px); }
        .insight-card { transition: all 0.3s ease; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 max-w-7xl">
        <header class="mb-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900"> 拽专 住</h1>
            <div id="live-indicator" class="flex items-center gap-2 text-green-600 font-semibold">
                <span class="relative flex h-3 w-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                </span>
                专
            </div>
        </header>

        <div id="error-banner" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert"></div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            
            <!-- Form -->
            <main class="lg:col-span-4 card p-6 space-y-4">
                <h2 class="text-xl font-semibold">驻专 </h2>
                <div>
                    <label for="customer" class="text-sm font-medium text-gray-600">拽</label>
                    <input type="text" id="customer" list="customers-list" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <datalist id="customers-list"></datalist>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="date" class="text-sm font-medium text-gray-600">转专</label>
                        <input type="date" id="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="time" class="text-sm font-medium text-gray-600">砖注</label>
                        <input type="time" id="time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                </div>
                <div>
                    <label for="city" class="text-sm font-medium text-gray-600">注专</label>
                    <select id="city" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><option>注 注专...</option></select>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label for="street" class="text-sm font-medium text-gray-600">专</label>
                        <input type="text" id="street" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="street_number" class="text-sm font-medium text-gray-600">住驻专</label>
                        <input type="text" id="street_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="delivery_type" class="text-sm font-medium text-gray-600">住 </label>
                        <select id="delivery_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" disabled><option>注...</option></select>
                    </div>
                    <div>
                        <label for="warehouse" class="text-sm font-medium text-gray-600">住 爪</label>
                        <select id="warehouse" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" disabled><option>注...</option></select>
                    </div>
                </div>
                <div>
                    <label for="notes" class="text-sm font-medium text-gray-600">注专转</label>
                    <textarea id="notes" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                </div>
                <button id="btn-save-order" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> 砖专 
                    <div id="save-spinner" class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin hidden"></div>
                </button>
            </main>

            <!-- Map -->
            <section class="lg:col-span-5 card">
                <div id="map" class="w-full h-[550px] rounded-lg"></div>
            </section>

            <!-- Insights -->
            <aside class="lg:col-span-3 space-y-6">
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-3">驻砖专转 住</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <label for="avoidTolls" class="font-medium">注 砖 专</label>
                            <label class="switch"><input type="checkbox" id="avoidTolls"><span class="slider"></span></label>
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="avoidHighways" class="font-medium">注 砖 专</label>
                            <label class="switch"><input type="checkbox" id="avoidHighways"><span class="slider"></span></label>
                        </div>
                    </div>
                </div>
                <div id="routes-info-container" class="card p-6 hidden">
                    <h2 class="text-xl font-semibold mb-3">住 爪</h2>
                    <div id="routes-info" class="space-y-3"></div>
                </div>
                <div id="live-alerts-container" class="card p-6 hidden">
                    <h2 class="text-xl font-semibold mb-3">转专转  转</h2>
                    <div id="live-alerts" class="space-y-2 text-sm"></div>
                </div>
                 <div id="optimization-container" class="card p-6 hidden">
                    <h2 class="text-xl font-semibold mb-3">爪注转 注</h2>
                    <div id="optimization-suggestions" class="space-y-2 text-sm"></div>
                </div>
            </aside>
        </div>
    </div>
    
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbVYMijMs8zH6m4iiSiBfn_RiCMuau9ps&callback=onGoogleMapsApiLoad&libraries=places"></script>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby2TzKp0hlY3xSDSCz_Y4rO5IEZax2yXvlffnEvkZezcoowDUeth9SU5fmmH27e6pDIfg/exec'; //  PASTE YOUR DEPLOYED SCRIPT URL HERE
        
        let map, directionsService, directionsRenderer, originMarker, destinationMarker;
        let selectedRouteData = null;
        let debounceTimer;

        window.onGoogleMapsApiLoad = function() {
            const elements = {
                customer: document.getElementById('customer'),
                customersList: document.getElementById('customers-list'),
                deliveryType: document.getElementById('delivery_type'),
                warehouse: document.getElementById('warehouse'),
                street: document.getElementById('street'),
                streetNumber: document.getElementById('street_number'),
                city: document.getElementById('city'),
                date: document.getElementById('date'),
                time: document.getElementById('time'),
                notes: document.getElementById('notes'),
                btnSaveOrder: document.getElementById('btn-save-order'),
                saveSpinner: document.getElementById('save-spinner'),
                routesInfo: document.getElementById('routes-info'),
                routesInfoContainer: document.getElementById('routes-info-container'),
                liveAlerts: document.getElementById('live-alerts'),
                liveAlertsContainer: document.getElementById('live-alerts-container'),
                optimizationSuggestions: document.getElementById('optimization-suggestions'),
                optimizationContainer: document.getElementById('optimization-container'),
                errorBanner: document.getElementById('error-banner'),
                avoidTolls: document.getElementById('avoidTolls'),
                avoidHighways: document.getElementById('avoidHighways')
            };

            function initializeMap() {
                const centerOfIsrael = { lat: 31.7, lng: 35.2 };
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 8, center: centerOfIsrael, mapTypeId: 'roadmap',
                    streetViewControl: false, mapTypeControl: false
                });
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers: true, polylineOptions: { strokeColor: '#2563eb', strokeWeight: 6 } });
            }

            async function loadInitialData() {
                try {
                    const [warehouses, deliveryTypes, customers, cities] = await Promise.all([
                        fetchData('getSettings'),
                        fetchData('getDeliveryTypes'),
                        fetchData('getCustomers'),
                        fetchData('getCities')
                    ]);
                    
                    populateSelect(elements.warehouse, warehouses.filter(w => w.key.startsWith('warehouse_')).map(w => w.value), "专 住...");
                    populateSelect(elements.deliveryType, deliveryTypes, "专 住 ...");
                    populateSelect(elements.city, cities.sort(), "专 注专...");
                    populateDatalist(elements.customersList, customers.map(c => c.name));

                } catch (error) { showError(`砖 注转 转: ${error.message}`); }
            }
            
            async function fetchData(action) {
                if (!SCRIPT_URL) throw new Error("转转 -URL 砖 住拽专驻  专转.");
                const response = await fetch(`${SCRIPT_URL}?action=${action}`);
                if (!response.ok) throw new Error(`砖转 专砖转: ${response.status}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(`砖转 砖专转 (${action}): ${result.message}`);
                return result.data;
            }

            function populateSelect(selectEl, options, placeholder) {
                selectEl.innerHTML = `<option value="">${placeholder}</option>`;
                options.forEach(opt => selectEl.add(new Option(opt, opt)));
                selectEl.disabled = false;
            }

            function populateDatalist(datalistEl, options) {
                datalistEl.innerHTML = '';
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    datalistEl.appendChild(option);
                });
            }

            function handleAddressChange() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(calculateAndDisplayRoutes, 800);
            }
            
            async function calculateAndDisplayRoutes() {
                selectedRouteData = null;
                const originAddress = elements.warehouse.value;
                const destinationAddress = `${elements.street.value} ${elements.streetNumber.value}, ${elements.city.value}`;

                if (!originAddress || !elements.street.value || !elements.city.value) {
                    return; // Don't run if address is incomplete
                }

                directionsService.route({
                    origin: originAddress,
                    destination: destinationAddress,
                    travelMode: google.maps.TravelMode.DRIVING,
                    provideRouteAlternatives: true,
                    avoidTolls: elements.avoidTolls.checked,
                    avoidHighways: elements.avoidHighways.checked
                }, (result, status) => {
                    if (status === 'OK') {
                        showError(null); // Clear errors
                        directionsRenderer.setDirections(result);
                        updateMarkers(result.routes[0].legs[0]);
                        displayRoutesInfo(result.routes);
                        displayLiveAlerts(result.routes[0]);
                        displayOptimizations(result.routes);
                    } else {
                        showError(`砖 砖 住: ${status}.  砖转转 拽转 砖-Directions API 驻注 驻专拽 .`);
                    }
                });
            }

            function updateMarkers(leg) {
                if (originMarker) originMarker.setMap(null);
                if (destinationMarker) destinationMarker.setMap(null);

                originMarker = new google.maps.Marker({
                    position: leg.start_location,
                    map: map,
                    icon: { url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" }
                });

                destinationMarker = new google.maps.Marker({
                    position: leg.end_location,
                    map: map,
                    icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" }
                });
            }
            
            function displayRoutesInfo(routes) {
                elements.routesInfo.innerHTML = '';
                routes.forEach((route, index) => {
                    const leg = route.legs[0];
                    const card = document.createElement('div');
                    card.className = `route-option border p-3 rounded-lg ${index === 0 ? 'selected border-blue-500' : 'border-gray-300'}`;
                    card.innerHTML = `<div class="font-bold">住 ${index + 1}</div><div>${leg.distance.text} | ${leg.duration.text}</div><div class="text-sm text-gray-500">${route.summary}</div>`;
                    card.addEventListener('click', () => {
                        directionsRenderer.setRouteIndex(index);
                        selectedRouteData = { distance_km: leg.distance.text, duration_min: leg.duration.text };
                        document.querySelectorAll('.route-option').forEach(el => el.classList.remove('selected', 'border-blue-500'));
                        card.classList.add('selected', 'border-blue-500');
                    });
                    elements.routesInfo.appendChild(card);
                });
                elements.routesInfoContainer.classList.remove('hidden', 'fade-in');
                void elements.routesInfoContainer.offsetWidth; // Trigger reflow
                elements.routesInfoContainer.classList.add('fade-in');
                // Auto-select first route
                const firstLeg = routes[0].legs[0];
                selectedRouteData = { distance_km: firstLeg.distance.text, duration_min: firstLeg.duration.text };
            }

            function displayLiveAlerts(route) {
                elements.liveAlerts.innerHTML = '';
                if (route.warnings.length > 0) {
                    route.warnings.forEach(warning => {
                        elements.liveAlerts.innerHTML += `<div class="flex items-start gap-2 p-2 bg-yellow-50 rounded-md"><i class="fa-solid fa-triangle-exclamation text-yellow-500 mt-1"></i><p>${warning}</p></div>`;
                    });
                    elements.liveAlertsContainer.classList.remove('hidden', 'fade-in');
                    void elements.liveAlertsContainer.offsetWidth;
                    elements.liveAlertsContainer.classList.add('fade-in');
                } else {
                    elements.liveAlertsContainer.classList.add('hidden');
                }
            }

            function displayOptimizations(routes) {
                elements.optimizationSuggestions.innerHTML = '';
                let hasSuggestion = false;
                if (routes.length > 1) {
                    const primary = routes[0].legs[0].duration.value;
                    const secondary = routes[1].legs[0].duration.value;
                    if (primary < secondary) {
                        const diff = Math.round((secondary - primary) / 60);
                        if (diff > 1) {
                            elements.optimizationSuggestions.innerHTML += `<div class="flex items-start gap-2 p-2 bg-green-50 rounded-md"><i class="fa-solid fa-lightbulb text-green-500 mt-1"></i><p>住 抓 住 -${diff} 拽转 注转 驻.</p></div>`;
                            hasSuggestion = true;
                        }
                    }
                }
                const currentHour = new Date().getHours();
                if (currentHour >= 8 && currentHour <= 10) {
                    elements.optimizationSuggestions.innerHTML += `<div class="flex items-start gap-2 p-2 bg-blue-50 rounded-md"><i class="fa-solid fa-clock text-blue-500 mt-1"></i><p>砖 , 转 住注 砖注转 注住. 转 注.</p></div>`;
                    hasSuggestion = true;
                }
                 if (!hasSuggestion) {
                    elements.optimizationContainer.classList.add('hidden');
                } else {
                    elements.optimizationContainer.classList.remove('hidden', 'fade-in');
                    void elements.optimizationContainer.offsetWidth;
                    elements.optimizationContainer.classList.add('fade-in');
                }
            }
            
            async function saveOrder() {
                const required = [elements.customer, elements.street, elements.city, elements.deliveryType, elements.warehouse, elements.date];
                const isValid = required.every(el => el.value ? (el.classList.remove('border-red-500'), true) : (el.classList.add('border-red-500'), false));
                if (!isValid) return showError("  砖转 .");
                if (!selectedRouteData) return showError("砖 砖 住 驻 砖专.");
                
                elements.saveSpinner.classList.remove('hidden');
                elements.btnSaveOrder.disabled = true;

                try {
                    const payload = {
                        customer: elements.customer.value,
                        date: elements.date.value,
                        time: elements.time.value,
                        city: elements.city.value,
                        street: elements.street.value,
                        street_number: elements.streetNumber.value,
                        delivery_type: elements.deliveryType.value,
                        warehouse: elements.warehouse.value,
                        notes: elements.notes.value,
                        ...selectedRouteData
                    };
                    const result = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'addOrder', payload })
                    }).then(res => res.json());
                    
                    if (result.status !== 'success') throw new Error(result.message);
                    alert(' 砖专 爪!');
                    // Optionally reset form
                } catch (error) { showError(`砖 砖专转 : ${error.message}`); } 
                finally {
                    elements.saveSpinner.classList.add('hidden');
                    elements.btnSaveOrder.disabled = false;
                }
            }

            function showError(message) {
                elements.errorBanner.textContent = message;
                elements.errorBanner.classList.toggle('hidden', !message);
            }

            // --- Event Listeners ---
            ['street', 'streetNumber', 'city', 'warehouse', 'avoidTolls', 'avoidHighways'].forEach(id => {
                document.getElementById(id).addEventListener('change', handleAddressChange);
            });
            elements.btnSaveOrder.addEventListener('click', saveOrder);

            initializeMap();
            loadInitialData();
        };
    </script>
</body>
</html>

