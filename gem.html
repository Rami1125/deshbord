<!doctype html>
<html lang="he">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>מנהל הזמנות מתקדם</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{--bg:#f0f2f5;--card:#ffffff;--accent:#0052cc;--accent-hover:#0041a3;--muted:#5e6c84;--success:#00875a; --danger:#de350b;--warning:#ffab00;--border-color:#dfe1e6;}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:#172b4d;direction:rtl;margin:0;font-size:14px;}
    .container{max-width:1600px;margin:20px auto;padding:0 20px;display:grid;grid-template-columns:minmax(320px,1.2fr) 2fr;gap:20px;}
    .main-col, .side-col {display:flex;flex-direction:column;gap:20px;}
    .col{background:var(--card);border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);border:1px solid var(--border-color);}
    h2{margin:0 0 16px 0;font-size:18px;border-bottom:1px solid var(--border-color);padding-bottom:12px;color:#091e42;}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px;font-weight:600;}
    input,select,textarea{width:100%;padding:8px 12px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;transition:all 0.2s;background-color:#fafbfc;}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);outline:none;background-color:white;box-shadow:0 0 0 2px rgba(0,82,204,0.2);}
    select:disabled { background-color: #f4f5f7; color: #a5adba; }
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    textarea{height:70px;resize:vertical;}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:8px 16px;border:1px solid transparent;border-radius:4px;cursor:pointer;font-weight:600;transition:all 0.2s;font-size:14px;}
    .btn-primary{background:var(--accent);color:white;}.btn-primary:hover{background:var(--accent-hover);}
    .btn-secondary{background:#f4f5f7;color:#42526e;border:1px solid #ccc;}.btn-secondary:hover{background:#e9ebf0;}
    .btn:disabled{background-color:#a5adba;cursor:not-allowed;color:#7a869a;}
    #map{height:55vh;border-radius:8px;background-color:#eee;border:1px solid var(--border-color);}
    .status-indicator{position:fixed;top:15px;left:50%;transform:translateX(-50%);background-color:rgba(9,30,66,0.9);color:white;padding:12px 24px;border-radius:8px;z-index:10000;display:none;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.2);}
    .routes-panel{margin-top:10px;}
    .route-option{border:1px solid var(--border-color);border-radius:6px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s;background-color:#fafbfc;}
    .route-option:hover{border-color:var(--accent);background-color:white;}
    .route-option.selected{border-color:var(--accent);background-color:#e7f0ff;box-shadow:0 0 0 2px var(--accent);}
    .route-option .title{font-weight:bold;font-size:15px;margin-bottom:4px;}
    .route-details{display:flex;justify-content:space-around;font-size:13px;}
    .route-details span{font-weight:600;}
    .warning{color:var(--danger);font-weight:bold;}
    .toll{color:var(--warning);font-weight:bold;}
    .insights-panel .insight{background-color:#f4f5f7;padding:10px;border-radius:4px;margin-bottom:8px;font-size:13px;border-right:3px solid var(--accent);}
  </style>
</head>
<body>

  <div id="statusIndicator" class="status-indicator"></div>

  <div class="container">
    <div class="side-col">
      <div class="col">
        <h2>הזמנה חדשה</h2>
        <div class="form-grid">
          <div><label for="customer">לקוח</label><input id="customer" type="text" list="customers-list" required></div>
          <div><label for="contactPhone">טלפון איש קשר</label><input id="contactPhone" type="tel"></div>
          <div><label for="street">רחוב</label><input id="street" type="text" required></div>
          <div><label for="streetNumber">מספר</label><input id="streetNumber" type="text" required></div>
          <div style="grid-column: span 2;"><label for="city">עיר</label><input id="city" type="text" required></div>
          <div><label for="date">תאריך</label><input id="date" type="date" required></div>
          <div><label for="time">שעה</label><input id="time" type="time" required></div>
          <div><label for="delivery_type">סוג הובלה</label><select id="delivery_type" required disabled><option>טוען נתונים...</option></select></div>
          <div><label for="warehouse">מחסן מוצא</label><select id="warehouse" required disabled><option>טוען נתונים...</option></select></div>
          <div style="grid-column: span 2;"><label for="driver">נהג</label><select id="driver" required><option value="עלי">עלי</option><option value="חכמת">חכמת</option></select></div>
          <div style="grid-column: span 2;"><label for="notes">הערות</label><textarea id="notes"></textarea></div>
        </div>
        <div style="margin-top:16px;display:flex;gap:10px;">
          <button id="btnSave" class="btn btn-primary">שמור הזמנה</button>
          <button id="btnShowRoute" class="btn btn-secondary">חשב מסלולים</button>
        </div>
      </div>
      <div class="col insights-panel">
        <h2>תובנות והתראות</h2>
        <div id="trafficFeed"></div>
      </div>
    </div>
    <div class="main-col">
      <div class="col">
        <div id="map"></div>
        <div id="routesPanel" class="routes-panel"></div>
      </div>
    </div>
  </div>

  <datalist id="customers-list"></datalist>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbVYMijMs8zH6m4iiSiBfn_RiCMuau9ps&callback=onGoogleMapsApiLoad&libraries=geometry"></script>

<script>
  // =================================================================
  // CONFIGURATION
  // =================================================================
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyrsFZEDZvN5HRWLbUrtz4pyznwG0NPNNdEqbzybkp1wavxy0vUHvs_Ip-7QfdW8vcb3Q/exec'; // <-- החלף בכתובת שקיבלת אחרי DEPLOY

  // =================================================================
  // GLOBAL VARIABLES & STATE
  // =================================================================
  let map;
  let geocoder;
  let directionsService;
  let warehouses = [];
  let routePolylines = [];
  let currentRoutes = [];
  let selectedRouteIndex = 0;
  
  const dom = {
      customer: document.getElementById('customer'),
      contactPhone: document.getElementById('contactPhone'),
      street: document.getElementById('street'),
      streetNumber: document.getElementById('streetNumber'),
      city: document.getElementById('city'),
      date: document.getElementById('date'),
      time: document.getElementById('time'),
      deliveryType: document.getElementById('delivery_type'),
      warehouse: document.getElementById('warehouse'),
      driver: document.getElementById('driver'),
      notes: document.getElementById('notes'),
      btnSave: document.getElementById('btnSave'),
      btnShowRoute: document.getElementById('btnShowRoute'),
      routesPanel: document.getElementById('routesPanel'),
      trafficFeed: document.getElementById('trafficFeed'),
  };

  // =================================================================
  // INITIALIZATION
  // =================================================================
  function onGoogleMapsApiLoad() {
    console.log("Google Maps API loaded.");
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    initializeMap();
    loadInitialData();
    loadTrafficFeed();
  }

  function initializeMap() {
    map = L.map('map').setView([32.1844, 34.9082], 10); // Default to Hod HaSharon
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
  }

  async function loadInitialData() {
    if (SCRIPT_URL === 'YOUR_APPS_SCRIPT_URL' || SCRIPT_URL === '') {
      showStatus("אנא הגדר את כתובת ה-URL של Apps Script", "error");
      return;
    }
    await Promise.all([
      loadWarehouses(),
      loadDeliveryTypes(),
      loadCustomers()
    ]);
  }

  // =================================================================
  // DATA FETCHING
  // =================================================================
  async function fetchData(action) {
    try {
      const response = await fetch(`${SCRIPT_URL}?action=${action}`);
      if (!response.ok) throw new Error(`Network response was not ok for ${action}`);
      const data = await response.json();
      if (data.status === 'error') throw new Error(data.message);
      return data;
    } catch (error) {
      console.error('Fetch Error:', error);
      showStatus(`שגיאה בטעינת נתונים: ${error.message}`, 'error');
      return null;
    }
  }

  async function loadWarehouses() {
    const settings = await fetchData('getSettings');
    if (settings && Array.isArray(settings)) {
      warehouses = settings.filter(s => s.key && s.key.startsWith('warehouse_')).map(s => ({ name: s.key, address: s.value }));
      if (warehouses.length > 0) {
        dom.warehouse.innerHTML = warehouses.map(w => `<option value="${w.address}">${w.address}</option>`).join('');
        dom.warehouse.disabled = false;
        for (const w of warehouses) {
            const coords = await geocodeAddress(w.address);
            w.coords = coords;
        }
      } else {
        dom.warehouse.innerHTML = '<option>לא נמצאו מחסנים</option>';
      }
    }
  }

  async function loadDeliveryTypes() {
    const types = await fetchData('getDeliveryTypes');
    if (types && Array.isArray(types) && types.length > 0) {
      dom.deliveryType.innerHTML = types.map(t => `<option value="${t}">${t}</option>`).join('');
      dom.deliveryType.disabled = false;
    } else {
      dom.deliveryType.innerHTML = '<option>לא נמצאו סוגים</option>';
    }
  }

  async function loadCustomers() {
    const customers = await fetchData('getCustomers');
    if (customers && Array.isArray(customers)) {
        const list = document.getElementById('customers-list');
        list.innerHTML = '';
        customers.forEach(c => {
            if (c.name) {
                const option = document.createElement('option');
                option.value = c.name;
                list.appendChild(option);
            }
        });
    }
  }
  
  // =================================================================
  // CORE LOGIC: ROUTING & MAP
  // =================================================================
  async function calculateAndDisplayRoutes() {
    if (!isFormValid(true)) return;
    
    showStatus('מחשב מסלולים...', 'loading');
    clearRoutes();

    const startWarehouse = warehouses.find(w => w.address === dom.warehouse.value);
    const destinationAddress = `${dom.street.value} ${dom.streetNumber.value}, ${dom.city.value}`;

    if (!startWarehouse || !startWarehouse.coords) {
      showStatus('לא ניתן למצוא את נקודת המוצא. ודא שהמחסנים נטענו כראוי.', 'error');
      return;
    }

    const request = {
      origin: startWarehouse.coords,
      destination: destinationAddress,
      travelMode: 'DRIVING',
      provideRouteAlternatives: true,
      drivingOptions: {
          departureTime: new Date(),
          trafficModel: 'bestguess'
      }
    };

    directionsService.route(request, (result, status) => {
      if (status === 'OK') {
        currentRoutes = result.routes;
        selectedRouteIndex = 0;
        drawRoutesOnMap();
        renderRoutesPanel();
        showStatus('המסלולים חושבו', 'success');
      } else {
        showStatus(`שגיאה בחישוב מסלול: ${status}`, 'error');
      }
    });
  }

  function drawRoutesOnMap() {
    clearRoutes();
    currentRoutes.forEach((route, index) => {
      const path = route.overview_path.map(p => [p.lat(), p.lng()]);
      const color = index === selectedRouteIndex ? '#0052cc' : '#5e6c84';
      const weight = index === selectedRouteIndex ? 6 : 4;
      const polyline = L.polyline(path, { color, weight, opacity: 0.8 }).addTo(map);
      polyline.on('click', () => {
        selectedRouteIndex = index;
        drawRoutesOnMap();
        renderRoutesPanel();
      });
      routePolylines.push(polyline);
    });
    if (routePolylines.length > 0) {
        const bounds = routePolylines.reduce((bounds, poly) => bounds.extend(poly.getBounds()), L.latLngBounds());
        map.fitBounds(bounds.pad(0.1));
    }
  }
  
  function renderRoutesPanel() {
      dom.routesPanel.innerHTML = '<h2>מסלולים אפשריים</h2>';
      currentRoutes.forEach((route, index) => {
          const leg = route.legs[0];
          const hasTolls = route.summary.toLowerCase().includes('toll');
          
          const card = document.createElement('div');
          card.className = `route-option ${index === selectedRouteIndex ? 'selected' : ''}`;
          card.onclick = () => {
              selectedRouteIndex = index;
              drawRoutesOnMap();
              renderRoutesPanel();
          };
          
          let warningsHTML = getRouteWarnings(route);

          card.innerHTML = `
              <div class="title">${route.summary || `מסלול ${index + 1}`}</div>
              <div class="route-details">
                  <div>מרחק: <span>${leg.distance.text}</span></div>
                  <div>זמן: <span>${leg.duration.text}</span></div>
                  <div>עומס: <span>${leg.duration_in_traffic ? leg.duration_in_traffic.text : 'N/A'}</span></div>
              </div>
              ${(hasTolls || warningsHTML) ? `<div style="margin-top:8px; font-size:12px;">${hasTolls ? '<span class="toll">⚠️ כולל כבישי אגרה</span>' : ''} ${warningsHTML}</div>` : ''}
          `;
          dom.routesPanel.appendChild(card);
      });
  }

  function getRouteWarnings(route) {
    let warnings = [];
    if (dom.deliveryType.value.includes('מנוף') && dom.city.value.toLowerCase().includes('תל אביב')) {
        warnings.push('נדרש אישור כניסת מנוף לת"א.');
    }
    if (new Date(dom.date.value).getHours() > 7 && new Date(dom.date.value).getHours() < 10) {
        warnings.push('כניסה למרכז העיר בשעות העומס עלולה להתעכב.');
    }
    return warnings.map(w => `<div class="warning">${w}</div>`).join('');
  }

  function clearRoutes() {
    routePolylines.forEach(p => p.remove());
    routePolylines = [];
    dom.routesPanel.innerHTML = '';
  }

  // =================================================================
  // ACTIONS & EVENT LISTENERS
  // =================================================================

  async function saveOrder() {
    if (!isFormValid()) return;
    
    if (currentRoutes.length === 0) {
        showStatus("יש לחשב מסלול לפני שמירת הזמנה", "warning");
        return;
    }
    
    dom.btnSave.disabled = true;
    showStatus('שומר הזמנה...', 'loading');

    const selectedRoute = currentRoutes[selectedRouteIndex].legs[0];
    
    const orderData = {
      customer: dom.customer.value, contactPhone: dom.contactPhone.value,
      street: dom.street.value, street_number: dom.streetNumber.value, city: dom.city.value,
      date: dom.date.value, time: dom.time.value,
      delivery_type: dom.deliveryType.value, warehouse: dom.warehouse.value, driver: dom.driver.value,
      notes: dom.notes.value,
      distance_km: selectedRoute.distance.text,
      duration_min: selectedRoute.duration.text,
      status: 'חדשה'
    };

    try {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'addOrder', payload: orderData })
      });
      showStatus('הזמנה נשמרה בהצלחה!', 'success');
    } catch (error) {
      console.error('Save Error:', error);
      showStatus(`שגיאה בשמירת הזמנה: ${error.message}`, 'error');
    } finally {
        dom.btnSave.disabled = false;
    }
  }

  dom.btnSave.addEventListener('click', saveOrder);
  dom.btnShowRoute.addEventListener('click', calculateAndDisplayRoutes);

  // =================================================================
  // UTILITY & UX FUNCTIONS
  // =================================================================
  const geocodeCache = new Map();
  function geocodeAddress(address) {
    if (geocodeCache.has(address)) return Promise.resolve(geocodeCache.get(address));
    return new Promise((resolve) => {
      geocoder.geocode({ address, region: 'IL' }, (results, status) => {
        if (status === 'OK' && results[0]) {
          const loc = results[0].geometry.location;
          const coords = { lat: loc.lat(), lng: loc.lng() };
          geocodeCache.set(address, coords);
          resolve(coords);
        } else {
          console.warn(`Geocode failed: ${status}`);
          resolve(null);
        }
      });
    });
  }
  
  function isFormValid(checkAddressOnly = false) {
      const requiredFields = checkAddressOnly ? [dom.street, dom.streetNumber, dom.city] : Object.values(dom).filter(el => el.hasAttribute('required'));
      for (const field of requiredFields) {
          if (!field.value.trim() || field.disabled) {
              showStatus(`שדה חובה חסר או לא נטען: ${field.labels[0].textContent}`, 'error');
              field.focus();
              return false;
          }
      }
      return true;
  }

  function showStatus(message, type = 'info', duration = 3000) {
    const indicator = document.getElementById('statusIndicator');
    indicator.textContent = message;
    indicator.style.display = 'block';
    indicator.style.backgroundColor = `var(--${type}, rgba(9,30,66,0.9))`;
    if (type !== 'loading') {
      setTimeout(() => { indicator.style.display = 'none'; }, duration);
    }
  }
  
  function loadTrafficFeed() {
    const sampleFeed = [
      { text: 'עומס כבד ביציאה מאיילון צפון במחלף השלום.' },
      { text: 'כביש 4 חסום חלקית דרומה מצומת רעננה עקב עבודות.' },
      { text: 'הגבלת כניסת משאיות למרכז תל אביב בין 07:00-09:30.' }
    ];
    dom.trafficFeed.innerHTML = '<h3>עדכוני תנועה והגבלות</h3>';
    sampleFeed.forEach(item => {
        const div = document.createElement('div');
        div.className = 'insight';
        div.textContent = item.text;
        dom.trafficFeed.appendChild(div);
    });
  }

</script>
</body>
</html>

