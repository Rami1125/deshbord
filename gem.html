<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ×”×–×× ×•×ª</title>
    <!-- Tailwind CSS - Note: CDN is fine for Apps Script projects -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif; }
        #map { height: 400px; width: 100%; border-radius: 0.5rem; background-color: #e5e7eb; }
        .route-option { cursor: pointer; padding: 0.75rem; border-radius: 0.5rem; transition: background-color 0.2s; }
        .route-option:hover, .route-option.selected { background-color: #eef2ff; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">× ×™×”×•×œ ×”×–×× ×•×ª ××ª×§×“×</h1>
        </header>

        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="loader"></div>
        </div>

        <div id="error-banner" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">×©×’×™××”!</strong>
            <span class="block sm:inline" id="error-message"></span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Main Form Column -->
            <main class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">×™×¦×™×¨×ª ×”×–×× ×” ×—×“×©×”</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="customer" class="block text-sm font-medium text-gray-700">×œ×§×•×—</label>
                        <input type="text" id="customer" list="customers-list" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <datalist id="customers-list"></datalist>
                    </div>
                    <div>
                        <label for="contactPhone" class="block text-sm font-medium text-gray-700">×˜×œ×¤×•×Ÿ ××™×© ×§×©×¨</label>
                        <input type="tel" id="contactPhone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div class="md:col-span-2 grid grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label for="street" class="block text-sm font-medium text-gray-700">×¨×—×•×‘</label>
                            <input type="text" id="street" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="street_number" class="block text-sm font-medium text-gray-700">××¡×¤×¨</label>
                            <input type="text" id="street_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                    </div>
                    <div>
                        <label for="city" class="block text-sm font-medium text-gray-700">×¢×™×¨</label>
                        <input type="text" id="city" value="×”×•×“ ×”×©×¨×•×Ÿ" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">×ª××¨×™×š</label>
                        <input type="date" id="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="time" class="block text-sm font-medium text-gray-700">×©×¢×”</label>
                        <input type="time" id="time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="driver" class="block text-sm font-medium text-gray-700">× ×”×’</label>
                        <input type="text" id="driver" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="delivery_type" class="block text-sm font-medium text-gray-700">×¡×•×’ ×”×•×‘×œ×”</label>
                        <select id="delivery_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" disabled>
                            <option>×˜×•×¢×Ÿ × ×ª×•× ×™×...</option>
                        </select>
                    </div>
                    <div>
                        <label for="warehouse" class="block text-sm font-medium text-gray-700">××—×¡×Ÿ ××•×¦×</label>
                        <select id="warehouse" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" disabled>
                            <option>×˜×•×¢×Ÿ × ×ª×•× ×™×...</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="notes" class="block text-sm font-medium text-gray-700">×”×¢×¨×•×ª</label>
                        <textarea id="notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
                    </div>
                </div>
                 <div class="mt-6 flex justify-end gap-4">
                    <button id="btn-calculate-route" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">×—×©×‘ ××¡×œ×•×œ×™×</button>
                    <button id="btn-save-order" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">×©××•×¨ ×”×–×× ×”</button>
                </div>
            </main>

            <!-- Map and Insights Column -->
            <aside class="space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">××¤×” ×•××¡×œ×•×œ×™×</h2>
                    <div id="map"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">× ×ª×•× ×™ ××¡×œ×•×œ</h2>
                    <div id="routes-info" class="space-y-3">
                        <p class="text-gray-500">×™×© ×œ×—×©×‘ ××¡×œ×•×œ ×›×“×™ ×œ×”×¦×™×’ × ×ª×•× ×™×.</p>
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">×ª×•×‘× ×•×ª ×•×”×ª×¨××•×ª</h2>
                    <div id="insights-panel" class="space-y-2 text-sm">
                       <p class="text-gray-500">×™×•×¦×’×• ×›××Ÿ ×”×ª×¨××•×ª ×ª× ×•×¢×” ×•×”×’×‘×œ×•×ª ×¨×œ×•×•× ×˜×™×•×ª.</p>
                    </div>
                </div>
            </aside>

        </div>
    </div>
    
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCbVYMijMs8zH6m4iiSiBfn_RiCMuau9ps&callback=onGoogleMapsApiLoad&libraries=geometry"></script>

    <script>
        // === IMPORTANT: PASTE YOUR SCRIPT URL HERE ===
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxw7SbQHvIUicmsbNNXddtVYEoxsCorc6ZFn3WcuktRit4itjBtzU0_Wc5Zs_lbXCZnmQ/exec'; // ğŸ‘ˆ PASTE YOUR URL HERE
        
        // --- Global Variables ---
        let map, directionsService, directionsRenderer, geocoder;
        let warehouseData = [];
        let selectedRouteData = null;

        /**
         * This function is the entry point, called by the Google Maps script once it's loaded.
         * It's attached to the `window` object to ensure it's globally accessible.
         * THIS IS THE CRITICAL FIX for the "is not a function" error.
         */
        window.onGoogleMapsApiLoad = function() {
            console.log("Google Maps API has loaded. Initializing the application.");
            
            // --- DOM Element references ---
            const customerEl = document.getElementById('customer');
            const customersListEl = document.getElementById('customers-list');
            const deliveryTypeEl = document.getElementById('delivery_type');
            const warehouseEl = document.getElementById('warehouse');
            const streetEl = document.getElementById('street');
            const streetNumberEl = document.getElementById('street_number');
            const cityEl = document.getElementById('city');
            const btnCalcRoute = document.getElementById('btn-calculate-route');
            const btnSaveOrder = document.getElementById('btn-save-order');
            const routesInfoEl = document.getElementById('routes-info');
            const insightsPanel = document.getElementById('insights-panel');
            const loadingOverlay = document.getElementById('loading-overlay');
            const errorBanner = document.getElementById('error-banner');
            const errorMessageEl = document.getElementById('error-message');

            // --- Main Application Logic ---
            function initializeMap() {
                const centerOfIsrael = { lat: 31.7, lng: 35.2 };
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 8,
                    center: centerOfIsrael,
                    mapTypeId: 'roadmap'
                });
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
                console.log("Map component has been initialized.");
            }

            async function loadInitialData() {
                console.log("Starting to load initial data from sheets...");
                showLoading();
                try {
                    await Promise.all([
                        loadWarehouses(),
                        loadDeliveryTypes(),
                        loadCustomers()
                    ]);
                    console.log("All initial data has been loaded successfully.");
                } catch (error) {
                    console.error("A critical error occurred during initial data load:", error);
                    showError(`Failed to load application data: ${error.message}. Please check the SCRIPT_URL and your sheet names/permissions.`);
                } finally {
                    hideLoading();
                }
            }
            
            async function fetchData(action) {
                if (!SCRIPT_URL) {
                    throw new Error("SCRIPT_URL is not configured. Please paste your deployed script URL into the HTML file.");
                }
                console.log(`Fetching data for action: ${action}`);
                const response = await fetch(`${SCRIPT_URL}?action=${action}`);
                if (!response.ok) throw new Error(`Network error: Server responded with status ${response.status}`);
                
                const result = await response.json();
                if (result.status === 'error') throw new Error(`Server error (${action}): ${result.message}`);
                
                console.log(`Successfully fetched data for: ${action}`);
                return result.data;
            }

            async function loadWarehouses() {
                warehouseData = await fetchData('getSettings');
                warehouseEl.innerHTML = '<option value="">×‘×—×¨ ××—×¡×Ÿ...</option>';
                warehouseData.forEach(item => {
                    if(item.key && item.key.startsWith('warehouse_')){
                        warehouseEl.add(new Option(item.value, item.value));
                    }
                });
                warehouseEl.disabled = false;
            }
            
            async function loadDeliveryTypes() {
                const types = await fetchData('getDeliveryTypes');
                deliveryTypeEl.innerHTML = '<option value="">×‘×—×¨ ×¡×•×’ ×”×•×‘×œ×”...</option>';
                types.forEach(type => deliveryTypeEl.add(new Option(type, type)));
                deliveryTypeEl.disabled = false;
            }

            async function loadCustomers() {
                const customers = await fetchData('getCustomers');
                customersListEl.innerHTML = '';
                customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.name;
                    customersListEl.appendChild(option);
                });
            }

            function calculateAndDisplayRoutes() {
                showLoading();
                selectedRouteData = null;
                const originAddress = warehouseEl.value;
                const destinationAddress = `${streetEl.value} ${streetNumberEl.value}, ${cityEl.value}`;
                
                if (!originAddress || !streetEl.value || !cityEl.value) {
                    showError("× × ×œ××œ× ××—×¡×Ÿ ××•×¦× ×•×›×ª×•×‘×ª ×™×¢×“ ××œ××”.");
                    hideLoading();
                    return;
                }

                directionsService.route({
                    origin: originAddress,
                    destination: destinationAddress,
                    travelMode: google.maps.TravelMode.DRIVING,
                    provideRouteAlternatives: true
                }, (result, status) => {
                    hideLoading();
                    if (status === 'OK') {
                        directionsRenderer.setDirections(result);
                        displayRoutesInfo(result.routes);
                        displayInsights(result.routes);
                    } else {
                        showError(`×©×’×™××” ×‘×—×™×©×•×‘ ××¡×œ×•×œ: ${status}. ×•×“× ×©×”×›×ª×•×‘×ª ×—×•×§×™×ª.`);
                        routesInfoEl.innerHTML = '<p class="text-red-500">×œ× × ×™×ª×Ÿ ×”×™×” ×œ×—×©×‘ ××¡×œ×•×œ.</p>';
                    }
                });
            }
            
            function displayRoutesInfo(routes) {
                routesInfoEl.innerHTML = '';
                routes.forEach((route, index) => {
                    const leg = route.legs[0];
                    const card = document.createElement('div');
                    card.className = `route-option border p-3 rounded-lg ${index === 0 ? 'selected border-blue-500' : 'border-gray-300'}`;
                    card.dataset.routeIndex = index;
                    card.innerHTML = `
                        <div class="font-bold">××¡×œ×•×œ ${index + 1} ${index === 0 ? '(××•××œ×¥)' : ''}</div>
                        <div class="text-sm text-gray-600">××¨×—×§: ${leg.distance.text} | ×–××Ÿ × ×¡×™×¢×”: ${leg.duration.text}</div>
                        <div class="text-sm text-gray-500">${route.summary}</div>
                        ${route.warnings.length > 0 ? `<div class="text-xs text-yellow-600 mt-1">âš ï¸ ${route.warnings.join(', ')}</div>` : ''}
                    `;
                    card.addEventListener('click', () => selectRoute(index, routes));
                    routesInfoEl.appendChild(card);
                });
                selectRoute(0, routes);
            }
            
            function selectRoute(index, routes){
                document.querySelectorAll('.route-option').forEach(el => el.classList.remove('selected', 'border-blue-500'));
                document.querySelector(`.route-option[data-route-index="${index}"]`).classList.add('selected', 'border-blue-500');
                directionsRenderer.setRouteIndex(index);
                const leg = routes[index].legs[0];
                selectedRouteData = { distance_km: leg.distance.text, duration_min: leg.duration.text };
            }
            
            function displayInsights(routes){
                insightsPanel.innerHTML = '';
                const route = routes[0];
                let insightsFound = false;
                if (route.fare) {
                    insightsPanel.innerHTML += `<p>ğŸ›£ï¸ ×”××¡×œ×•×œ ×›×•×œ×œ ×›×‘×™×©×™ ××’×¨×” ×‘×¢×œ×•×ª ×©×œ ${route.fare.text}.</p>`;
                    insightsFound = true;
                }
                const city = cityEl.value.toLowerCase();
                if (city.includes('×ª×œ ××‘×™×‘') || city.includes('×™×¨×•×©×œ×™×')) {
                    insightsPanel.innerHTML += `<p>ğŸšš × ×“×¨×© ××™×©×•×¨ ×›× ×™×¡×ª ×× ×•×£/××©××™×ª ×œ××–×•×¨×™× ××¡×•×™××™× ×‘${cityEl.value}.</p>`;
                    insightsFound = true;
                }
                if (!insightsFound) {
                     insightsPanel.innerHTML = '<p class="text-gray-500">××™×Ÿ ×”×ª×¨××•×ª ××™×•×—×“×•×ª ×œ××¡×œ×•×œ ×–×”.</p>';
                }
            }
            
            async function saveOrder() {
                const requiredFields = [customerEl, streetEl, cityEl, deliveryTypeEl, warehouseEl, document.getElementById('date')];
                const isValid = requiredFields.every(field => {
                    if (!field.value) {
                        field.classList.add('border-red-500');
                        return false;
                    }
                    field.classList.remove('border-red-500');
                    return true;
                });

                if (!isValid) return showError("× × ×œ××œ× ××ª ×›×œ ×©×“×•×ª ×”×—×•×‘×” ×”××¡×•×× ×™× ×‘××“×•×.");
                if (!selectedRouteData) return showError("×™×© ×œ×—×©×‘ ×•×œ×‘×—×•×¨ ××¡×œ×•×œ ×œ×¤× ×™ ×©××™×¨×ª ×”×”×–×× ×”.");
                
                showLoading();
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'addOrder', payload: {
                            customer: customerEl.value,
                            contactPhone: document.getElementById('contactPhone').value,
                            street: streetEl.value,
                            street_number: streetNumberEl.value,
                            city: cityEl.value,
                            delivery_type: deliveryTypeEl.value,
                            warehouse: warehouseEl.value,
                            date: document.getElementById('date').value,
                            time: document.getElementById('time').value,
                            driver: document.getElementById('driver').value,
                            notes: document.getElementById('notes').value,
                            ...selectedRouteData
                        }})
                    });
                    const result = await response.json();
                    if (result.status !== 'success') throw new Error(result.message);
                    alert('×”×–×× ×” × ×©××¨×” ×‘×”×¦×œ×—×”!');
                } catch (error) {
                    showError(`×©×’×™××” ×‘×©××™×¨×ª ×”×–×× ×”: ${error.message}`);
                } finally {
                    hideLoading();
                }
            }

            function showLoading() { loadingOverlay.classList.remove('hidden'); }
            function hideLoading() { loadingOverlay.classList.add('hidden'); }
            function showError(message) {
                errorMessageEl.textContent = message;
                errorBanner.classList.remove('hidden');
            }

            // --- Event Listeners ---
            btnCalcRoute.addEventListener('click', calculateAndDisplayRoutes);
            btnSaveOrder.addEventListener('click', saveOrder);

            // --- Start the application ---
            initializeMap();
            loadInitialData();
        };
    </script>
</body>
</html>

