
<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ח.סבן — סידור עבודה יומי (PWA)</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0f172a">
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--accent:#06b6d4;--muted:#94a3b8;--glass: rgba(255,255,255,0.04)}
    html,body{height:100%;margin:0;font-family:'Rubik',sans-serif;background:linear-gradient(180deg,#071024 0%, #081729 100%);color:#e6eef5}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;background:transparent}
    .logo{display:flex;align-items:center;gap:10px}
    .logo img{width:44px;height:44px;border-radius:8px;background:var(--glass);padding:6px}
    h1{font-size:18px;margin:0}
    main{padding:12px}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .btn{background:linear-gradient(90deg,var(--accent),#0ea5a9);border:none;padding:8px 12px;border-radius:8px;color:#041022;font-weight:600;cursor:pointer}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.4);}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:880px){.grid{grid-template-columns:1fr 360px}}
    .orders-list{display:flex;flex-direction:column;gap:8px}
    .order{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center;gap:10px;border:1px solid rgba(255,255,255,0.03)}
    .order .meta{display:flex;flex-direction:column}
    .order .time{font-weight:700}
    .timeline{height:420px;overflow:auto;padding:6px;border-radius:10px}
    .timeline-grid{position:relative;height:100%;border-radius:8px;padding:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .slot{height:48px;border-bottom:1px dashed rgba(255,255,255,0.02);display:flex;align-items:center;padding:6px;gap:8px}
    .card-item{position:absolute;padding:8px;border-radius:8px;background:linear-gradient(90deg,#08303b,#064e57);min-width:160px;color:white;box-shadow:0 8px 20px rgba(2,6,23,0.6);cursor:grab}
    .card-item.dragging{opacity:0.85;cursor:grabbing}
    .pulse{animation:pulse 1s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,255,255,0.06)}50%{box-shadow:0 0 0 10px rgba(255,255,255,0.00)}100%{box-shadow:0 0 0 0 rgba(255,255,255,0.06)}}
    .logs{max-height:320px;overflow:auto}
    .loader{display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.12);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .status{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect rx='10' width='64' height='64' fill='%2306b6d4'/><text x='50%' y='55%' text-anchor='middle' font-size='28' fill='white' font-family='Rubik'>חס</text></svg>" alt="logo">
      <div>
        <h1>ח.סבן — סידור עבודה יומי</h1>
        <div class="status" id="last-updated">טען טרם הריצה</div>
      </div>
    </div>
    <div style="flex:1"></div>
    <button class="btn" id="btn-refresh">רענון ידני</button>
  </header>
  <main>
    <div class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px">
          <strong>הזמנות היום</strong>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="loader" style="display:none" class="loader"></div>
            <div class="status" id="status-text">—</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px">
          <div style="flex:1;min-width:220px" class="card">
            <strong>רשימה מהירה</strong>
            <div class="orders-list" id="orders-list"></div>
          </div>
          <div style="flex:2;min-width:320px" class="card">
            <strong>תכנון יומי (ציר זמן)</strong>
            <div class="timeline" id="timeline">
              <div class="timeline-grid" id="timeline-grid"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <strong>יומן שינויים (אחרונים)</strong>
        <div class="logs" id="logs"></div>
        <hr style="opacity:0.06;margin:12px 0">
        <strong>הגדרות</strong>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <label> OneSignal App ID: <input id="onesignal-id" value="acc8a2bc-d54e-4261-b3d2-cc5c5f7b39d3" style="width:100%"></label>
          <label> Apps Script URL: <input id="apps-url" placeholder="https://script.google.com/macros/s/.../exec" style="width:100%"></label>
          <button id="save-settings" class="btn">שמור הגדרות</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Configuration and state
    const cfg = {
      appsUrl: localStorage.getItem('appsUrl') || '',
      onesignalId: localStorage.getItem('onesignalId') || 'acc8a2bc-d54e-4261-b3d2-cc5c5f7b39d3',
      pollInterval: 60_000 // 1 minute
    };

    document.getElementById('onesignal-id').value = cfg.onesignalId;
    document.getElementById('apps-url').value = cfg.appsUrl;

    document.getElementById('save-settings').addEventListener('click', ()=>{
      cfg.onesignalId = document.getElementById('onesignal-id').value.trim();
      cfg.appsUrl = document.getElementById('apps-url').value.trim();
      localStorage.setItem('onesignalId', cfg.onesignalId);
      localStorage.setItem('appsUrl', cfg.appsUrl);
      alert('ההגדרות נשמרו');
      initOneSignal();
      fetchAndRender();
    })

    document.getElementById('btn-refresh').addEventListener('click', ()=> fetchAndRender());

    // Utilities
    function showLoader(show, text){
      document.getElementById('loader').style.display = show ? 'inline-block' : 'none';
      document.getElementById('status-text').textContent = text || '';
    }

    function formatTimeHM(t){
      // t expected as "HH:MM"
      return t;
    }

    // Fetching from Apps Script
    async function fetchAll(){
      if(!cfg.appsUrl) throw new Error('Apps Script URL לא מוגדר');
      const url = new URL(cfg.appsUrl);
      url.searchParams.set('action', 'getAllData');
      const res = await fetch(url.toString(), {method:'GET'});
      if(!res.ok) throw new Error('Fetch failed: '+res.status);
      return res.json();
    }

    async function fetchLogs(){
      if(!cfg.appsUrl) throw new Error('Apps Script URL לא מוגדר');
      const url = new URL(cfg.appsUrl);
      url.searchParams.set('action', 'getLogs');
      const res = await fetch(url.toString(), {method:'GET'});
      if(!res.ok) throw new Error('Fetch logs failed');
      return res.json();
    }

    async function postUpdateOrderTime(orderId, newTime){
      const res = await fetch(cfg.appsUrl, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({action:'updateOrderTime', orderId, newTime})
      });
      return res.json();
    }

    // Rendering
    let orders = [];
    function renderList(){
      const container = document.getElementById('orders-list');
      container.innerHTML = '';
      orders.forEach(o=>{
        const el = document.createElement('div'); el.className='order';
        el.innerHTML = `<div class='meta'><div>${o.נהג || '—'} • ${o.לקוח || '—'}</div><div class='time'>${o.שעה || '—'}</div></div><div style='min-width:80px;text-align:left;'>${o.מחסן||''}</div>`;
        container.appendChild(el);
      })
    }

    // Timeline implementation (06:00 - 18:00)
    const timelineGrid = document.getElementById('timeline-grid');
    function buildTimeline(){
      timelineGrid.innerHTML = '';
      const startHour = 6, endHour = 18; const slotHeight=48; // px per slot
      for(let h=startHour; h<endHour; h++){
        const slot = document.createElement('div'); slot.className='slot';
        slot.dataset.hour = h; slot.style.height = slotHeight+'px';
        slot.textContent = (h<10? '0'+h:h)+':00';
        timelineGrid.appendChild(slot);
      }
    }

    function renderTimeline(){
      buildTimeline();
      // place cards
      orders.forEach((o,idx)=>{
        if(!o.שעה) return;
        const [hh,mm] = (o.שעה||'').split(':');
        if(!hh) return;
        const startHour = 6; const slotHeight=48;
        const top = ((Number(hh)-startHour) * slotHeight) + (Number(mm||0)/60)*slotHeight;
        const card = document.createElement('div'); card.className='card-item';
        card.style.top = top + 'px';
        card.style.left = (20 + (idx%2)*180) + 'px';
        card.style.width = '220px';
        card.dataset.orderId = o.מזהה || o.id || o['מזהה ייחודי'] || '';
        card.innerHTML = `<div style='font-weight:700'>${o.לקוח||''}</div><div style='font-size:13px;margin-top:6px'>${o.כתובת||''}</div><div style='margin-top:8px;font-size:12px'>${o.שעה||''}</div>`;
        enableDrag(card);
        timelineGrid.appendChild(card);
      })
    }

    // Drag & Drop mechanics (pointer events simple)
    function enableDrag(card){
      let offsetY=0, startY=0; card.addEventListener('pointerdown', e=>{
        card.setPointerCapture(e.pointerId);
        card.classList.add('dragging');
        startY = e.clientY; offsetY = parseFloat(card.style.top || 0);
        function move(ev){
          const dy = ev.clientY - startY;
          card.style.top = (offsetY + dy) + 'px';
        }
        function up(ev){
          card.releasePointerCapture(e.pointerId);
          card.classList.remove('dragging');
          document.removeEventListener('pointermove', move);
          document.removeEventListener('pointerup', up);
          // compute new time
          const top = parseFloat(card.style.top);
          const slotHeight = 48; const startHour = 6;
          const hourFloat = top/slotHeight + startHour;
          const hh = Math.floor(hourFloat);
          const mm = Math.round((hourFloat - hh)*60/5)*5; // round to 5 min
          const newTime = String(hh).padStart(2,'0') + ':' + String(mm).padStart(2,'0');
          // send update
          postUpdateOrderTime(card.dataset.orderId, newTime)
            .then(r=>{
              if(r && r.success){
                speakReminder(`הזמנה עבור ${r.client||''} עודכנה לשעה ${newTime}`);
                fetchAndRender();
              } else {
                alert('עדכון נכשל'); fetchAndRender();
              }
            }).catch(err=>{alert('שגיאה בעדכון');fetchAndRender()});
        }
        document.addEventListener('pointermove', move);
        document.addEventListener('pointerup', up);
      })
    }

    // Polling and orchestration
    let pollTimer = null;
    async function fetchAndRender(){
      showLoader(true,'טוען...');
      try{
        const data = await fetchAll();
        orders = (data && data.orders) || [];
        renderList();
        renderTimeline();
        document.getElementById('last-updated').textContent = 'עודכן: ' + new Date().toLocaleString('he-IL');
        const logs = await fetchLogs();
        renderLogs(logs);
        checkReminders();
        showLoader(false,'עודכן');
      }catch(err){
        console.error(err);
        showLoader(false,'שגיאה בטעינה');
        document.getElementById('status-text').textContent = 'אירעה שגיאה';
      }
    }

    function renderLogs(logs){
      const el = document.getElementById('logs'); el.innerHTML='';
      (logs||[]).forEach(l=>{
        const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid rgba(255,255,255,0.03)';
        d.innerHTML = `<div style='font-size:13px;color:var(--muted)'>${l[0]||''}</div><div style='font-weight:600'>${l[2]||''}</div>`;
        el.appendChild(d);
      })
    }

    // Reminders: visual and speech
    function checkReminders(){
      const now = new Date();
      orders.forEach(o=>{
        if(!o.שעה) return;
        const [hh,mm]=o.שעה.split(':').map(Number);
        const orderDate = new Date(); orderDate.setHours(hh,mm,0,0);
        const diff = (orderDate - now)/60000; // minutes
        const cardEl = document.querySelector(`[data-order-id='${o.מזהה||o.id||o['מזהה ייחודי']}']`);
        if(cardEl){
          cardEl.classList.remove('pulse');
          if(diff<=15 && diff>=0){
            cardEl.classList.add('pulse');
            // speak
            speakReminder(`תזכורת: הזמנה עבור ${o.לקוח||''} בשעה ${o.שעה}`);
          }
        }
      })
    }

    // Speech
    function speakReminder(text){
      if(!('speechSynthesis' in window)) return;
      const ut = new SpeechSynthesisUtterance(text);
      ut.lang = 'he-IL';
      speechSynthesis.cancel(); // prevent overlap
      speechSynthesis.speak(ut);
    }

    // Initialize OneSignal (lightweight) — only loads SDK after user saved settings
    function initOneSignal(){
      const id = cfg.onesignalId;
      if(!id) return;
      // minimal integration: load OneSignal SDK script and init
      if(window.OneSignalInitialized) return;
      const s = document.createElement('script'); s.src = 'https://cdn.onesignal.com/sdks/OneSignalSDK.js'; s.async=true;
      s.onload = ()=>{
        window.OneSignal = window.OneSignal || [];
        OneSignal.push(()=>{
          OneSignal.init({appId: id, notifyButton:{enable:false}});
        });
        window.OneSignalInitialized = true;
      };
      document.head.appendChild(s);
    }

    // Boot
    (function boot(){
      try{ cfg.appsUrl = localStorage.getItem('appsUrl') || cfg.appsUrl; document.getElementById('apps-url').value = cfg.appsUrl;}catch(e){}
      initOneSignal();
      fetchAndRender();
      if(pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(fetchAndRender, cfg.pollInterval);
    })();

    // PWA: service worker register
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/sw.js').then(()=>console.log('sw registered')).catch(()=>console.log('sw fail'));
    }

    // small helper for demo: allow file drop to change appsUrl (not necessary in prod)
  </script>
</body>
</html>
