<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>ניהול הזמנות ח.סבן חומרי בניין</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl; /* Right-to-left for Hebrew */
      text-align: right;
      margin: 20px;
      background-color: #f4f4f4;
      color: #333;
    }
    h1, h2 {
      color: #0056b3;
      text-align: center;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .section {
      margin-bottom: 30px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"], input[type="number"], select, textarea {
      width: calc(100% - 22px);
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: right;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .message {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
    }
    .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 15px;
      align-items: flex-end;
    }
    .filter-group div {
      flex: 1;
      min-width: 150px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ניהול הזמנות ח.סבן חומרי בניין</h1>

    <div class="section">
      <h2>עדכון סטטוס הזמנה</h2>
      <form id="updateForm">
        <label for="orderNumber">מספר הזמנה:</label>
        <input type="number" id="orderNumber" name="orderNumber" required>

        <label for="newStatus">סטטוס חדש:</label>
        <select id="newStatus" name="newStatus" required>
          <option value="">בחר סטטוס</option>
          <option value="ממתינה להכנה">ממתינה להכנה</option>
          <option value="מוכנה">מוכנה</option>
          <option value="בדרך ללקוח">בדרך ללקוח</option>
          <option value="הזמנה מתעכבת">הזמנה מתעכבת</option>
          <option value="לא מוכנה">לא מוכנה</option>
          <option value="חסר מוצרי חנות">חסר מוצרי חנות</option>
          <option value="הזמנה נדחתה">הזמנה נדחתה</option>
          <option value="הלקוח ביטל">הלקוח ביטל</option>
          <option value="הלקוח דחה">הלקוח דחה</option>
          <option value="מתוכננת לצאת">מתוכננת לצאת</option>
          </select>

        <label for="updaterName">שם מעדכן (לדוגמה: אורן מחסנאי):</label>
        <input type="text" id="updaterName" name="updaterName" required>

        <button type="submit">עדכן סטטוס</button>
        <div id="updateMessage" class="message"></div>
      </form>
    </div>

    <div class="section">
      <h2>הזמנות פעילות</h2>
      <div class="filter-group">
        <div>
          <label for="filterStatus">סנן לפי סטטוס:</label>
          <select id="filterStatus">
            <option value="">הכל</option>
            <option value="ממתינה להכנה">ממתינה להכנה</option>
            <option value="מוכנה">מוכנה</option>
            <option value="בדרך ללקוח">בדרך ללקוח</option>
            <option value="הזמנה מתעכבת">הזמנה מתעכבת</option>
            <option value="לא מוכנה">לא מוכנה</option>
            <option value="חסר מוצרי חנות">חסר מוצרי חנות</option>
            <option value="הזמנה נדחתה">הזמנה נדחתה</option>
            <option value="הלקוח ביטל">הלקוח ביטל</option>
            <option value="הלקוח דחה">הלקוח דחה</option>
            <option value="מתוכננת לצאת">מתוכננת לצאת</option>
          </select>
        </div>
        <div>
          <label for="filterDriver">סנן לפי נהג:</label>
          <select id="filterDriver">
            <option value="">הכל</option>
            <option value="חכמת">חכמת</option>
            <option value="עלי">עלי</option>
            <option value="פאלח">פאלח</option>
            <option value="נתנאל">נתנאל</option>
            <option value="ראמיה">ראמיה</option>
            <option value="איציק">איציק</option>
            <option value="אורן">אורן</option>
            <option value="תמיר">תמיר</option>
            <option value="יואב">יואב</option>
          </select>
        </div>
        <div>
          <label for="filterWarehouse">סנן לפי מחסן:</label>
          <select id="filterWarehouse">
            <option value="">הכל</option>
            <option value="ביחד">ביחד</option>
            <option value="החרש">החרש</option>
            <option value="התלמיד">התלמיד</option>
            <option value="סופקי">סופקי</option>
          </select>
        </div>
      </div>
      <table id="ordersTable">
        <thead>
          <tr>
            <th>מס הזמנה</th>
            <th>סטטוס</th>
            <th>לקוח</th>
            <th>כתובית אספקה</th>
            <th>נהג</th>
            <th>שעת אספקה</th>
            <th>מחסן</th>
            <th>מעדכן</th>
            <th>שעת שינוי סטטוס</th>
            <th>תאריך</th>
            <th>סוג הובלה</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
    </div>

    <div class="section">
      <h2>היסטוריית הזמנות</h2>
      <p>הטבלה למעלה מציגה את כל ההזמנות. ניתן לסנן אותן כדי לראות היסטוריה.</p>
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', loadOrders);
    document.getElementById('updateForm').addEventListener('submit', handleUpdateSubmit);
    document.getElementById('filterStatus').addEventListener('change', filterOrders);
    document.getElementById('filterDriver').addEventListener('change', filterOrders);
    document.getElementById('filterWarehouse').addEventListener('change', filterOrders);

    let allOrdersData = []; // Store all fetched orders for filtering

    /**
     * טוען את נתוני ההזמנות מהגיליון ומציג אותם.
     */
    function loadOrders() {
      showLoadingMessage("טוען הזמנות...");
      google.script.run
        .withSuccessHandler(displayOrders)
        .withFailureHandler(showError)
        .getOrders();
    }

    /**
     * מציג את נתוני ההזמנות בטבלה.
     * @param {Array<Object>} orders מערך של אובייקטים המייצגים הזמנות.
     */
    function displayOrders(orders) {
      allOrdersData = orders; // Save all orders
      filterOrders(); // Apply initial filters (none) to display all
      hideLoadingMessage();
    }

    /**
     * מסנן ומציג את ההזמנות בטבלה בהתאם לבחירת המשתמש.
     */
    function filterOrders() {
      const filterStatus = document.getElementById('filterStatus').value;
      const filterDriver = document.getElementById('filterDriver').value;
      const filterWarehouse = document.getElementById('filterWarehouse').value;
      const tableBody = document.getElementById('ordersTable').getElementsByTagName('tbody')[0];
      tableBody.innerHTML = ''; // Clear existing rows

      const filteredOrders = allOrdersData.filter(order => {
        const matchesStatus = filterStatus === "" || order.סטטוס === filterStatus;
        const matchesDriver = filterDriver === "" || order.נהג === filterDriver;
        const matchesWarehouse = filterWarehouse === "" || order.מחסן === filterWarehouse;
        return matchesStatus && matchesDriver && matchesWarehouse;
      });

      if (filteredOrders.length === 0) {
        const row = tableBody.insertRow();
        const cell = row.insertCell(0);
        cell.colSpan = 11; // Number of columns in the table
        cell.textContent = "לא נמצאו הזמנות התואמות לסינון.";
        cell.style.textAlign = 'center';
        return;
      }

      filteredOrders.forEach(order => {
        const row = tableBody.insertRow();
        row.insertCell(0).textContent = order.מסהזמנה || '';
        row.insertCell(1).textContent = order.סטטוס || '';
        row.insertCell(2).textContent = order.לקוח || '';
        row.insertCell(3).textContent = order.כתוביתאספקה || '';
        row.insertCell(4).textContent = order.נהג || '';
        row.insertCell(5).textContent = order.שעתאספקה || '';
        row.insertCell(6).textContent = order.מחסן || '';
        row.insertCell(7).textContent = order.מעדכן || '';
        row.insertCell(8).textContent = order.שעתשינויסטטוס || '';
        row.insertCell(9).textContent = order.תאריך || '';
        row.insertCell(10).textContent = order.סוגהובלה || '';
      });
    }

    /**
     * מטפל בשליחת טופס עדכון הסטטוס.
     * @param {Event} event אירוע השליחה.
     */
    function handleUpdateSubmit(event) {
      event.preventDefault(); // Prevent default form submission

      const orderNumber = document.getElementById('orderNumber').value;
      const newStatus = document.getElementById('newStatus').value;
      const updaterName = document.getElementById('updaterName').value;
      const updateMessageDiv = document.getElementById('updateMessage');

      if (!orderNumber || !newStatus || !updaterName) {
        showMessage(updateMessageDiv, "אנא מלא את כל השדות.", "error");
        return;
      }

      showMessage(updateMessageDiv, "מעדכן סטטוס...", "");
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            showMessage(updateMessageDiv, response.message, "success");
            loadOrders(); // Reload orders to show updated status
            document.getElementById('updateForm').reset(); // Clear form
          } else {
            showMessage(updateMessageDiv, response.message, "error");
          }
        })
        .withFailureHandler(showError)
        .updateOrderStatus(orderNumber, newStatus, updaterName);
    }

    /**
     * מציג הודעת שגיאה.
     * @param {Error} error אובייקט השגיאה.
     */
    function showError(error) {
      const updateMessageDiv = document.getElementById('updateMessage');
      showMessage(updateMessageDiv, "שגיאה: " + error.message, "error");
      hideLoadingMessage();
    }

    /**
     * מציג הודעה למשתמש.
     * @param {HTMLElement} element אלמנט ה-HTML להצגת ההודעה.
     * @param {string} message הטקסט של ההודעה.
     * @param {string} type סוג ההודעה ('success', 'error', או ריק).
     */
    function showMessage(element, message, type) {
      element.textContent = message;
      element.className = 'message ' + type;
    }

    /**
     * מציג הודעת טעינה.
     * @param {string} message הטקסט של הודעת הטעינה.
     */
    function showLoadingMessage(message) {
      const updateMessageDiv = document.getElementById('updateMessage');
      showMessage(updateMessageDiv, message, "");
      updateMessageDiv.style.display = 'block';
    }

    /**
     * מסתיר את הודעת הטעינה.
     */
    function hideLoadingMessage() {
      const updateMessageDiv = document.getElementById('updateMessage');
      updateMessageDiv.style.display = 'none';
    }
  </script>
</body>
</html>
